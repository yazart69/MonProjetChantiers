<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Travaux & Matériaux - Gestion de Chantier</title>
    <style>
        :root {
            --sidebar-width: 280px;
            --primary-red: #dc2626; --primary-orange: #ea580c; --primary-blue: #2563eb;
            --success: #16a34a; --warning: #d97706; --danger: #dc2626; --info: #0ea5e9;
            --gray-50: #f9fafb; --gray-100: #f3f4f6; --gray-200: #e5e7eb; --gray-300: #d1d5db;
            --gray-900: #111827; --white: #ffffff;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05); --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--gray-50); color: var(--gray-900); }
        /* Sidebar unifiée avec fond noir */
        .sidebar {
            position: fixed;
            top: 0;
            left: 0;
            width: var(--sidebar-width);
            height: 100vh;
            background: #000000;
            color: white;
            z-index: 1000;
            overflow-y: auto;
            transition: transform 0.3s ease-in-out;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .sidebar-header {
            padding: 2rem 1.5rem;
            text-align: center;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .sidebar-logo {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .sidebar-subtitle {
            font-size: 0.9rem;
            opacity: 0.8;
        }

        .sidebar-nav {
            padding: 1rem 0;
        }

        .nav-section {
            margin-bottom: 2rem;
        }

        .nav-section-title {
            padding: 0 1.5rem 0.5rem;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            opacity: 0.7;
            letter-spacing: 0.05em;
        }

        .nav-item {
            display: block;
            padding: 0.75rem 1.5rem;
            color: white;
            text-decoration: none;
            transition: all 0.3s ease;
            border-left: 3px solid transparent;
            position: relative;
            font-weight: 500;
        }

        .nav-item:hover,
        .nav-item.active {
            background: rgba(255,255,255,0.1);
            border-left-color: #dc2626;
            transform: translateX(5px);
        }

        .nav-item .icon {
            display: inline-block;
            width: 1.5rem;
            margin-right: 0.75rem;
            text-align: center;
        }
        .content-with-sidebar { margin-left: var(--sidebar-width); min-height: 100vh; padding: 2rem; }
        .travaux-header { background: var(--white); border-radius: 1rem; padding: 2rem; margin-bottom: 2rem; box-shadow: var(--shadow-md); border-left: 6px solid var(--primary-red); }
        .header-content { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 2rem; }
        .page-title { font-size: 2.5rem; font-weight: 700; background: linear-gradient(135deg, var(--primary-red), var(--primary-orange)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
        .page-subtitle { font-size: 1.1rem; color: #6b7280; margin-top: 0.5rem; }
        .tabs-container { background: var(--white); border-radius: 1rem; box-shadow: var(--shadow-md); margin-bottom: 2rem; }
        .tabs-header { display: flex; border-bottom: 1px solid var(--gray-200); overflow-x: auto; }
        .tab-btn { padding: 1rem 2rem; border: none; background: transparent; font-weight: 600; cursor: pointer; transition: all 0.3s; border-radius: 1rem 1rem 0 0; color: var(--gray-900); white-space: nowrap; }
        .tab-btn.active { background: var(--primary-red); color: white; }
        .tab-content { padding: 2rem; display: none; }
        .tab-content.active { display: block; }
        
        /* Correction drastique pour l'onglet atelier */
        #tab-atelier {
            position: relative !important;
            top: auto !important;
            left: auto !important;
            right: auto !important;
            bottom: auto !important;
            transform: none !important;
            z-index: auto !important;
            display: none !important;
        }
        
        #tab-atelier.active {
            display: block !important;
        }
        
        /* Correction de l'interface interne de l'onglet atelier */
        #tab-atelier {
            background: var(--white) !important;
            border-radius: 1rem !important;
            padding: 2rem !important;
            margin-bottom: 2rem !important;
            box-shadow: var(--shadow-sm) !important;
            border: 1px solid var(--gray-200) !important;
            width: 100% !important;
            box-sizing: border-box !important;
        }
        
        #tab-atelier h3 {
            margin-bottom: 1.5rem !important;
            display: flex !important;
            align-items: center !important;
            gap: 0.5rem !important;
            color: var(--gray-900) !important;
            font-size: 1.5rem !important;
            font-weight: 700 !important;
        }
        
        #tab-atelier .form-group {
            margin-bottom: 1.5rem !important;
        }
        
        #tab-atelier .form-label {
            font-weight: 600 !important;
            margin-bottom: 0.5rem !important;
            color: var(--gray-700) !important;
        }
        
        #tab-atelier .form-input,
        #tab-atelier .form-select {
            padding: 0.75rem !important;
            border: 2px solid var(--gray-200) !important;
            border-radius: 0.5rem !important;
            font-size: 0.9rem !important;
            width: 100% !important;
            box-sizing: border-box !important;
        }
        
        #tab-atelier .radio-group {
            display: flex !important;
            gap: 1rem !important;
            margin-top: 0.5rem !important;
        }
        
        #tab-atelier .radio-group label {
            display: flex !important;
            align-items: center !important;
            gap: 0.5rem !important;
            cursor: pointer !important;
        }
        
        #tab-atelier .form-grid {
            display: grid !important;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)) !important;
            gap: 1.5rem !important;
            margin-bottom: 2rem !important;
        }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; margin-bottom: 2rem; }
        .form-group { display: flex; flex-direction: column; }
        .form-label { font-weight: 600; margin-bottom: 0.5rem; }
        .form-input, .form-select, .form-textarea { padding: 0.75rem; border: 2px solid var(--gray-200); border-radius: 0.5rem; font-size: 0.9rem; }
        .dynamic-table { width: 100%; border-collapse: collapse; margin: 1rem 0; }
        .dynamic-table th, .dynamic-table td { padding: 1rem; border-bottom: 1px solid var(--gray-100); }
        .dynamic-table th { background: var(--gray-100); }
        .calculation-summary { background: var(--gray-50); border-radius: 0.5rem; padding: 2rem; margin: 2rem 0; }
        .summary-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem; }
        .summary-item { text-align: center; background: var(--white); padding: 1.5rem; border-radius: 0.5rem; box-shadow: var(--shadow-sm); }
        .summary-value { font-size: 1.8rem; font-weight: 800; color: var(--primary-red); }
        .summary-label { font-size: 0.9rem; }
        .collapsible-header { 
            cursor: pointer; 
            padding: 1rem; 
            background-color: var(--gray-100); 
            border-radius: 0.5rem; 
            margin-top: 1rem; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            transition: all 0.3s ease;
            border: 1px solid var(--gray-200);
        }
        .collapsible-header:hover {
            background-color: var(--gray-200);
            transform: translateY(-1px);
            box-shadow: var(--shadow-sm);
        }
        .collapsible-header.active {
            background-color: var(--primary-red);
            color: white;
        }
        .collapsible-header::after {
            content: '▼';
            transition: transform 0.3s ease;
            font-size: 0.8rem;
        }
        .collapsible-header.active::after {
            transform: rotate(180deg);
        }
        .collapsible-content { 
            display: none; 
            padding-top: 1rem; 
            animation: slideDown 0.3s ease-out;
        }
        .collapsible-content.active {
            display: block;
        }
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* Styles spécifiques pour les tableaux dans les sections collapsibles */
        .collapsible-content .dynamic-table {
            width: 100%;
            border-collapse: collapse;
            margin: 1rem 0;
            background: var(--white);
            border-radius: 0.5rem;
            overflow: hidden;
            box-shadow: var(--shadow-sm);
        }
        
        .collapsible-content .dynamic-table th,
        .collapsible-content .dynamic-table td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid var(--gray-200);
        }
        
        .collapsible-content .dynamic-table th {
            background: var(--gray-100);
            font-weight: 600;
            color: var(--gray-900);
        }
        
        .collapsible-content .dynamic-table tr:hover {
            background: var(--gray-50);
        }
        
        .collapsible-content .dynamic-table input {
            width: 100%;
            border: 1px solid var(--gray-300);
            border-radius: 0.25rem;
            padding: 0.5rem;
            font-size: 0.9rem;
        }
        .btn { padding: 0.75rem 1.5rem; border: none; border-radius: 0.5rem; font-weight: 600; cursor: pointer; text-decoration: none; display: inline-flex; align-items: center; gap: 0.5rem; }
        .btn-primary { background: var(--primary-blue); color: white; }
        .btn-warning { background: var(--warning); color: white; }
        .btn-success { background: var(--success); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-small { padding: 0.5rem 1rem; font-size: 0.8rem; }
        .auto-save { position: fixed; bottom: 2rem; right: 2rem; background: var(--success); color: white; padding: 0.5rem 1rem; border-radius: 20px; font-size: 0.8rem; opacity: 0; transition: opacity 0.3s; z-index: 1001; }
        .auto-save.show { opacity: 1; }
        .prep-item { display: flex; align-items: center; gap: 1rem; margin-bottom: 0.5rem; }
        .prep-item-container { background: var(--gray-50); padding: 1rem; border-radius: 0.5rem; }
        .prep-inputs { display: flex; gap: 0.5rem; align-items: center; }
        .multi-select { display: flex; flex-wrap: wrap; gap: 1rem; }
        .checkbox-item { display: flex; align-items: center; gap: 0.5rem; cursor: pointer; }
        .checkbox-item.selected { background: var(--primary-red); color: white; padding: 0.5rem; border-radius: 0.5rem; }
        .zone-peinture { margin-bottom: 2rem; border: 1px solid var(--gray-200); border-radius: 0.5rem; padding: 1rem; }
        .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem; margin: 2rem 0; }
        .kpi-item { background: var(--white); padding: 1.5rem; border-radius: 0.5rem; box-shadow: var(--shadow-sm); text-align: center; }
        .kpi-item.kpi-cost { border-left: 4px solid var(--primary-blue); }
        .kpi-item.kpi-profit { border-left: 4px solid var(--success); }
        .kpi-label { font-size: 0.9rem; color: var(--gray-600); margin-bottom: 0.5rem; }
        .kpi-value { font-size: 1.8rem; font-weight: 800; color: var(--primary-red); }
        .financial-dashboard { display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin: 2rem 0; }
        .chart-container { background: var(--white); padding: 1.5rem; border-radius: 0.5rem; box-shadow: var(--shadow-sm); }
        .donut-chart-wrapper { display: flex; align-items: center; gap: 2rem; }
        .donut-chart { width: 150px; height: 150px; border-radius: 50%; background: conic-gradient(var(--primary-blue) 0% 50%, var(--primary-orange) 50% 100%); }
        .chart-legend ul { list-style: none; padding: 0; }
        .chart-legend li { display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem; }
        .legend-dot { width: 12px; height: 12px; border-radius: 50%; }
        .breakdown-list { margin-top: 1rem; }
        .breakdown-item { margin-bottom: 1rem; }
        .progress-bar-container { background: var(--gray-200); height: 20px; border-radius: 10px; overflow: hidden; position: relative; }
        .progress-bar { height: 100%; background: var(--primary-blue); transition: width 0.3s ease; display: flex; align-items: center; justify-content: center; color: white; font-size: 0.8rem; font-weight: 600; }
        .radio-group { display: flex; gap: 1rem; }
        .radio-group label { display: flex; align-items: center; gap: 0.5rem; cursor: pointer; }

        /* Styles pour la nouvelle section Surface */
        .zone-row {
            display: grid;
            grid-template-columns: 2fr 2fr 1.5fr 1fr 1fr 120px;
            gap: 1rem;
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--gray-100);
            align-items: center;
            background: var(--white);
            transition: all 0.3s ease;
        }

        .zone-row:hover {
            background: var(--gray-50);
            transform: translateY(-1px);
            box-shadow: var(--shadow-sm);
        }

        .zone-row:last-child {
            border-bottom: none;
        }

        .zone-input {
            width: 100%;
            border: 2px solid var(--gray-200);
            border-radius: 0.5rem;
            padding: 0.75rem;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            background: var(--white);
        }

        .zone-input:focus {
            outline: none;
            border-color: var(--primary-red);
            box-shadow: 0 0 0 3px rgba(220, 38, 38, 0.1);
            transform: scale(1.02);
        }

        .zone-input.surface-input {
            text-align: center;
            font-weight: 600;
            color: var(--primary-red);
        }

        .zone-input.hours-input {
            text-align: center;
            font-weight: 600;
            color: var(--primary-blue);
        }

        .zone-select {
            width: 100%;
            border: 2px solid var(--gray-200);
            border-radius: 0.5rem;
            padding: 0.75rem;
            font-size: 0.9rem;
            background: var(--white);
            transition: all 0.3s ease;
        }

        .zone-select:focus {
            outline: none;
            border-color: var(--primary-red);
            box-shadow: 0 0 0 3px rgba(220, 38, 38, 0.1);
        }

        .zone-actions {
            display: flex;
            justify-content: center;
            gap: 0.5rem;
        }

        .action-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: var(--shadow-sm);
        }

        .action-btn:hover {
            transform: scale(1.1);
            box-shadow: var(--shadow-md);
        }

        .action-btn.validate {
            background: var(--success);
            color: white;
        }

        .action-btn.delete {
            background: var(--danger);
            color: white;
        }

        .action-btn:active {
            transform: scale(0.95);
        }

        .mode-option input[type="radio"] {
            margin: 0;
        }

        .mode-option input[type="radio"]:checked + span {
            font-weight: 600;
        }

        .mode-option:has(input:checked) {
            background: var(--success) !important;
            color: white !important;
            font-weight: 600;
        }

        .mode-option:not(:has(input:checked)) {
            background: var(--gray-200);
            color: var(--gray-700);
        }

        .empty-state {
            text-align: center;
            padding: 3rem 2rem;
            color: var(--gray-500);
        }

        .empty-state-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        .empty-state-text {
            font-size: 1.1rem;
            margin-bottom: 0.5rem;
        }

        .empty-state-subtext {
            font-size: 0.9rem;
            opacity: 0.7;
        }

        /* Animation pour les nouvelles zones */
        .zone-row.new-zone {
            animation: slideInFromTop 0.5s ease-out;
        }

        @keyframes slideInFromTop {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Animation pour la validation */
        .zone-row.validating {
            animation: validatePulse 0.6s ease-out;
        }

        @keyframes validatePulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.02); background: var(--success); color: white; }
            100% { transform: scale(1); }
        }

        @media (max-width: 768px) {
            .sidebar { transform: translateX(-100%); }
            .content-with-sidebar { margin-left: 0; padding: 1rem; }
            .form-grid { grid-template-columns: 1fr; }
            .tabs-header { flex-direction: column; }
            .financial-dashboard { grid-template-columns: 1fr; }
            .donut-chart-wrapper { flex-direction: column; text-align: center; }
        }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <nav class="sidebar">
        <div class="sidebar-header">
            <div class="sidebar-logo">🏗️ Gestionnaire Chantier</div>
            <div class="sidebar-subtitle">Équipe 41 - Chasse sur Rhône</div>
        </div>
        
        <div class="sidebar-nav">
            <div class="nav-section">
                <div class="nav-section-title">Principal</div>
                <a href="index.html" class="nav-item">
                    <span class="icon">🏠</span>
                    Tableau de Bord
                </a>
                <a href="planning.html" class="nav-item">
                    <span class="icon">📅</span>
                    Planning
                </a>
                <a href="pointage.html" class="nav-item">
                    <span class="icon">⏰</span>
                    Pointage
                </a>
            </div>
            
            <div class="nav-section">
                <div class="nav-section-title">Gestion</div>
                <a href="equipe.html" class="nav-item">
                    <span class="icon">👥</span>
                    Équipe
                </a>
                <a href="materiaux.html" class="nav-item active">
                    <span class="icon">🔧</span>
                    Travaux & Matériaux
                </a>
                <a href="reunion.html" class="nav-item">
                    <span class="icon">🗓️</span>
                    Réunions
                </a>
            </div>
            
            <div class="nav-section">
                <div class="nav-section-title">Outils</div>
                <a href="planning_affectation.html" class="nav-item">
                    <span class="icon">📋</span>
                    Affectations
                </a>
            </div>
        </div>
    </nav>

    <div class="content-with-sidebar">
        <div class="travaux-header">
            <div class="header-content">
                <div>
                    <h1 class="page-title">🔧 Travaux & Matériaux</h1>
                    <p class="page-subtitle">Équipe 41 - Chasse sur Rhône • Altrad Prezioso</p>
                </div>
                <div>
                    <button class="btn btn-warning" onclick="exportData()">📤 Exporter</button>
                    <button class="btn btn-primary" onclick="saveAll()">💾 Enregistrer Tout</button>
                </div>
            </div>
        </div>
               <div class="tabs-container">
            <div class="tabs-header">
                <button class="tab-btn active" data-tab="infos-generales">ℹ️ Infos Générales</button>
                <button class="tab-btn" data-tab="surfaces">📏 Surface et Environnement</button>
                <button class="tab-btn" data-tab="materiaux">🎨 Matériaux & Peintures</button>
                <button class="tab-btn" data-tab="location">🚚 Location</button>
                <button class="tab-btn" data-tab="atelier">🔩 Pièces Atelier</button>
                <button class="tab-btn" data-tab="resume-chantier">📄 Résumé Chantier</button>
            </div>

            <div class="tab-content active" id="tab-infos-generales">
                <h3 style="margin-bottom: 1.5rem;">ℹ️ Informations Générales du Chantier</h3>
                
                <h4 style="margin: 1.5rem 0 1rem; color: var(--primary-red);">Détails du Chantier</h4>
                <div class="form-grid">
                    <div class="form-group">
                        <label for="nom-chantier" class="form-label required">Nom du chantier</label>
                        <input type="text" id="nom-chantier" class="form-input" placeholder="Ex: Rénovation cuve 102">
                    </div>
                    <div class="form-group">
                        <label for="otp-numero" class="form-label">Numéro OTP</label>
                        <input type="text" id="otp-numero" class="form-input" placeholder="Ex: 2025-1234">
                    </div>
                    <div class="form-group">
                        <label for="adresse-chantier" class="form-label">Adresse du chantier</label>
                        <textarea id="adresse-chantier" class="form-textarea" placeholder="123 Rue du Chantier, 69360 Chasse-sur-Rhône"></textarea>
                    </div>
                </div>

                <h4 style="margin: 1.5rem 0 1rem; color: var(--primary-red);">Informations Client</h4>
                <div class="form-grid">
                    <div class="form-group">
                        <label for="client-societe" class="form-label">Nom de la société</label>
                        <input type="text" id="client-societe" class="form-input">
                    </div>
                    <div class="form-group">
                        <label for="client-responsable-nom-prenom" class="form-label">Nom et prénom du responsable</label>
                        <input type="text" id="client-responsable-nom-prenom" class="form-input" placeholder="Ex: Jean Dupont">
                    </div>
                    <div class="form-group">
                        <label for="client-tel" class="form-label">Téléphone</label>
                        <input type="tel" id="client-tel" class="form-input">
                    </div>
                    <div class="form-group">
                        <label for="client-email" class="form-label">Email</label>
                        <input type="email" id="client-email" class="form-input">
                    </div>
                    <div class="form-group">
                        <label for="client-adresse" class="form-label">Adresse</label>
                        <textarea id="client-adresse" class="form-textarea"></textarea>
                    </div>
                </div>
                
                <h4 style="margin: 1.5rem 0 1rem; color: var(--primary-red);">Planning et Responsabilités</h4>
                <div class="form-grid">
                    <div style="display: flex; gap: 1.5rem;">
                         <div class="form-group" style="flex: 1;">
                            <label for="date-demarrage" class="form-label">Date de démarrage prévue</label>
                            <input type="date" id="date-demarrage" class="form-input">
                        </div>
                        <div class="form-group" style="flex: 1;">
                            <label for="date-fin" class="form-label">Date de fin prévue</label>
                            <input type="date" id="date-fin" class="form-input">
                        </div>
                    </div>
                </div>

                <h4 style="margin: 1.5rem 0 1rem; color: var(--primary-red);">Contacts Altrad Prezioso</h4>
                <div class="summary-grid">
                    <div class="summary-item" style="text-align: left;">
                        <div class="summary-label">📞 Responsable d'Agence</div>
                        <p><strong>MARTIN HANGARD</strong><br><small>martin.hangard@altrad.com</small><br><small>06 80 66 23 85</small></p>
                    </div>
                    <div class="summary-item" style="text-align: left;">
                        <div class="summary-label">🔧 Conducteur de Travaux</div>
                        <p><strong>YASAR ERTUGRUL</strong><br><small>ertugrul.yasar@altrad.com</small><br><small>06 70 45 01 61</small></p>
                    </div>
                     <div class="summary-item" style="text-align: left;">
                        <div class="summary-label">💼 Chargé d'Affaires</div>
                        <p><strong>SYLVAIN GARREAU</strong><br><small>sylvain.garreau@altrad.com</small><br><small>06 88 21 92 66</small></p>
                    </div>
                     <div class="summary-item" style="text-align: left;">
                        <div class="summary-label">🛡️ Contact HSE</div>
                        <p><strong>LOU PIEDIGROSSI</strong><br><small>lou.piedigrossi@altrad.com</small><br><small>06 82 98 09 99</small></p>
                    </div>
                    <div class="summary-item" style="text-align: left;">
                        <div class="summary-label">👷 Chef de Chantier / Chef d'Équipe</div>
                        <input type="text" id="chef-chantier" class="form-input" placeholder="Nom du responsable...">
                    </div>
                </div>
            </div>

            <div class="tab-content" id="tab-surfaces">
                <h3 style="margin-bottom: 1.5rem; display: flex; align-items: center; gap: 0.5rem;">
                    📏 Gestion des Surfaces
                </h3>

                <!-- Configuration du projet -->
                <div class="project-config" style="background: var(--white); border-radius: 1rem; padding: 1.5rem; margin-bottom: 2rem; box-shadow: var(--shadow-sm); border: 1px solid var(--gray-200);">
                    <h4 style="margin-bottom: 1rem; color: var(--primary-red); display: flex; align-items: center; gap: 0.5rem;">
                        ⚙️ Configuration du Projet
                    </h4>
                    <div class="form-grid" style="grid-template-columns: 1fr 1fr; gap: 1.5rem;">
                    <div class="form-group">
                        <label class="form-label required">🏗️ Type de Structure</label>
                            <select class="form-select" id="structure-type" onchange="toggleMaterialSections()" style="width: 180px;">
                            <option value="">Sélectionner le type</option>
                            <option value="parking">Parking</option>
                            <option value="site-industriel">Site industriel</option>
                            <option value="canalisation">Canalisation</option>
                            <option value="batiment">Bâtiment industriel</option>
                            <option value="pont">Pont/Passerelle</option>
                            <option value="autre">Autre structure</option>
                        </select>
                    </div>
                    <div class="form-group" id="autre-structure-group" style="display: none;">
                        <label class="form-label required" for="autre-structure-input">Préciser le type de surface</label>
                        <input type="text" id="autre-structure-input" class="form-input" placeholder="Ex: Charpente métallique">
                    </div>
                </div>
                </div>

                <!-- Configuration environnementale -->
                <div class="environment-config" style="background: var(--white); border-radius: 1rem; padding: 1.5rem; margin-bottom: 2rem; box-shadow: var(--shadow-sm); border: 1px solid var(--gray-200);">
                    <h4 style="margin-bottom: 1rem; color: var(--primary-red); display: flex; align-items: center; gap: 0.5rem;">
                        🌍 Configuration Environnementale
                    </h4>
                    <div class="form-grid" style="grid-template-columns: 1fr 1fr 1fr; gap: 1.5rem;">
                        <div class="form-group">
                            <label class="form-label required">🎯 Type de Traitement</label>
                            <select class="form-select" id="traitement-type" onchange="handleTraitementTypeChange()" style="width: 190px;">
                                <option value="">Sélectionner le traitement</option>
                                <option value="anticorrosion">Anti-corrosion</option>
                                <option value="decoration">Décoratif</option>
                                <option value="autre">Autre (à spécifier)</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label class="form-label required">🔧 Type de Travaux</label>
                            <select class="form-select" id="type-travaux" style="width: 100px;">
                                <option value="">Sélectionner le type</option>
                                <option value="entretien">Entretien</option>
                                <option value="neuf">Neuf</option>
                                <option value="renovation">Rénovation</option>
                                <option value="maintenance">Maintenance</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label class="form-label required">🌡️ Conditions d'Exposition</label>
                            <select class="form-select" id="exposition-conditions" style="width: 230px;">
                                <option value="">Sélectionner les conditions</option>
                                <option value="interieur">Intérieur sec</option>
                                <option value="humide">Intérieur humide</option>
                                <option value="exterieur">Extérieur normal</option>
                                <option value="marin">Atmosphère marine</option>
                                <option value="industriel">Atmosphère industrielle</option>
                            </select>
                        </div>
                        </div>

                    <div class="form-group" id="traitement-autre-group" style="display: none; margin-top: 1rem;">
                        <label class="form-label">Spécifier le traitement</label>
                        <input type="text" class="form-input" id="traitement-autre" placeholder="Spécifier le type de traitement">
                    </div>
                </div>

                <!-- Section de saisie des zones -->
                <div class="zones-input-section" style="background: var(--white); border-radius: 1rem; padding: 1.5rem; margin-bottom: 2rem; box-shadow: var(--shadow-sm); border: 1px solid var(--gray-200);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                        <h4 style="margin: 0; color: var(--primary-red); display: flex; align-items: center; gap: 0.5rem;">
                            📝 Saisie des Zones
                        </h4>
                        <button class="btn btn-success" onclick="addNewZone()" style="display: flex; align-items: center; gap: 0.5rem; padding: 0.75rem 1.5rem;">
                            ➕ Nouvelle Zone
                        </button>
                    </div>
                    
                    <!-- Mode de saisie -->
                    <div class="input-mode-selector" style="display: flex; gap: 1rem; margin-bottom: 1.5rem; padding: 1rem; background: var(--gray-50); border-radius: 0.75rem; border: 1px solid var(--gray-200);">
                        <label class="mode-option" style="display: flex; align-items: center; gap: 0.75rem; cursor: pointer; padding: 0.75rem 1.5rem; border-radius: 0.5rem; transition: all 0.3s; flex: 1; justify-content: center; background: var(--success); color: white; font-weight: 600;">
                            <input type="radio" name="surface-mode" value="client" checked style="width: 20px; height: 20px; accent-color: white;">
                            <span>📋 Renseignées par le client</span>
                        </label>
                        <label class="mode-option" style="display: flex; align-items: center; gap: 0.75rem; cursor: pointer; padding: 0.75rem 1.5rem; border-radius: 0.5rem; transition: all 0.3s; flex: 1; justify-content: center; background: var(--gray-200); color: var(--gray-700); font-weight: 500;">
                            <input type="radio" name="surface-mode" value="calculee" style="width: 20px; height: 20px; accent-color: var(--primary-red);">
                            <span>🧮 Calculées automatiquement</span>
                        </label>
                    </div>
                    
                    <!-- Tableau des zones -->
                    <div class="zones-table-container" style="background: var(--white); border-radius: 0.75rem; overflow: hidden; border: 1px solid var(--gray-200);">
                        <!-- En-tête du tableau -->
                        <div class="table-header" style="background: linear-gradient(135deg, var(--primary-red), var(--primary-orange)); color: white; padding: 1rem 1.5rem;">
                            <div class="table-row" style="display: grid; grid-template-columns: 1.5fr 1.5fr 1fr 1fr 1fr 1fr 1fr 100px; gap: 1rem; font-weight: 600; font-size: 0.9rem; align-items: center;">
                                <div>🏷️ Nom de la Zone</div>
                                <div>🔨 Type de Travaux</div>
                                <div>🔧 Type de Surface</div>
                                <div>📍 Surface</div>
                                <div>📏 Surface (m²)</div>
                                <div>👥 Opérateurs</div>
                                <div>⏰ Heures</div>
                                <div style="text-align: center;">⚙️ Actions</div>
                            </div>
                        </div>
                        
                        <!-- Corps du tableau -->
                        <div id="zones-table-body" class="table-body" style="min-height: 100px;">
                            <!-- Les zones seront ajoutées ici dynamiquement -->
                        </div>
                    </div>
                </div>


                <div class="calculation-summary">
                    <h4 style="margin-bottom: 1.5rem; color: var(--primary-red); display: flex; align-items: center; gap: 0.5rem;">
                        📋 Récapitulatif Détaillé des Surfaces
                    </h4>
                    
                    <!-- Section des zones validées - Format compact -->
                    <div style="margin-bottom: 2rem;">
                        <h5 style="color: var(--success); margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                            ✅ Zones validées
                        </h5>
                        <div id="zones-validees-details" style="background: var(--gray-50); border-radius: 0.5rem; padding: 1rem; border-left: 4px solid var(--success);">
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; font-size: 0.9rem; margin-bottom: 1rem;">
                                <div>
                                    <strong>Nombre de zones:</strong> <span id="nb-zones-validees">0</span>
                        </div>
                                <div>
                                    <strong>Surface totale:</strong> <span id="surface-validees" style="color: var(--primary-red); font-weight: 600;">0.00 m²</span>
                        </div>
                                <div>
                                    <strong>Heures prévues:</strong> <span id="heures-validees" style="color: var(--primary-blue); font-weight: 600;">0 h</span>
                        </div>
                            </div>
                            
                            <!-- Liste détaillée des zones validées -->
                            <div id="zones-validees-liste" style="display: block;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                                    <h6 style="color: var(--success); margin: 0; font-size: 0.9rem;">📋 Détail des zones validées :</h6>
                                    <button class="btn btn-warning btn-small" onclick="toggleZonesEditMode()" style="padding: 0.25rem 0.75rem; font-size: 0.8rem;">
                                        ✏️ Mode édition
                                    </button>
                                </div>
                                <div id="zones-validees-items" style="display: grid; gap: 0.75rem;">
                                    <!-- Les zones validées apparaîtront ici avec boutons d'action -->
                        </div>
                    </div>
                        </div>
                    </div>

                    <!-- Section calcul jours/homme -->
                    <div style="margin-bottom: 2rem;">
                        <h5 style="color: var(--primary-blue); margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                            ⏰ Planification des Ressources
                        </h5>
                        <div id="planification-details" style="background: linear-gradient(135deg, var(--primary-blue), #3b82f6); color: white; border-radius: 0.5rem; padding: 1.5rem; box-shadow: var(--shadow-md);">
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem; font-size: 0.95rem;">
                                <div style="text-align: center; background: rgba(255,255,255,0.1); padding: 1rem; border-radius: 0.5rem;">
                                    <div style="font-size: 2rem; font-weight: 700; margin-bottom: 0.5rem;" id="total-heures-planification">0</div>
                                    <div style="opacity: 0.9; font-size: 0.9rem;">Heures totales</div>
                                </div>
                                <div style="text-align: center; background: rgba(255,255,255,0.2); padding: 1rem; border-radius: 0.5rem; border: 2px solid rgba(255,255,255,0.3);">
                                    <div style="font-size: 2rem; font-weight: 700; margin-bottom: 0.5rem;" id="jours-homme-planification">0</div>
                                    <div style="opacity: 0.9; font-size: 0.9rem;">Jours/Homme</div>
                                </div>
                                <div style="text-align: center; background: rgba(255,255,255,0.1); padding: 1rem; border-radius: 0.5rem;">
                                    <div style="font-size: 2rem; font-weight: 700; margin-bottom: 0.5rem;" id="duree-estimee-planification">0</div>
                                    <div style="opacity: 0.9; font-size: 0.9rem;">Durée estimée (j)</div>
                                </div>
                            </div>
                            <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid rgba(255,255,255,0.2); font-size: 0.85rem; opacity: 0.9;">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <span>📊 Calcul basé sur 8.5h/jour par opérateur</span>
                                    <span id="detail-calcul-planification">Aucune zone validée</span>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
            </div>

            <div class="tab-content" id="tab-materiaux">
                <h3 style="margin-bottom: 1.5rem; display: flex; align-items: center; gap: 0.5rem;">
                    🎨 Matériaux & Spécifications Techniques
                </h3>

                <!-- Message d'état vide -->
                <div id="materiaux-empty-state" style="text-align: center; padding: 3rem; background: var(--gray-50); border-radius: 1rem; border: 2px dashed var(--gray-300); margin-bottom: 2rem;">
                    <div style="font-size: 3rem; margin-bottom: 1rem;">🎨</div>
                    <h4 style="color: var(--gray-600); margin-bottom: 0.5rem;">Aucune zone validée</h4>
                    <p style="color: var(--gray-500); font-size: 0.9rem;">Validez d'abord des zones dans l'onglet "Surface et Environnement" pour commencer la saisie des matériaux.</p>
                </div>

                <!-- Interface principale des matériaux -->
                <div id="materiaux-main-interface" style="display: none;">
                    <!-- Sélection de zone -->
                    <div class="materiaux-section" style="background: var(--white); border-radius: 1rem; padding: 1.5rem; margin-bottom: 2rem; box-shadow: var(--shadow-sm); border: 1px solid var(--gray-200);">
                        <h4 style="margin-bottom: 1.5rem; color: var(--primary-red); display: flex; align-items: center; gap: 0.5rem;">
                            📍 Sélection de Zone
                        </h4>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;">
                            <div class="form-group">
                                <label class="form-label required">Zone à traiter</label>
                                <select class="form-select" id="zone-concerned" onchange="updateZoneDetailsAndMaterials()" style="width: 100%;">
                                    <option value="">Sélectionner une zone</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Détails de la zone</label>
                                <div id="zone-details" class="zone-details-display" style="padding: 1rem; background: var(--gray-50); border-radius: 0.5rem; border: 1px solid var(--gray-200); min-height: 80px; display: flex; align-items: center; color: var(--gray-600); font-style: italic; font-size: 0.9rem;">
                                    Aucune zone sélectionnée
                                </div>
                            </div>
                        </div>
                        
                        <!-- Informations supplémentaires -->
                        <div class="form-group" style="margin-bottom: 1.5rem;">
                            <label class="form-label">📝 Informations supplémentaires</label>
                            <textarea class="form-input" id="zone-additional-info" placeholder="Ajoutez des informations complémentaires sur cette zone..." style="width: 100%; min-height: 80px; resize: vertical; font-family: inherit;"></textarea>
                        </div>
                        </div>
                    </div>

                    <!-- Spécifications générales -->
                    <div class="materiaux-section" style="background: var(--white); border-radius: 1rem; padding: 1.5rem; margin-bottom: 2rem; box-shadow: var(--shadow-sm); border: 1px solid var(--gray-200);">
                        <h4 style="margin-bottom: 1.5rem; color: var(--primary-red); display: flex; align-items: center; gap: 0.5rem;">
                            ⚙️ Spécifications Générales
                        </h4>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;">
                            <div class="form-group">
                                <label class="form-label">🏭 Fournisseur</label>
                                <select class="form-select" id="fournisseur-global" onchange="handleFournisseurChange(this)" style="width: 100%;">
                                    <option value="">Sélectionner...</option>
                                    <option value="hempel">HEMPEL</option>
                                    <option value="akzo-nobel">AKZO NOBEL</option>
                                    <option value="jotun">JOTUN</option>
                                    <option value="carboline">CARBOLINE</option>
                                    <option value="freitag">FREITAG</option>
                                    <option value="goholit">GOHOLIT</option>
                                    <option value="maestria">MAESTRIA</option>
                                    <option value="sob-solution">SOB SOLUTION</option>
                                    <option value="autres">AUTRES</option>
                                </select>
                            </div>
                            <div class="form-group" id="fournisseur-autre-group" style="display: none;">
                                <label class="form-label">Préciser le fournisseur</label>
                                <input type="text" class="form-input" id="fournisseur-autre-global" placeholder="Préciser le fournisseur" style="width: 100%;">
                            </div>
                        </div>
                    </div>

                    <!-- Sections conditionnelles basées sur les travaux -->
                    <div id="materiaux-conditional-sections">
                        <!-- Les sections apparaîtront ici dynamiquement selon les travaux -->
                    </div>

                    <!-- Bouton de validation -->
                    <div style="text-align: center; margin-top: 2rem;">
                        <button class="btn btn-success btn-large" onclick="validateMaterialSpecs()" style="padding: 1rem 2.5rem; font-size: 1.1rem; display: inline-flex; align-items: center; gap: 0.5rem; background: var(--success); border: none; color: white; border-radius: 0.75rem; font-weight: 600; box-shadow: var(--shadow-md); transition: all 0.2s ease;">
                            ✅ Valider les Spécifications
                        </button>
                    </div>
                </div>
            </div>

            <div class="tab-content" id="tab-location">
                <h3 style="margin-bottom: 1.5rem; display: flex; align-items: center; gap: 0.5rem;">
                    🚚 Location de Matériel
                </h3>
            
                <div class="collapsible-category">
                    <h4 class="collapsible-header">🏢 LOCATION INTERNE - St Maurice</h4>
                    <div class="collapsible-content">
                        <div class="collapsible-category">
                            <h5 class="collapsible-header">DECAPAGE ABRASIF / PREPARATION DE SURFACE</h5>
                    <div class="collapsible-content">
                        <table class="dynamic-table">
                            <thead>
                                <tr>
                                    <th>Matériel</th>
                                    <th style="width: 120px;">Quantité</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr><td>Abrasif: Corrindon</td><td><input type="number" class="form-input" value="0" min="0"></td></tr>
                                <tr><td>Abrasif: Sable Rugos 94/14</td><td><input type="number" class="form-input" value="0" min="0"></td></tr>
                                <tr><td>Ampoule pour lampe de sablage</td><td><input type="number" class="form-input" value="0" min="0"></td></tr>
                                <tr><td>Aspirateur</td><td><input type="number" class="form-input" value="0" min="0"></td></tr>
                                <tr><td>Aspirateur à fut (pneumatique)</td><td><input type="number" class="form-input" value="0" min="0"></td></tr>
                                <tr><td>Balais CANTONIER</td><td><input type="number" class="form-input" value="0" min="0"></td></tr>
                                <tr><td>Balayette à main</td><td><input type="number" class="form-input" value="0" min="0"></td></tr>
                                <tr><td>Big bags 1 t</td><td><input type="number" class="form-input" value="0" min="0"></td></tr>
                                <tr><td>Brosse MBX</td><td><input type="number" class="form-input" value="0" min="0"></td></tr>
                                <tr><td>Brosse métallique</td><td><input type="number" class="form-input" value="0" min="0"></td></tr>
                                <tr><td>Brouette</td><td><input type="number" class="form-input" value="0" min="0"></td></tr>
                                <tr><td>Buse de sablage (110/95/80)</td><td><input type="number" class="form-input" value="0" min="0"></td></tr>
                                <tr><td>Carreaux de sablage</td><td><input type="number" class="form-input" value="0" min="0"></td></tr>
                                <tr><td>Casque de sablage</td><td><input type="number" class="form-input" value="0" min="0"></td></tr>
                                <tr><td>Clarinette (préciser les raccords)</td><td><input type="number" class="form-input" value="0" min="0"></td></tr>
                                <tr><td>Combinaison de sablage</td><td><input type="number" class="form-input" value="0" min="0"></td></tr>
                                <tr><td>Disque abrasif (A préciser)</td><td><input type="number" class="form-input" value="0" min="0"></td></tr>
                                <tr><td>Estropes</td><td><input type="number" class="form-input" value="0" min="0"></td></tr>
                                <tr><td>Gants de sablage</td><td><input type="number" class="form-input" value="0" min="0"></td></tr>
                                <tr><td>Girafe</td><td><input type="number" class="form-input" value="0" min="0"></td></tr>
                                <tr><td>Lampe de sablage 24V ou sur pile</td><td><input type="number" class="form-input" value="0" min="0"></td></tr>
                                <tr><td>Lance de sablage "fouet" +porte buse</td><td><input type="number" class="form-input" value="0" min="0"></td></tr>
                                <tr><td>Lance de sablage "Rallonge" (20 ou 40 ml)</td><td><input type="number" class="form-input" value="0" min="0"></td></tr>
                                <tr><td>Papier à poncer (A préciser)</td><td><input type="number" class="form-input" value="0" min="0"></td></tr>
                                <tr><td>Pelle (A manche ou à main)</td><td><input type="number" class="form-input" value="0" min="0"></td></tr>
                                <tr><td>Ponçeuse (Pneumatique ou électrique)</td><td><input type="number" class="form-input" value="0" min="0"></td></tr>
                                <tr><td>Raclette</td><td><input type="number" class="form-input" value="0" min="0"></td></tr>
                                <tr><td>Rifflard</td><td><input type="number" class="form-input" value="0" min="0"></td></tr>
                                <tr><td>Sacs poubelle</td><td><input type="number" class="form-input" value="0" min="0"></td></tr>
                                <tr><td>Seaux noirs</td><td><input type="number" class="form-input" value="0" min="0"></td></tr>
                                <tr><td>Souflette avec tuyaux (x ml)</td><td><input type="number" class="form-input" value="0" min="0"></td></tr>
                                <tr><td>Tuyaux d'air 1"1/2 - raccord vissé</td><td><input type="number" class="form-input" value="0" min="0"></td></tr>
                                <tr><td>Tuyaux d'air 2'' - filetage gaz</td><td><input type="number" class="form-input" value="0" min="0"></td></tr>
                                <tr><td>Tuyaux d'air 2'' - raccord pompier / Souple</td><td><input type="number" class="form-input" value="0" min="0"></td></tr>
                                <tr><td>Tuyaux d'air 3/4" avec tete chat</td><td><input type="number" class="form-input" value="0" min="0"></td></tr>
                                <tr><td>Tuyaux d'air noir et jaune 38</td><td><input type="number" class="form-input" value="0" min="0"></td></tr>
                                <tr><td>Tuyaux d'air pour souflette 18</td><td><input type="number" class="form-input" value="0" min="0"></td></tr>
                                <tr><td>Tuyaux d'eau 25</td><td><input type="number" class="form-input" value="0" min="0"></td></tr>
                                <tr><td>HP / LAVAGE HAUTE PRESSION (≤ 250 bars)</td><td><input type="number" class="form-input" value="0" min="0"></td></tr>
                                <tr><td>THP / UHP / TRAITEMENT EAUX USEES</td><td><input type="number" class="form-input" value="0" min="0"></td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="collapsible-category">
                            <h5 class="collapsible-header">EQUIPEMENT DE PROTECTION INDIVIDUELLE</h5>
                    <div class="collapsible-content">
                        <table class="dynamic-table">
                            <thead>
                                <tr>
                                    <th>Matériel</th>
                                    <th style="width: 120px;">Quantité</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr><td>Bouchon d'oreille</td><td><input type="number" class="form-input" value="0" min="0"></td></tr>
                                <tr><td>Bottes de sécurité (sableur)</td><td><input type="number" class="form-input" value="0" min="0"></td></tr>
                                <tr><td>Bouteilles d'eau</td><td><input type="number" class="form-input" value="0" min="0"></td></tr>
                                <tr><td>Cagoule de peinture ventilée</td><td><input type="number" class="form-input" value="0" min="0"></td></tr>
                                <tr><td>Casque de sécurité + jugulaire</td><td><input type="number" class="form-input" value="0" min="0"></td></tr>
                                <tr><td>Chaussures de sécurité</td><td><input type="number" class="form-input" value="0" min="0"></td></tr>
                                <tr><td>Chaussures de montagne</td><td><input type="number" class="form-input" value="0" min="0"></td></tr>
                                <tr><td>Combinaison de sablage</td><td><input type="number" class="form-input" value="0" min="0"></td></tr>
                                <tr><td>Combinaison Jaune Tychem</td><td><input type="number" class="form-input" value="0" min="0"></td></tr>
                                <tr><td>Combinaison pluie</td><td><input type="number" class="form-input" value="0" min="0"></td></tr>
                                <tr><td>Combinaison Tyvek Classique (XL ou XXL)</td><td><input type="number" class="form-input" value="0" min="0"></td></tr>
                                <tr><td>Gants de manutention</td><td><input type="number" class="form-input" value="0" min="0"></td></tr>
                                <tr><td>Gants de peinture ("mappa")</td><td><input type="number" class="form-input" value="0" min="0"></td></tr>
                                <tr><td>Lampe frontale (ATEX ou PAS)</td><td><input type="number" class="form-input" value="0" min="0"></td></tr>
                                <tr><td>Lunettes (incolore ou solaire)</td><td><input type="number" class="form-input" value="0" min="0"></td></tr>
                                <tr><td>Lunettes étanches</td><td><input type="number" class="form-input" value="0" min="0"></td></tr>
                                <tr><td>Masque à peinture A2P3 (1/2 masque)</td><td><input type="number" class="form-input" value="0" min="0"></td></tr>
                                <tr><td>Masque à poussière FFP3</td><td><input type="number" class="form-input" value="0" min="0"></td></tr>
                                <tr><td>Masque Phantom 2000 avec batterie</td><td><input type="number" class="form-input" value="0" min="0"></td></tr>
                                <tr><td>Oreilles de Mickey</td><td><input type="number" class="form-input" value="0" min="0"></td></tr>
                                <tr><td>UHP - Patte de canard</td><td><input type="number" class="form-input" value="0" min="0"></td></tr>
                                <tr><td>UHP - Pentalon Kevlard</td><td><input type="number" class="form-input" value="0" min="0"></td></tr>
                                <tr><td>UHP - Veste Kevlard</td><td><input type="number" class="form-input" value="0" min="0"></td></tr>
                                <tr><td>UHP - Gants spécifiques</td><td><input type="number" class="form-input" value="0" min="0"></td></tr>
                                <tr><td>Visière pour casque</td><td><input type="number" class="form-input" value="0" min="0"></td></tr>
                                <tr><td>Masque SCOTT vision 3 avec baudrier RAS</td><td><input type="number" class="form-input" value="0" min="0"></td></tr>
                                <tr><td>PROFLOW 2 avec Vision 2</td><td><input type="number" class="form-input" value="0" min="0"></td></tr>
                                <tr><td>ANTI CHUTE FALCON EDGE: 6,20M</td><td><input type="number" class="form-input" value="0" min="0"></td></tr>
                                <tr><td>ANTI CHUTE FALCON EDGE: 9 M</td><td><input type="number" class="form-input" value="0" min="0"></td></tr>
                                <tr><td>ANTI CHUTE FALCON EDGE: 18 M</td><td><input type="number" class="form-input" value="0" min="0"></td></tr>
                            </tbody>
                        </table>
                            </div>
                    </div>
                </div>

                <!-- FICHE DE DEMANDE D'APPROVISIONNEMENT -->
                <div class="collapsible-category">
                    <h5 class="collapsible-header active">📋 FICHE DE DEMANDE D'APPROVISIONNEMENT</h5>
                    <div class="collapsible-content active" style="display: block;">
                        <div id="supply-form-content" style="background: var(--white); border-radius: 1rem; padding: 1.5rem; margin-bottom: 2rem; box-shadow: var(--shadow-sm); border: 1px solid var(--gray-200);">
                            
                            <!-- Bouton d'impression -->
                            <div style="display: flex; justify-content: flex-end; margin-bottom: 1.5rem;">
                                <button class="btn btn-primary" onclick="printSupplyForm()" style="display: flex; align-items: center; gap: 0.5rem;">
                                    🖨️ Imprimer la Fiche
                                </button>
                            </div>
                            
                            <!-- Informations générales -->
                            <h6 style="margin-bottom: 1rem; color: var(--primary-red); display: flex; align-items: center; gap: 0.5rem;">
                                📝 Informations Générales
                            </h6>
                            <div class="form-grid" style="grid-template-columns: 1fr 1fr 1fr; gap: 1.5rem; margin-bottom: 2rem;">
                                <div class="form-group">
                                    <label class="form-label">Agence</label>
                                    <input type="text" class="form-input" id="approvisionnement-agence" placeholder="Ex: Agence 41">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Demandeur (Request by)</label>
                                    <input type="text" class="form-input" id="approvisionnement-demandeur" placeholder="Ex: Yasar Ertugrul">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Date de la demande</label>
                                    <input type="date" class="form-input" id="approvisionnement-date-demande">
                                </div>
                            </div>

                            <!-- Livraison -->
                            <h6 style="margin-bottom: 1rem; color: var(--primary-red); display: flex; align-items: center; gap: 0.5rem;">
                                🚚 Livraison
                            </h6>
                            <div class="form-grid" style="grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-bottom: 2rem;">
                                <div class="form-group">
                                    <label class="form-label">Adresse</label>
                                    <textarea class="form-input" id="approvisionnement-adresse" placeholder="Adresse de livraison" style="min-height: 80px;"></textarea>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Contact sur chantier</label>
                                    <input type="text" class="form-input" id="approvisionnement-contact-chantier" placeholder="Ex: Laurent Migliorati">
                                </div>
                            </div>

                            <!-- Informations chantier -->
                            <h6 style="margin-bottom: 1rem; color: var(--primary-red); display: flex; align-items: center; gap: 0.5rem;">
                                🏗️ Informations Chantier
                            </h6>
                            <div class="form-grid" style="grid-template-columns: 1fr 1fr 1fr; gap: 1.5rem; margin-bottom: 2rem;">
                                <div class="form-group">
                                    <label class="form-label">N° chantier / OTP</label>
                                    <input type="text" class="form-input" id="approvisionnement-otp" placeholder="Ex: 22541110038">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Accès chantier</label>
                                    <div class="radio-group" style="display: flex; gap: 1rem;">
                                        <label style="display: flex; align-items: center; gap: 0.5rem;">
                                            <input type="radio" name="acces-chantier" value="oui"> Oui
                                        </label>
                                        <label style="display: flex; align-items: center; gap: 0.5rem;">
                                            <input type="radio" name="acces-chantier" value="non" checked> Non
                                        </label>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Carte d'identité</label>
                                    <div class="radio-group" style="display: flex; gap: 1rem;">
                                        <label style="display: flex; align-items: center; gap: 0.5rem;">
                                            <input type="radio" name="carte-identite" value="oui"> Oui
                                        </label>
                                        <label style="display: flex; align-items: center; gap: 0.5rem;">
                                            <input type="radio" name="carte-identite" value="non" checked> Non
                                        </label>
                                    </div>
                                </div>
                            </div>

                            <!-- Moyens de déchargement -->
                            <h6 style="margin-bottom: 1rem; color: var(--primary-red); display: flex; align-items: center; gap: 0.5rem;">
                                🚛 Moyen de déchargement
                            </h6>
                            <div class="form-grid" style="grid-template-columns: 1fr 1fr 1fr 1fr; gap: 1.5rem; margin-bottom: 2rem;">
                                <div class="form-group">
                                    <label class="form-label">Chariot élévateur</label>
                                    <input type="text" class="form-input" id="approvisionnement-chariot-elevateur" placeholder="Détails">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Grue</label>
                                    <input type="text" class="form-input" id="approvisionnement-grue" placeholder="Détails">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Téléscopie</label>
                                    <input type="text" class="form-input" id="approvisionnement-telescopie" placeholder="Détails">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Transpalette</label>
                                    <input type="text" class="form-input" id="approvisionnement-transpalette" placeholder="Détails">
                                </div>
                            </div>

                            <!-- Tableau des matériels demandés -->
                            <h6 style="margin-bottom: 1rem; color: var(--primary-red); display: flex; align-items: center; gap: 0.5rem;">
                                📦 Matériels Demandés
                            </h6>
                            <div style="overflow-x: auto;">
                                <table class="dynamic-table" style="min-width: 1000px;">
                                    <thead>
                                        <tr>
                                            <th style="width: 60px;">Item n°</th>
                                            <th>Type matériel(s), produit(s) demandé(s) / Descriptif détaillé</th>
                                            <th style="width: 80px;">Qté</th>
                                            <th style="width: 120px;">A disposition pour le</th>
                                            <th style="width: 120px;">Retour estimé le</th>
                                            <th style="width: 150px;">* Immatriculations machines</th>
                                            <th style="width: 100px;">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="approvisionnement-materiels-tbody">
                                        <tr>
                                            <td>1</td>
                                            <td><input type="text" class="form-input" placeholder="Ex: Nacelle articulée 15m"></td>
                                            <td><input type="number" class="form-input" value="1" min="1"></td>
                                            <td><input type="date" class="form-input"></td>
                                            <td><input type="date" class="form-input"></td>
                                            <td><input type="text" class="form-input" placeholder="Ex: AB-123-CD"></td>
                                            <td><button class="btn btn-small btn-success" onclick="addApprovisionnementRow(this)">➕</button></td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>

                            <!-- Délai de préparation -->
                            <h6 style="margin-bottom: 1rem; color: var(--primary-red); display: flex; align-items: center; gap: 0.5rem;">
                                ⏰ NDP : Délai De Préparation
                            </h6>
                            <div class="radio-group" style="display: flex; gap: 2rem; margin-bottom: 2rem;">
                                <label style="display: flex; align-items: center; gap: 0.5rem;">
                                    <input type="radio" name="delai-preparation" value="critique-24h"> 1 / Très Critique 24/48h
                                </label>
                                <label style="display: flex; align-items: center; gap: 0.5rem;">
                                    <input type="radio" name="delai-preparation" value="critique-10j"> 2 / Critique ≤ 10 jours
                                </label>
                                <label style="display: flex; align-items: center; gap: 0.5rem;">
                                    <input type="radio" name="delai-preparation" value="non-critique-15j" checked> 3 / Non Critique 15 jours
                                </label>
                            </div>

                            <!-- Commentaires -->
                            <div class="form-group">
                                <label class="form-label">Commentaires</label>
                                <textarea class="form-input" id="approvisionnement-commentaires" placeholder="Commentaires additionnels..." style="min-height: 100px; width: 100%;"></textarea>
                            </div>

                        </div>
                    </div>
                </div>
            </div>

                <div class="collapsible-category">
                    <h4 class="collapsible-header">🌐 LOCATION EXTERNE</h4>
                    <div class="collapsible-content">
                        <!-- Échafaudage -->
                        <div class="collapsible-category">
                            <h5 class="collapsible-header">🏗️ ÉCHAFAUDAGE</h5>
                            <div class="collapsible-content">
                                <div class="checkbox-container">
                                    <label class="checkbox-item-large">
                                        <input type="checkbox" name="echafaudage" value="roulant-interieur">
                                        <span>Échafaudage roulant intérieur</span>
                                    </label>
                                    <label class="checkbox-item-large">
                                        <input type="checkbox" name="echafaudage" value="tour-roulante">
                                        <span>Tour échafaudage roulante</span>
                                    </label>
                                    <label class="checkbox-item-large">
                                        <input type="checkbox" name="echafaudage" value="double-largeur">
                                        <span>Échafaudage roulant double largeur</span>
                                    </label>
                                    <label class="checkbox-item-large">
                                        <input type="checkbox" name="echafaudage" value="escalier-roulante">
                                        <span>Tour escalier roulante</span>
                                    </label>
                                    <label class="checkbox-item-large">
                                        <input type="checkbox" name="echafaudage" value="simple-largeur">
                                        <span>Échafaudage roulant simple largeur</span>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- Nacelle -->
                        <div class="collapsible-category">
                            <h5 class="collapsible-header">🚁 NACELLE</h5>
                            <div class="collapsible-content">
                                <div class="checkbox-container">
                                    <label class="checkbox-item-large">
                                        <input type="checkbox" name="nacelle" value="articulee" onchange="showNacelleDetails(this)">
                                        <span>Nacelle articulée électrique/diesel (préciser hauteur 10m,15m...)</span>
                                    </label>
                                    <label class="checkbox-item-large">
                                        <input type="checkbox" name="nacelle" value="telescopique" onchange="showNacelleDetails(this)">
                                        <span>Nacelle télescopique électrique/diesel (préciser hauteur 10m,15m...)</span>
                                    </label>
                                    <label class="checkbox-item-large">
                                        <input type="checkbox" name="nacelle" value="tout-terrain" onchange="showNacelleDetails(this)">
                                        <span>Nacelle tout-terrain</span>
                                    </label>
                                    <label class="checkbox-item-large">
                                        <input type="checkbox" name="nacelle" value="ciseaux" onchange="showNacelleDetails(this)">
                                        <span>Nacelle ciseaux</span>
                                    </label>
                                    <label class="checkbox-item-large">
                                        <input type="checkbox" name="nacelle" value="araignee" onchange="showNacelleDetails(this)">
                                        <span>Nacelle araignée</span>
                                    </label>
                                    <label class="checkbox-item-large">
                                        <input type="checkbox" name="nacelle" value="mat-vertical" onchange="showNacelleDetails(this)">
                                        <span>Nacelle à mât vertical</span>
                                    </label>
                                    <label class="checkbox-item-large">
                                        <input type="checkbox" name="nacelle" value="camion" onchange="showNacelleDetails(this)">
                                        <span>Camion nacelle</span>
                                    </label>
                                </div>
                                
                                <!-- Détails pour les nacelles sélectionnées -->
                                <div id="nacelle-details" style="display: none; margin-top: 1rem; padding: 1rem; background: var(--gray-50); border-radius: 0.5rem;">
                                    <h6 style="margin-bottom: 1rem; color: var(--primary-red);">Détails des nacelles sélectionnées :</h6>
                                    <div id="nacelle-details-content"></div>
                                </div>
                            </div>
                        </div>

                        <!-- Aspirateurs -->
                        <div class="collapsible-category">
                            <h5 class="collapsible-header">🧹 ASPIRATEURS</h5>
                            <div class="collapsible-content">
                                <div class="checkbox-container">
                                    <label class="checkbox-item-large">
                                        <input type="checkbox" name="aspirateur" value="poussiere">
                                        <span>Aspirateur à poussière</span>
                                    </label>
                                    <label class="checkbox-item-large">
                                        <input type="checkbox" name="aspirateur" value="poussiere-fine">
                                        <span>Aspirateur à poussière fine</span>
                                    </label>
                                    <label class="checkbox-item-large">
                                        <input type="checkbox" name="aspirateur" value="poussiere-silice">
                                        <span>Aspirateur à poussière de silice</span>
                                    </label>
                                    <label class="checkbox-item-large">
                                        <input type="checkbox" name="aspirateur" value="eau">
                                        <span>Aspirateur à eau</span>
                                    </label>
                                    <label class="checkbox-item-large">
                                        <input type="checkbox" name="aspirateur" value="eau-refoulement">
                                        <span>Aspirateur à eau avec refoulement</span>
                                    </label>
                                    <label class="checkbox-item-large">
                                        <input type="checkbox" name="aspirateur" value="eau-poussiere">
                                        <span>Aspirateur à eau et poussière</span>
                                    </label>
                                    <label class="checkbox-item-large">
                                        <input type="checkbox" name="aspirateur" value="accessoires">
                                        <span>Accessoires pour aspirateur</span>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- Auto-laveuse -->
                        <div class="collapsible-category">
                            <h5 class="collapsible-header">🚿 AUTO-LAVEUSE</h5>
                            <div class="collapsible-content">
                                <div class="checkbox-container">
                                    <label class="checkbox-item-large">
                                        <input type="checkbox" name="auto-laveuse" value="batterie">
                                        <span>Auto-laveuse à batterie</span>
                                    </label>
                                    <label class="checkbox-item-large">
                                        <input type="checkbox" name="auto-laveuse" value="filaire">
                                        <span>Auto-laveuse filaire</span>
                                    </label>
                                    <label class="checkbox-item-large">
                                        <input type="checkbox" name="auto-laveuse" value="brosse">
                                        <span>Auto-laveuse à brosse</span>
                                    </label>
                                    <label class="checkbox-item-large">
                                        <input type="checkbox" name="auto-laveuse" value="plateau">
                                        <span>Auto-laveuse à plateau</span>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- Balayeuse -->
                        <div class="collapsible-category">
                            <h5 class="collapsible-header">🧽 BALAYEUSE</h5>
                            <div class="collapsible-content">
                                <div class="checkbox-container">
                                    <label class="checkbox-item-large">
                                        <input type="checkbox" name="balayeuse" value="2500m2">
                                        <span>Balayeuse - 2500 m²/h</span>
                                    </label>
                                    <label class="checkbox-item-large">
                                        <input type="checkbox" name="balayeuse" value="voirie">
                                        <span>Balayeuse de voirie</span>
                                    </label>
                                    <label class="checkbox-item-large">
                                        <input type="checkbox" name="balayeuse" value="industrielle-batterie">
                                        <span>Balayeuse industrielle autoportée à batterie</span>
                                    </label>
                                    <label class="checkbox-item-large">
                                        <input type="checkbox" name="balayeuse" value="industrielle-thermique">
                                        <span>Balayeuse industrielle autoportée grosse capacité double brosse thermique</span>
                                    </label>
                                    <label class="checkbox-item-large">
                                        <input type="checkbox" name="balayeuse" value="thermique">
                                        <span>Balayeuse industrielle autoportée thermique</span>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- Cuve -->
                        <div class="collapsible-category">
                            <h5 class="collapsible-header">🛢️ CUVE</h5>
                            <div class="collapsible-content">
                                <div class="checkbox-container">
                                    <label class="checkbox-item-large">
                                        <input type="checkbox" name="cuve" value="tonne-eau">
                                        <span>Tonne à eau</span>
                                    </label>
                                    <label class="checkbox-item-large">
                                        <input type="checkbox" name="cuve" value="fioul">
                                        <span>Cuve à fioul</span>
                                    </label>
                                    <label class="checkbox-item-large">
                                        <input type="checkbox" name="cuve" value="chariot">
                                        <span>Cuve sur chariot</span>
                                    </label>
                                    <label class="checkbox-item-large">
                                        <input type="checkbox" name="cuve" value="palettisable">
                                        <span>Cuve palettisable</span>
                                    </label>
                                    <label class="checkbox-item-large">
                                        <input type="checkbox" name="cuve" value="skid">
                                        <span>Cuve sur skid</span>
                                    </label>
                                    <label class="checkbox-item-large">
                                        <input type="checkbox" name="cuve" value="remorque">
                                        <span>Cuve sur remorque</span>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- Autres -->
                        <div class="collapsible-category">
                            <h5 class="collapsible-header">🔧 AUTRES</h5>
                            <div class="collapsible-content">
                                <div class="checkbox-container">
                                    <label class="checkbox-item-large">
                                        <input type="checkbox" name="autres" value="pompe-airless">
                                        <span>Pompe Airless</span>
                                    </label>
                                    <label class="checkbox-item-large">
                                        <input type="checkbox" name="autres" value="autres-precise" onchange="showAutresDetails(this)">
                                        <span>Autres (préciser)</span>
                                    </label>
                                </div>
                                
                                <!-- Champ pour préciser "autres" -->
                                <div id="autres-precise-details" style="display: none; margin-top: 1rem;">
                                    <div class="form-group">
                                        <label class="form-label">Préciser les autres besoins :</label>
                                        <textarea class="form-input" id="autres-precise-text" placeholder="Décrivez vos autres besoins de location..." style="min-height: 80px;"></textarea>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                            
                            <!-- Informations générales -->
                            <h6 style="margin-bottom: 1rem; color: var(--primary-red); display: flex; align-items: center; gap: 0.5rem;">
                                📝 Informations Générales
                            </h6>
                            <div class="form-grid" style="grid-template-columns: 1fr 1fr 1fr; gap: 1.5rem; margin-bottom: 2rem;">
                                <div class="form-group">
                                    <label class="form-label">Agence</label>
                                    <input type="text" class="form-input" id="approvisionnement-agence" placeholder="Ex: Agence 41">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Demandeur (Request by)</label>
                                    <input type="text" class="form-input" id="approvisionnement-demandeur" placeholder="Ex: Yasar Ertugrul">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Date de la demande</label>
                                    <input type="date" class="form-input" id="approvisionnement-date-demande">
                                </div>
                            </div>

                            <!-- Livraison -->
                            <h6 style="margin-bottom: 1rem; color: var(--primary-red); display: flex; align-items: center; gap: 0.5rem;">
                                🚚 Livraison
                            </h6>
                            <div class="form-grid" style="grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-bottom: 2rem;">
                                <div class="form-group">
                                    <label class="form-label">Adresse</label>
                                    <textarea class="form-input" id="approvisionnement-adresse" placeholder="Adresse de livraison" style="min-height: 80px;"></textarea>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Contact sur chantier</label>
                                    <input type="text" class="form-input" id="approvisionnement-contact-chantier" placeholder="Ex: Laurent Migliorati">
                                </div>
                            </div>

                            <!-- Informations chantier -->
                            <h6 style="margin-bottom: 1rem; color: var(--primary-red); display: flex; align-items: center; gap: 0.5rem;">
                                🏗️ Informations Chantier
                            </h6>
                            <div class="form-grid" style="grid-template-columns: 1fr 1fr 1fr; gap: 1.5rem; margin-bottom: 2rem;">
                                <div class="form-group">
                                    <label class="form-label">N° chantier / OTP</label>
                                    <input type="text" class="form-input" id="approvisionnement-otp" placeholder="Ex: 22541110038">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Accès chantier</label>
                                    <div class="radio-group" style="display: flex; gap: 1rem;">
                                        <label style="display: flex; align-items: center; gap: 0.5rem;">
                                            <input type="radio" name="acces-chantier" value="oui"> Oui
                                        </label>
                                        <label style="display: flex; align-items: center; gap: 0.5rem;">
                                            <input type="radio" name="acces-chantier" value="non" checked> Non
                                        </label>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Carte d'identité</label>
                                    <div class="radio-group" style="display: flex; gap: 1rem;">
                                        <label style="display: flex; align-items: center; gap: 0.5rem;">
                                            <input type="radio" name="carte-identite" value="oui"> Oui
                                        </label>
                                        <label style="display: flex; align-items: center; gap: 0.5rem;">
                                            <input type="radio" name="carte-identite" value="non" checked> Non
                                        </label>
                                    </div>
                                </div>
                            </div>

                            <!-- Moyens de déchargement -->
                            <h6 style="margin-bottom: 1rem; color: var(--primary-red); display: flex; align-items: center; gap: 0.5rem;">
                                🚛 Moyen de déchargement
                            </h6>
                            <div class="form-grid" style="grid-template-columns: 1fr 1fr 1fr 1fr; gap: 1.5rem; margin-bottom: 2rem;">
                                <div class="form-group">
                                    <label class="form-label">Chariot élévateur</label>
                                    <input type="text" class="form-input" id="approvisionnement-chariot-elevateur" placeholder="Détails">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Grue</label>
                                    <input type="text" class="form-input" id="approvisionnement-grue" placeholder="Détails">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Téléscopie</label>
                                    <input type="text" class="form-input" id="approvisionnement-telescopie" placeholder="Détails">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Transpalette</label>
                                    <input type="text" class="form-input" id="approvisionnement-transpalette" placeholder="Détails">
                                </div>
                            </div>

                            <!-- Tableau des matériels demandés -->
                            <h6 style="margin-bottom: 1rem; color: var(--primary-red); display: flex; align-items: center; gap: 0.5rem;">
                                📦 Matériels Demandés
                            </h6>
                            <div style="overflow-x: auto;">
                                <table class="dynamic-table" style="min-width: 1000px;">
                                    <thead>
                                        <tr>
                                            <th style="width: 50px;">Item n°</th>
                                            <th>Type matériel(s), produit(s) demandé(s) / Descriptif détaillé</th>
                                            <th style="width: 80px;">Qté</th>
                                            <th style="width: 100px;">A disposition pour le</th>
                                            <th style="width: 100px;">Retour estimé le</th>
                                            <th style="width: 120px;">* Immatriculations machines</th>
                                            <th style="width: 60px;">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="approvisionnement-materiels-tbody">
                                        <tr>
                                            <td>1</td>
                                            <td><input type="text" class="form-input" placeholder="Descriptif détaillé du matériel" style="width: 100%;"></td>
                                            <td><input type="number" class="form-input" value="0" min="0" style="width: 100%;"></td>
                                            <td><input type="date" class="form-input" style="width: 100%;"></td>
                                            <td><input type="date" class="form-input" style="width: 100%;"></td>
                                            <td><input type="text" class="form-input" placeholder="Immatriculation" style="width: 100%;"></td>
                                            <td><button class="btn btn-small btn-success" onclick="addApprovisionnementRow(this)">➕</button></td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>

                            <!-- Délai de préparation -->
                            <h6 style="margin-bottom: 1rem; color: var(--primary-red); display: flex; align-items: center; gap: 0.5rem; margin-top: 2rem;">
                                ⏰ NDP : Délai De Préparation
                            </h6>
                            <div class="form-group" style="margin-bottom: 2rem;">
                                <div class="radio-group" style="display: flex; gap: 2rem;">
                                    <label style="display: flex; align-items: center; gap: 0.5rem;">
                                        <input type="radio" name="delai-preparation" value="critique-24h"> 1 / Très Critique 24/48h
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem;">
                                        <input type="radio" name="delai-preparation" value="critique-10j"> 2 / Critique ≤ 10 jours
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem;">
                                        <input type="radio" name="delai-preparation" value="non-critique-15j" checked> 3 / Non Critique 15 jours
                                    </label>
                                </div>
                            </div>

                            <!-- Commentaires -->
                            <div class="form-group">
                                <label class="form-label">Commentaires</label>
                                <textarea class="form-input" id="approvisionnement-commentaires" placeholder="Commentaires additionnels..." style="min-height: 100px; width: 100%;"></textarea>
                            </div>

                        </div>
                    </div>
                </div>
            </div>

            <div class="tab-content" id="tab-atelier">
                <h3 style="margin-bottom: 1.5rem; display: flex; align-items: center; gap: 0.5rem;">
                    🔩 Pièces Atelier St Maurice
                </h3>
                
                <div class="form-group">
                    <label class="form-label">Des pièces seront-elles traitées à l'atelier de St Maurice ?</label>
                    <div class="radio-group">
                        <label>
                            <input type="radio" name="atelier-choice" value="non" checked onchange="toggleAtelierForm()"> Non
                        </label>
                        <label>
                            <input type="radio" name="atelier-choice" value="oui" onchange="toggleAtelierForm()"> Oui
                        </label>
                    </div>
                </div>

                <div id="atelier-details-form" style="display: none; margin-top: 2rem; border-top: 2px solid var(--gray-200); padding-top: 2rem;">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="atelier-nb-pieces" class="form-label">Nombre de pièces</label>
                            <input type="number" id="atelier-nb-pieces" class="form-input" value="0" min="0" onchange="calculateAtelierTotal()">
                        </div>
                        <div class="form-group">
                            <label for="atelier-prix-piece" class="form-label">Prix par pièce (€)</label>
                            <input type="number" id="atelier-prix-piece" class="form-input" value="0" min="0" step="0.01" onchange="calculateAtelierTotal()">
                        </div>
                        <div class="form-group">
                            <label for="atelier-total" class="form-label">Total pièces atelier (€)</label>
                            <input type="text" id="atelier-total" class="form-input" readonly value="0,00 €">
                        </div>
                        <div class="form-group">
                            <label for="atelier-poids" class="form-label">Poids total (KG)</label>
                            <input type="number" id="atelier-poids" class="form-input" value="0" min="0">
                        </div>
                        <div class="form-group">
                            <label for="atelier-m2" class="form-label">m² total des pièces</label>
                            <input type="number" id="atelier-m2" class="form-input" value="0" min="0" step="0.01">
                        </div>
                        <div class="form-group">
                            <label for="atelier-chargement-mode" class="form-label">Mode de chargement</label>
                            <select id="atelier-chargement-mode" class="form-select">
                                <option value="camion-grue">Camion grue</option>
                                <option value="camion-plateau">Camion plateau</option>
                                <option value="semi">Semi</option>
                                <option value="autre">Autre</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="atelier-date-chargement" class="form-label">Date de chargement</label>
                            <input type="date" id="atelier-date-chargement" class="form-input">
                        </div>
                        <div class="form-group">
                            <label for="atelier-date-livraison" class="form-label">Date de livraison chantier</label>
                            <input type="date" id="atelier-date-livraison" class="form-input">
                        </div>
                    </div>
                </div>
            </div>
            

             <div class="tab-content" id="tab-resume-chantier">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;" id="resume-actions">
                    <h3 style="margin: 0;">📄 Résumé Complet du Chantier</h3>
                    <div style="display: flex; gap: 1rem;">
                        <button class="btn btn-primary" onclick="generateAndPrintSummary()">
                            🖨️ Imprimer le Résumé
                        </button>
                        <button class="btn btn-success" onclick="exportToWord()">
                            💾 Enregistrer en Word
                        </button>
                    </div>
                </div>
                <div id="resume-display-area">
                    <p>Veuillez remplir les onglets précédents pour voir le résumé ici.</p>
                </div>
            </div>

        </div>

    </div>

    <div class="auto-save" id="auto-save-indicator">
        💾 Sauvegarde automatique...
    </div>

    <script>
        // Global data object
        let projectData = {
            surfaces: {
                total: 0,
                zones: [],
                heures: 0,
                joursHommes: 0,
                methode: ''
            },
            materiaux: {
                traitementType: '',
                traitementAutre: '',
                typeTravaux: '',
                typesSurface: '',
                expositionConditions: '',
                systemePeinture: '',
                ral: '',
                fournisseur: '',
                preparationSurface: [],
                methodeApplication: [],
                produits: []
            },
            couts: {
                materiaux: 0,
                mainOeuvre: 0,
                fixes: 0,
                total: 0
            }
        };

        // Formatage en Euros
        const formatCurrency = (value) => {
            return (value || 0).toLocaleString('fr-FR', { style: 'currency', currency: 'EUR' });
        };

        // Tab switching
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                
                btn.classList.add('active');
                document.getElementById(`tab-${btn.dataset.tab}`).classList.add('active');
                
                if(btn.dataset.tab === 'materiaux') {
                    syncZones();
                    toggleMaterialSections();
                }
                if(btn.dataset.tab === 'resume-chantier') {
                    generateResumeContent();
                }
            });
        });

        // Dynamic form handling for structure type
        document.getElementById('structure-type').addEventListener('change', function() {
            const autreGroup = document.getElementById('autre-structure-group');
            autreGroup.style.display = (this.value === 'autre') ? 'block' : 'none';
        });

        document.getElementById('traitement-type').addEventListener('change', function() {
            const autreGroup = document.getElementById('traitement-autre-group');
            autreGroup.style.display = (this.value === 'autre') ? 'block' : 'none';
            autoSave();
        });

        document.querySelectorAll('.checkbox-item').forEach(item => {
            item.addEventListener('click', function(e) {
                if (e.target.tagName !== 'INPUT') {
                    const checkbox = this.querySelector('input[type="checkbox"]');
                    checkbox.checked = !checkbox.checked;
                    this.classList.toggle('selected', checkbox.checked);
                    autoSave();
                }
            });
        });

        function updateHoursAndDays() {
            // Calculer les heures en cours
            let heuresEnCours = 0;
            document.querySelectorAll('#surface-connue-tbody .heures-prevues').forEach(input => {
                heuresEnCours += parseInt(input.value) || 0;
            });

            // Calculer les heures validées
            let heuresValidees = 0;
            validatedZones.forEach(zone => {
                heuresValidees += zone.heures;
            });

            // Total général
            let totalHeures = heuresEnCours + heuresValidees;
            const joursHommes = totalHeures / 8.5; // Assuming 8.5-hour workday

            projectData.surfaces.heures = totalHeures;
            projectData.surfaces.joursHommes = joursHommes;

            document.getElementById('total-heures-prevu').textContent = totalHeures;
            document.getElementById('total-jours-hommes').textContent = joursHommes.toFixed(1);

            updateCostBreakdown();
            autoSave();
        }

        function updateTotalSurface() {
            // Calculer les surfaces en cours (nouvelles zones)
            let surfaceEnCours = 0;
            let heuresEnCours = 0;
            let nbZonesEnCours = 0;
            
            document.querySelectorAll('#zones-table-body .zone-row').forEach(row => {
                const surfaceInput = row.querySelector('.zone-surface-input');
                const hoursInput = row.querySelector('.zone-hours-input');
                
                if (surfaceInput && hoursInput) {
                    const surface = parseFloat(surfaceInput.value) || 0;
                    const heures = parseInt(hoursInput.value) || 0;
                    surfaceEnCours += surface;
                    heuresEnCours += heures;
                    if (surface > 0 || heures > 0) nbZonesEnCours++;
                }
            });

            // Calculer les surfaces validées
            let surfaceValidees = 0;
            let heuresValidees = 0;
            let nbZonesValidees = validatedZones.length;
            
            validatedZones.forEach(zone => {
                surfaceValidees += (zone.surface || 0);
                heuresValidees += (zone.hours || 0);
            });

            // Total général
            let total = surfaceEnCours + surfaceValidees;
            let totalHeures = heuresEnCours + heuresValidees;
            
            // Éviter les NaN
            total = isNaN(total) ? 0 : total;
            totalHeures = isNaN(totalHeures) ? 0 : totalHeures;
            
            // Mettre à jour les données du projet
            if (typeof projectData !== 'undefined') {
                projectData.surfaces = projectData.surfaces || {};
            projectData.surfaces.total = total;
                projectData.surfaces.heures = totalHeures;
            }
            
            // Mettre à jour l'affichage des totaux généraux
            const totalSurfaceElement = document.getElementById('total-surface');
            const totalHeuresElement = document.getElementById('total-heures-prevu');
            
            if (totalSurfaceElement) totalSurfaceElement.textContent = total.toFixed(2);
            if (totalHeuresElement) totalHeuresElement.textContent = totalHeures;
            
            // Mettre à jour les détails des zones validées
            const nbZonesValideesElement = document.getElementById('nb-zones-validees');
            const surfaceValideesElement = document.getElementById('surface-validees');
            const heuresValideesElement = document.getElementById('heures-validees');
            
            if (nbZonesValideesElement) nbZonesValideesElement.textContent = nbZonesValidees;
            if (surfaceValideesElement) surfaceValideesElement.textContent = surfaceValidees.toFixed(2) + ' m²';
            if (heuresValideesElement) heuresValideesElement.textContent = heuresValidees + ' h';
            
            // Mettre à jour les autres calculs
            updateHoursAndDays();
            syncZones();
            updateCostBreakdown();
        }


        function addSurfaceConnueRow() {
            const tbody = document.getElementById('surface-connue-tbody');
            const rowCount = tbody.children.length + 1;
            const newRow = document.createElement('div');
            newRow.style.cssText = 'display: grid; grid-template-columns: 1.5fr 1.5fr 1fr 1fr 1fr 80px; gap: 1rem; padding: 1.5rem; border-bottom: 1px solid var(--gray-100); align-items: center; background: var(--white);';
            newRow.innerHTML = `
                <div>
                    <input type="text" placeholder="Zone ${rowCount}" class="zone-name-connue" oninput="autoSave(); syncZones();" style="width: 100%; border: 2px solid var(--gray-200); border-radius: 0.5rem; padding: 0.75rem; font-size: 0.9rem; transition: border-color 0.3s;" onfocus="this.style.borderColor='var(--primary-red)'" onblur="this.style.borderColor='var(--gray-200)'">
                </div>
                <div>
                    <input type="text" placeholder="Description de la zone" class="zone-description" oninput="autoSave()" style="width: 100%; border: 2px solid var(--gray-200); border-radius: 0.5rem; padding: 0.75rem; font-size: 0.9rem; transition: border-color 0.3s;" onfocus="this.style.borderColor='var(--primary-red)'" onblur="this.style.borderColor='var(--gray-200)'">
                </div>
                <div>
                    <select class="surface-type-select" onchange="handleSurfaceTypeChange(this); autoSave()" style="width: 100%; border: 2px solid var(--gray-200); border-radius: 0.5rem; padding: 0.75rem; font-size: 0.9rem; background: white; transition: border-color 0.3s;" onfocus="this.style.borderColor='var(--primary-red)'" onblur="this.style.borderColor='var(--gray-200)'">
                        <option value="">Sélectionner</option>
                        <option value="acier">Acier</option>
                        <option value="beton">Béton</option>
                        <option value="galva">Galva</option>
                        <option value="autres">Autres</option>
                    </select>
                    <input type="text" placeholder="Préciser..." class="surface-type-other" style="width: 100%; border: 2px solid var(--gray-200); border-radius: 0.5rem; padding: 0.75rem; font-size: 0.9rem; margin-top: 0.5rem; display: none; transition: border-color 0.3s;" onfocus="this.style.borderColor='var(--primary-red)'" onblur="this.style.borderColor='var(--gray-200)'">
                </div>
                <div>
                    <input type="number" step="0.01" class="surface-connue" oninput="updateTotalSurface(); autoSave()" placeholder="0.00" style="width: 100%; border: 2px solid var(--gray-200); border-radius: 0.5rem; padding: 0.75rem; font-size: 0.9rem; text-align: center; font-weight: 600; color: var(--primary-red); transition: border-color 0.3s;" onfocus="this.style.borderColor='var(--primary-red)'" onblur="this.style.borderColor='var(--gray-200)'">
                </div>
                <div>
                    <input type="number" step="1" class="heures-prevues" oninput="updateHoursAndDays(); autoSave()" placeholder="0" style="width: 100%; border: 2px solid var(--gray-200); border-radius: 0.5rem; padding: 0.75rem; font-size: 0.9rem; text-align: center; font-weight: 600; color: var(--primary-blue); transition: border-color 0.3s;" onfocus="this.style.borderColor='var(--primary-red)'" onblur="this.style.borderColor='var(--gray-200)'">
                </div>
                <div style="display: flex; justify-content: center; gap: 0.5rem;">
                    <button class="btn btn-small btn-success" onclick="validateRow(this)" style="padding: 0.5rem; border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; font-size: 1rem; transition: all 0.3s;" onmouseover="this.style.transform='scale(1.1)'" onmouseout="this.style.transform='scale(1)'" title="Valider cette zone">
                        ✅
                    </button>
                    <button class="btn btn-small btn-danger" onclick="removeRow(this)" style="padding: 0.5rem; border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; font-size: 1rem; transition: all 0.3s;" onmouseover="this.style.transform='scale(1.1)'" onmouseout="this.style.transform='scale(1)'" title="Supprimer cette zone">
                        🗑️
                    </button>
                </div>
            `;
            tbody.appendChild(newRow);
            syncZones();
            autoSave();
        }
        
        function addNacelleRow(button) {
            const currentRow = button.closest('tr');
            const newRow = currentRow.cloneNode(true);
            newRow.querySelectorAll('input').forEach(input => input.value = '');
            const newButton = newRow.querySelector('button');
            newButton.textContent = '🗑️';
            newButton.classList.remove('btn-success');
            newButton.classList.add('btn-danger');
            newButton.onclick = function() { removeRow(this); };
            currentRow.parentNode.appendChild(newRow);
        }

        function removeRow(button) {
            button.closest('div').remove();
            updateTotalSurface();
            syncZones();
            autoSave();
        }

        function handleSurfaceTypeChange(selectElement) {
            const otherInput = selectElement.parentElement.querySelector('.surface-type-other');
            if (otherInput) {
                otherInput.style.display = (selectElement.value === 'autres') ? 'block' : 'none';
                if (selectElement.value !== 'autres') {
                    otherInput.value = '';
                }
            }
        }

        // ===== NOUVELLE ARCHITECTURE POUR LA GESTION DES SURFACES =====
        
        // Variables globales
        let validatedZones = [];
        let zoneCounter = 1;

        // Fonction de notification améliorée
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 1rem 1.5rem;
                border-radius: 0.75rem;
                color: white;
                font-weight: 600;
                z-index: 10000;
                box-shadow: var(--shadow-lg);
                transform: translateX(100%);
                transition: transform 0.3s ease-in-out;
                max-width: 400px;
                word-wrap: break-word;
                backdrop-filter: blur(10px);
            `;
            
            const colors = {
                success: 'linear-gradient(135deg, var(--success), #22c55e)',
                error: 'linear-gradient(135deg, var(--danger), #ef4444)',
                warning: 'linear-gradient(135deg, var(--warning), #f59e0b)',
                info: 'linear-gradient(135deg, var(--info), #3b82f6)'
            };
            
            notification.style.background = colors[type] || colors.info;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => notification.style.transform = 'translateX(0)', 100);
            setTimeout(() => {
                notification.style.transform = 'translateX(100%)';
                setTimeout(() => notification.remove(), 300);
            }, 4000);
        }

        // Ajouter les styles CSS pour l'amélioration de l'interface
        const style = document.createElement('style');
        style.textContent = `
            /* Styles pour les checkboxes compactes */
            .checkbox-compact:hover {
                background: var(--primary-blue) !important;
                color: white !important;
                transform: translateY(-1px);
                box-shadow: var(--shadow-md);
            }

            .checkbox-compact input[type="checkbox"]:checked + span {
                color: var(--success);
                font-weight: 600;
            }

            .checkbox-compact:hover input[type="checkbox"]:checked + span {
                color: white;
            }

            /* Amélioration des champs de saisie */
            .form-input:focus, .form-select:focus {
                border-color: var(--primary-blue);
                box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
                outline: none;
            }

            /* Animation pour les boutons */
            .btn:hover {
                transform: translateY(-1px);
                box-shadow: var(--shadow-md);
            }

            .btn:active {
                transform: translateY(0);
            }

            /* Amélioration de l'interface matériaux */
            .materiaux-main-section {
                transition: all 0.3s ease;
            }

            .materiaux-main-section:hover {
                box-shadow: var(--shadow-md);
            }

            /* Style pour les champs conditionnels */
            .form-group[style*="display: none"] {
                opacity: 0;
                max-height: 0;
                overflow: hidden;
                transition: all 0.3s ease;
            }

            .form-group:not([style*="display: none"]) {
                opacity: 1;
                max-height: 100px;
                transition: all 0.3s ease;
            }

            /* Styles pour le résumé */
            .resume-container {
                background: var(--white);
                border-radius: 1rem;
                padding: 1.5rem;
                box-shadow: var(--shadow-sm);
                border: 1px solid var(--gray-200);
            }

            .resume-section {
                margin-bottom: 2rem;
                padding-bottom: 1.5rem;
                border-bottom: 1px solid var(--gray-100);
            }

            .resume-section:last-child {
                border-bottom: none;
                margin-bottom: 0;
            }

            .resume-section h4 {
                border-left: 4px solid var(--primary-red);
                padding-left: 1rem;
                margin-bottom: 1rem;
            }

            .dynamic-table {
                width: 100%;
                border-collapse: collapse;
                margin-bottom: 1rem;
            }

            .dynamic-table th,
            .dynamic-table td {
                padding: 0.75rem;
                text-align: left;
                border-bottom: 1px solid var(--gray-200);
            }

            .dynamic-table th {
                background: var(--gray-50);
                font-weight: 600;
                color: var(--gray-900);
            }

            .dynamic-table tr:hover {
                background: var(--gray-50);
            }

            /* Styles pour les lignes de zone */
            .zone-row:hover {
                background: var(--gray-50) !important;
            }

            .zone-row.validating {
                background: var(--success) !important;
                color: white;
                animation: pulse 0.5s ease-in-out;
            }

            @keyframes pulse {
                0% { transform: scale(1); }
                50% { transform: scale(1.02); }
                100% { transform: scale(1); }
            }

            /* Styles pour les champs de saisie dans les zones */
            .zone-input, .zone-select {
                width: 100%;
                padding: 0.5rem;
                border: 1px solid var(--gray-300);
                border-radius: 0.375rem;
                font-size: 0.9rem;
                transition: all 0.2s ease;
            }

            .zone-input:focus, .zone-select:focus {
                border-color: var(--primary-blue);
                box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1);
                outline: none;
            }

            .zone-input[readonly] {
                background: var(--gray-100);
                color: var(--gray-600);
                cursor: not-allowed;
            }

            /* Styles spécifiques pour le champ des heures */
            .zone-hours-input {
                font-weight: 600;
                background: var(--gray-50);
                border: 2px solid var(--primary-blue);
                color: var(--primary-blue);
            }

            .zone-hours-input:focus {
                background: white;
                border-color: var(--primary-blue);
                box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
                color: var(--gray-900);
            }

            .zone-hours-input:hover {
                background: white;
                border-color: var(--primary-blue);
            }

            /* Styles pour les boutons d'action */
            .action-btn {
                transition: all 0.2s ease;
            }

            .action-btn:hover {
                transform: scale(1.1);
                box-shadow: var(--shadow-md);
            }

            .action-btn:active {
                transform: scale(0.95);
            }

            /* Styles pour les groupes de cases à cocher */
            .checkbox-group {
                display: flex;
                flex-direction: column;
                gap: 0.5rem;
            }

            .checkbox-label {
                font-size: 0.8rem;
                font-weight: 600;
                color: var(--gray-700);
                margin-bottom: 0.25rem;
            }

            .checkbox-container {
                display: flex;
                flex-wrap: wrap;
                gap: 0.5rem;
                max-height: 60px;
                overflow-y: auto;
                padding: 0.25rem;
                border: 1px solid var(--gray-200);
                border-radius: 0.375rem;
                background: var(--gray-50);
            }

            .checkbox-item-small {
                display: flex;
                align-items: center;
                gap: 0.25rem;
                padding: 0.25rem 0.5rem;
                background: white;
                border: 1px solid var(--gray-300);
                border-radius: 0.25rem;
                cursor: pointer;
                font-size: 0.75rem;
                transition: all 0.2s ease;
                white-space: nowrap;
            }

            .checkbox-item-small:hover {
                background: var(--primary-blue);
                color: white;
                border-color: var(--primary-blue);
            }

            .checkbox-item-small input[type="checkbox"] {
                margin: 0;
                width: 14px;
                height: 14px;
                accent-color: var(--primary-blue);
            }

            .checkbox-item-small input[type="checkbox"]:checked + span {
                font-weight: 600;
            }

            .checkbox-item-small:has(input:checked) {
                background: var(--success);
                color: white;
                border-color: var(--success);
            }

            .checkbox-item-small:has(input:checked):hover {
                background: var(--success);
                color: white;
            }

            /* Styles pour les cases à cocher agrandies */
            .checkbox-item-large {
                display: flex;
                align-items: center;
                gap: 0.5rem;
                padding: 0.75rem 1rem;
                background: white;
                border: 2px solid var(--gray-300);
                border-radius: 0.5rem;
                cursor: pointer;
                font-size: 0.9rem;
                font-weight: 500;
                transition: all 0.2s ease;
                white-space: nowrap;
                min-height: 44px;
                justify-content: center;
                text-align: center;
            }

            .checkbox-item-large:hover {
                background: var(--primary-blue);
                color: white;
                border-color: var(--primary-blue);
                transform: translateY(-1px);
                box-shadow: var(--shadow-md);
            }

            .checkbox-item-large input[type="checkbox"] {
                margin: 0;
                width: 18px;
                height: 18px;
                accent-color: var(--primary-blue);
            }

            .checkbox-item-large input[type="checkbox"]:checked + span {
                font-weight: 700;
            }

            .checkbox-item-large:has(input:checked) {
                background: var(--success);
                color: white;
                border-color: var(--success);
                box-shadow: var(--shadow-sm);
            }

            .checkbox-item-large:has(input:checked):hover {
                background: var(--success);
                color: white;
                transform: translateY(-1px);
                box-shadow: var(--shadow-md);
            }

            /* Conteneur agrandi pour les cases */
            .checkbox-container {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
                gap: 0.75rem;
                padding: 0.75rem;
                border: 1px solid var(--gray-200);
                border-radius: 0.5rem;
                background: var(--gray-50);
                min-height: 80px;
            }
        `;
        document.head.appendChild(style);

        // ===== FONCTIONS PRINCIPALES DE GESTION DES ZONES =====

        // Ajouter une nouvelle zone
        function addNewZone() {
            const tableBody = document.getElementById('zones-table-body');
            
            // Vérifier s'il y a déjà des zones vides
            const existingRows = tableBody.querySelectorAll('.zone-row');
            const hasEmptyRow = Array.from(existingRows).some(row => {
                const nameInput = row.querySelector('.zone-name-input');
                const surfaceInput = row.querySelector('.zone-surface-input');
                return !nameInput.value.trim() && !surfaceInput.value.trim();
            });
            
            if (hasEmptyRow) {
                showNotification('Veuillez d\'abord remplir la zone vide existante', 'warning');
                return;
            }

            const newRow = createZoneRow();
            tableBody.appendChild(newRow);
            
            // Animation d'entrée
            newRow.classList.add('new-zone');
            setTimeout(() => newRow.classList.remove('new-zone'), 500);
            
            // Focus sur le premier champ
            const firstInput = newRow.querySelector('.zone-name-input');
            setTimeout(() => firstInput.focus(), 100);
            
            showNotification('Nouvelle zone ajoutée', 'success');
            autoSave();
        }

        // Créer une ligne de zone
        function createZoneRow() {
            const row = document.createElement('div');
            row.className = 'zone-row';
            row.style.cssText = `
                display: grid; 
                grid-template-columns: 1.5fr 1.5fr 1fr 1fr 1fr 1fr 1fr 100px; 
                gap: 1rem; 
                padding: 1rem 1.5rem; 
                border-bottom: 1px solid var(--gray-200); 
                align-items: center;
                background: var(--white);
                transition: background-color 0.2s ease;
            `;
            row.innerHTML = `
                <div>
                    <input type="text" class="zone-input zone-name-input" placeholder="Zone ${zoneCounter}" 
                           oninput="autoSave(); syncZones();" data-field="name">
                </div>
                <div class="checkbox-group">
                    <div class="checkbox-container">
                        <label class="checkbox-item-large">
                            <input type="checkbox" value="peinture" data-field="travaux" onchange="handleCheckboxChange(this); autoSave()">
                            <span>Peinture</span>
                        </label>
                        <label class="checkbox-item-large">
                            <input type="checkbox" value="sablage" data-field="travaux" onchange="handleCheckboxChange(this); autoSave()">
                            <span>Sablage</span>
                        </label>
                        <label class="checkbox-item-large">
                            <input type="checkbox" value="granaillage" data-field="travaux" onchange="handleCheckboxChange(this); autoSave()">
                            <span>Granaillage</span>
                        </label>
                        <label class="checkbox-item-large">
                            <input type="checkbox" value="nettoyage-hp" data-field="travaux" onchange="handleCheckboxChange(this); autoSave()">
                            <span>Nettoyage HP</span>
                        </label>
                        <label class="checkbox-item-large">
                            <input type="checkbox" value="rincage" data-field="travaux" onchange="handleCheckboxChange(this); autoSave()">
                            <span>Rinçage</span>
                        </label>
                        <label class="checkbox-item-large">
                            <input type="checkbox" value="protection" data-field="travaux" onchange="handleCheckboxChange(this); autoSave()">
                            <span>Protection</span>
                        </label>
                        <label class="checkbox-item-large">
                            <input type="checkbox" value="degraissage" data-field="travaux" onchange="handleCheckboxChange(this); autoSave()">
                            <span>Dégraissage</span>
                        </label>
                        <label class="checkbox-item-large">
                            <input type="checkbox" value="autres" data-field="travaux" onchange="handleCheckboxChange(this); autoSave()">
                            <span>Autres</span>
                        </label>
                    </div>
                    <input type="text" class="zone-input zone-travaux-other" placeholder="Préciser les autres travaux..." 
                           style="margin-top: 0.5rem; display: none;" data-field="travauxOther">
                </div>
                <div class="checkbox-group">
                    <div class="checkbox-container">
                        <label class="checkbox-item-large">
                            <input type="checkbox" value="acier" data-field="type" onchange="handleCheckboxChange(this); autoSave()">
                            <span>Acier</span>
                        </label>
                        <label class="checkbox-item-large">
                            <input type="checkbox" value="beton" data-field="type" onchange="handleCheckboxChange(this); autoSave()">
                            <span>Béton</span>
                        </label>
                        <label class="checkbox-item-large">
                            <input type="checkbox" value="galva" data-field="type" onchange="handleCheckboxChange(this); autoSave()">
                            <span>Galva</span>
                        </label>
                        <label class="checkbox-item-large">
                            <input type="checkbox" value="autres" data-field="type" onchange="handleCheckboxChange(this); autoSave()">
                            <span>Autres</span>
                        </label>
                    </div>
                    <input type="text" class="zone-input zone-type-other" placeholder="Préciser..." 
                           style="margin-top: 0.5rem; display: none;" data-field="typeOther">
                </div>
                <div class="checkbox-group">
                    <div class="checkbox-container">
                        <label class="checkbox-item-large">
                            <input type="checkbox" value="mur" data-field="surfaceType" onchange="handleCheckboxChange(this); autoSave()">
                            <span>Mur</span>
                        </label>
                        <label class="checkbox-item-large">
                            <input type="checkbox" value="plafond" data-field="surfaceType" onchange="handleCheckboxChange(this); autoSave()">
                            <span>Plafond</span>
                        </label>
                        <label class="checkbox-item-large">
                            <input type="checkbox" value="sol" data-field="surfaceType" onchange="handleCheckboxChange(this); autoSave()">
                            <span>Sol</span>
                        </label>
                        <label class="checkbox-item-large">
                            <input type="checkbox" value="autre" data-field="surfaceType" onchange="handleCheckboxChange(this); autoSave()">
                            <span>Autre</span>
                        </label>
                    </div>
                </div>
                <div>
                    <input type="number" step="0.01" class="zone-input surface-input zone-surface-input" 
                           placeholder="0.00" oninput="updateCalculations(); autoSave()" data-field="surface">
                </div>
                <div>
                    <input type="number" step="1" min="1" max="10" class="zone-input operators-input zone-operators-input" 
                           placeholder="1" value="1" oninput="updateCalculations(); autoSave()" data-field="operators" title="Nombre d'opérateurs (8.5h/jour chacun)">
                </div>
                <div style="display: flex; align-items: center; gap: 0.75rem; justify-content: center;">
                    <input type="number" step="0.5" class="zone-input hours-input zone-hours-input" 
                           placeholder="0" oninput="updateCalculations(); autoSave()" data-field="hours" title="Heures ajustables manuellement" style="flex: 1; min-width: 80px; padding: 0.75rem; font-size: 1rem; text-align: center;">
                    <button type="button" onclick="recalculateHours(this)" title="Recalculer automatiquement (opérateurs × 8.5h)" style="background: var(--primary-blue); color: white; border: none; border-radius: 0.375rem; padding: 0.5rem; cursor: pointer; font-size: 0.9rem; min-width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; transition: all 0.2s ease;">
                        🔄
                    </button>
                </div>
                <div class="zone-actions" style="display: flex; justify-content: center; gap: 0.5rem;">
                    <button class="action-btn validate" onclick="validateZone(this)" title="Valider cette zone" style="background: var(--success); color: white; border: none; border-radius: 50%; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 0.9rem;">
                        ✅
                    </button>
                    <button class="action-btn delete" onclick="deleteZone(this)" title="Supprimer cette zone" style="background: var(--danger); color: white; border: none; border-radius: 50%; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 0.9rem;">
                        🗑️
                    </button>
                </div>
            `;
            
            zoneCounter++;
            return row;
        }

        // Valider une zone
        function validateZone(button) {
            const row = button.closest('.zone-row');
            const zoneData = extractZoneData(row);
            
            // Validation
            if (!zoneData.name || !zoneData.surface || !zoneData.hours) {
                showNotification('Veuillez remplir au minimum le nom, la surface et les heures', 'error');
                return;
            }
            
            if (zoneData.surface <= 0 || zoneData.hours <= 0) {
                showNotification('La surface et les heures doivent être supérieures à 0', 'error');
                return;
            }

            // Animation de validation
            row.classList.add('validating');
            
            setTimeout(() => {
                // Créer l'objet zone validée
                const validatedZone = {
                    id: Date.now(),
                    ...zoneData,
                    validatedAt: new Date().toISOString()
                };

                // Ajouter à la liste des zones validées
                validatedZones.push(validatedZone);

                // Mettre à jour l'affichage
                updateValidatedZonesDisplay();
                
                // Supprimer la ligne
                row.remove();
                
                // Ajouter une nouvelle ligne vide
                addNewZone();
                
                // Mettre à jour les calculs
                updateCalculations();
                
                // Sauvegarder
                autoSave();
                
                showNotification(`Zone "${zoneData.name}" validée avec succès !`, 'success');
            }, 600);
        }

        // Supprimer une zone
        function deleteZone(button) {
            if (confirm('Êtes-vous sûr de vouloir supprimer cette zone ?')) {
                const row = button.closest('.zone-row');
                row.remove();
                updateCalculations();
                autoSave();
                showNotification('Zone supprimée', 'info');
            }
        }

        // Extraire les données d'une zone
        function extractZoneData(row) {
            // Extraire les valeurs des cases à cocher
            const getCheckboxValues = (field) => {
                const checkboxes = row.querySelectorAll(`input[data-field="${field}"]:checked`);
                return Array.from(checkboxes).map(cb => cb.value);
            };

            return {
                name: row.querySelector('.zone-name-input').value.trim(),
                travaux: getCheckboxValues('travaux'),
                travauxOther: row.querySelector('.zone-travaux-other').value.trim(),
                type: getCheckboxValues('type'),
                typeOther: row.querySelector('.zone-type-other').value.trim(),
                surfaceType: getCheckboxValues('surfaceType'),
                surface: parseFloat(row.querySelector('.zone-surface-input').value) || 0,
                operators: parseInt(row.querySelector('.zone-operators-input').value) || 1,
                hours: parseFloat(row.querySelector('.zone-hours-input').value) || 0
            };
        }

        // ===== FONCTIONS DE MISE À JOUR ET CALCULS =====

        // Mettre à jour l'affichage des zones validées
        function updateValidatedZonesDisplay() {
            const count = validatedZones.length;
            
            if (count > 0) {
                const totalSurface = validatedZones.reduce((sum, zone) => sum + (zone.surface || 0), 0);
                const totalHours = validatedZones.reduce((sum, zone) => sum + (zone.hours || 0), 0);
                
                // Mettre à jour le récapitulatif détaillé
                document.getElementById('nb-zones-validees').textContent = count;
                document.getElementById('surface-validees').textContent = totalSurface.toFixed(2) + ' m²';
                document.getElementById('heures-validees').textContent = totalHours + ' h';
                
                // Afficher la liste compacte des zones validées
                updateValidatedZonesList();
                
                // Mettre à jour la planification des ressources
                updatePlanificationDisplay();
                
                // Mettre à jour la sélection de zones dans l'onglet matériaux
                updateZoneSelection();
            } else {
                document.getElementById('nb-zones-validees').textContent = '0';
                document.getElementById('surface-validees').textContent = '0.00 m²';
                document.getElementById('heures-validees').textContent = '0 h';
                
                // Mettre à jour la planification des ressources
                updatePlanificationDisplay();
                
                // Mettre à jour la sélection de zones dans l'onglet matériaux
                updateZoneSelection();
            }
        }

        // Mettre à jour la planification des ressources
        function updatePlanificationDisplay() {
            const totalHeures = validatedZones.reduce((sum, zone) => sum + (zone.hours || 0), 0);
            const maxOperateurs = Math.max(...validatedZones.map(zone => zone.operators || 1), 0);
            const heuresParJour = 8.5;
            const joursHomme = totalHeures / heuresParJour;
            const dureeEstimee = maxOperateurs > 0 ? Math.ceil(totalHeures / (maxOperateurs * heuresParJour)) : 0;
            
            // Mettre à jour les éléments d'affichage
            document.getElementById('total-heures-planification').textContent = totalHeures.toFixed(1);
            document.getElementById('jours-homme-planification').textContent = joursHomme.toFixed(1);
            document.getElementById('duree-estimee-planification').textContent = dureeEstimee;
            
            // Mettre à jour le détail du calcul
            const detailElement = document.getElementById('detail-calcul-planification');
            if (validatedZones.length > 0) {
                detailElement.textContent = `${validatedZones.length} zone(s) • ${maxOperateurs} opérateur(s) max • ${heuresParJour}h/jour`;
            } else {
                detailElement.textContent = 'Aucune zone validée';
            }
        }

        // Mettre à jour la liste compacte des zones validées
        function updateValidatedZonesList() {
            const listeElement = document.getElementById('zones-validees-liste');
            const itemsContainer = document.getElementById('zones-validees-items');
            
            if (validatedZones.length > 0) {
                listeElement.style.display = 'block';
                
                itemsContainer.innerHTML = '';
                validatedZones.forEach((zone, index) => {
                    // Gérer les tableaux de valeurs des cases à cocher
                    const surfaceTypeText = Array.isArray(zone.type) ? zone.type.join(', ') : (zone.type === 'autres' ? zone.typeOther : zone.type);
                    const travauxText = Array.isArray(zone.travaux) ? zone.travaux.join(', ') : (zone.travaux === 'autres' ? zone.travauxOther : zone.travaux);
                    const surfaceLocationText = Array.isArray(zone.surfaceType) ? zone.surfaceType.join(', ') : (zone.surfaceType || 'N/A');
                    
                    const zoneItem = document.createElement('div');
                    zoneItem.className = 'zone-item';
                    zoneItem.dataset.zoneId = zone.id;
                    zoneItem.style.cssText = `
                        background: white; 
                        padding: 1rem; 
                        border-radius: 0.75rem; 
                        border: 1px solid var(--gray-200); 
                        box-shadow: var(--shadow-sm);
                        transition: all 0.3s ease;
                    `;
                    
                    zoneItem.innerHTML = `
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div style="flex: 1;">
                                <div style="display: grid; grid-template-columns: 1.5fr 1fr 1fr 1fr 1fr 1fr 1fr; gap: 1rem; align-items: center; font-size: 0.9rem;">
                                    <div style="font-weight: 600; color: var(--gray-900);">${zone.name}</div>
                                    <div style="color: var(--primary-orange); font-weight: 500;">${travauxText || 'N/A'}</div>
                                    <div style="color: var(--primary-blue); font-weight: 500;">${surfaceTypeText || 'N/A'}</div>
                                    <div style="color: var(--success); font-weight: 500;">${surfaceLocationText}</div>
                                    <div style="color: var(--primary-red); font-weight: 600; text-align: center;">${zone.surface.toFixed(2)} m²</div>
                                    <div style="color: var(--warning); font-weight: 600; text-align: center;">${zone.operators || 1} op.</div>
                                    <div style="color: var(--primary-blue); font-weight: 600; text-align: center;">${zone.hours} h</div>
                                </div>
                            </div>
                            <div class="zone-actions" style="display: none; margin-left: 1rem; gap: 0.5rem;">
                                <button class="btn btn-info btn-small" onclick="editZone(${zone.id})" style="padding: 0.5rem; border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; font-size: 1rem;" title="Modifier cette zone">
                                    ✏️
                                </button>
                                <button class="btn btn-danger btn-small" onclick="deleteValidatedZone(${zone.id})" style="padding: 0.5rem; border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; font-size: 1rem;" title="Supprimer cette zone">
                                    🗑️
                                </button>
                            </div>
                        </div>
                    `;
                    
                    // Ajouter effet hover
                    zoneItem.addEventListener('mouseenter', function() {
                        this.style.transform = 'translateY(-2px)';
                        this.style.boxShadow = 'var(--shadow-md)';
                    });
                    
                    zoneItem.addEventListener('mouseleave', function() {
                        this.style.transform = 'translateY(0)';
                        this.style.boxShadow = 'var(--shadow-sm)';
                    });
                    
                    itemsContainer.appendChild(zoneItem);
                });
            } else {
                listeElement.style.display = 'block';
                itemsContainer.innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: var(--gray-500); font-style: italic;">
                        <div style="font-size: 2rem; margin-bottom: 0.5rem;">📝</div>
                        <div>Aucune zone validée pour le moment</div>
                        <div style="font-size: 0.8rem; margin-top: 0.5rem;">Validez des zones dans le tableau ci-dessus pour les voir apparaître ici</div>
                    </div>
                `;
            }
        }

        // Mettre à jour tous les calculs
        function updateCalculations() {
            // Calculer automatiquement les heures pour chaque zone basé sur le nombre d'opérateurs
            // Seulement si le champ heures est vide ou contient la valeur calculée précédente
            document.querySelectorAll('.zone-row').forEach(row => {
                const operatorsInput = row.querySelector('.zone-operators-input');
                const hoursInput = row.querySelector('.zone-hours-input');
                
                if (operatorsInput && hoursInput) {
                    const operators = parseInt(operatorsInput.value) || 1;
                    const hoursPerOperator = 8.5; // 8.5 heures par jour par opérateur
                    const calculatedHours = operators * hoursPerOperator;
                    const currentHours = parseFloat(hoursInput.value) || 0;
                    
                    // Mettre à jour seulement si le champ est vide ou contient la valeur calculée précédente
                    if (currentHours === 0 || Math.abs(currentHours - calculatedHours) < 0.1) {
                        hoursInput.value = calculatedHours;
                    }
                }
            });
            
            updateValidatedZonesDisplay();
            updateTotalSurface();
            updateHoursAndDays();
        }

        // Vider toutes les zones validées
        function clearAllValidatedZones() {
            if (validatedZones.length === 0) {
                showNotification('Aucune zone validée à supprimer', 'info');
                return;
            }
            
            if (confirm(`Êtes-vous sûr de vouloir supprimer toutes les ${validatedZones.length} zones validées ?`)) {
                validatedZones = [];
                updateValidatedZonesDisplay();
                updateCalculations();
                autoSave();
                showNotification('Toutes les zones validées ont été supprimées', 'success');
            }
        }

        // Variable pour gérer l'état du mode édition
        let editModeActive = false;

        // Basculer le mode édition des zones validées
        function toggleZonesEditMode() {
            editModeActive = !editModeActive;
            const button = document.querySelector('button[onclick="toggleZonesEditMode()"]');
            const actionButtons = document.querySelectorAll('.zone-actions');
            
            if (editModeActive) {
                // Activer le mode édition
                button.innerHTML = '✅ Quitter le mode édition';
                button.style.background = 'var(--success)';
                button.style.color = 'white';
                
                // Afficher les boutons d'action
                actionButtons.forEach(actions => {
                    actions.style.display = 'flex';
                });
                
                showNotification('Mode édition activé - Cliquez sur les boutons d\'action pour modifier ou supprimer les zones', 'info');
            } else {
                // Désactiver le mode édition
                button.innerHTML = '✏️ Mode édition';
                button.style.background = 'var(--warning)';
                button.style.color = 'var(--gray-900)';
                
                // Masquer les boutons d'action
                actionButtons.forEach(actions => {
                    actions.style.display = 'none';
                });
                
                showNotification('Mode édition désactivé', 'info');
            }
        }

        // Modifier une zone validée
        function editZone(zoneId) {
            const zone = validatedZones.find(z => z.id === zoneId);
            if (!zone) {
                showNotification('Zone non trouvée', 'error');
                return;
            }
            
            // Créer un modal de modification
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                background: rgba(0,0,0,0.5); z-index: 1000; display: flex; 
                align-items: center; justify-content: center;
            `;
            
            modal.innerHTML = `
                <div style="background: white; border-radius: 1rem; padding: 2rem; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto;">
                    <h3 style="margin-bottom: 1.5rem; color: var(--primary-red);">✏️ Modifier la zone: ${zone.name}</h3>
                    
                    <div class="form-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                        <div class="form-group">
                            <label class="form-label required">Nom de la zone</label>
                            <input type="text" class="form-input" id="edit-zone-name" value="${zone.name}" style="width: 100%;">
                        </div>
                        <div class="form-group">
                            <label class="form-label required">Surface (m²)</label>
                            <input type="number" class="form-input" id="edit-zone-surface" value="${zone.surface}" step="0.01" min="0" style="width: 100%;">
                        </div>
                    </div>
                    
                    <div class="form-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                        <div class="form-group">
                            <label class="form-label required">Type de surface</label>
                            <select class="form-select" id="edit-zone-type" style="width: 100%;">
                                <option value="mur" ${zone.type === 'mur' ? 'selected' : ''}>Mur</option>
                                <option value="plafond" ${zone.type === 'plafond' ? 'selected' : ''}>Plafond</option>
                                <option value="sol" ${zone.type === 'sol' ? 'selected' : ''}>Sol</option>
                                <option value="autres" ${zone.type === 'autres' ? 'selected' : ''}>Autres</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label required">Type de travaux</label>
                            <select class="form-select" id="edit-zone-travaux" style="width: 100%;">
                                <option value="nettoyage" ${zone.travaux === 'nettoyage' ? 'selected' : ''}>Nettoyage</option>
                                <option value="preparation" ${zone.travaux === 'preparation' ? 'selected' : ''}>Préparation</option>
                                <option value="peinture" ${zone.travaux === 'peinture' ? 'selected' : ''}>Peinture</option>
                                <option value="autres" ${zone.travaux === 'autres' ? 'selected' : ''}>Autres</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 1.5rem;">
                        <label class="form-label">Heures prévues</label>
                        <input type="number" class="form-input" id="edit-zone-hours" value="${zone.hours}" step="0.5" min="0" style="width: 200px;">
                    </div>
                    
                    <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                        <button class="btn btn-secondary" onclick="closeEditModal()" style="padding: 0.75rem 1.5rem;">Annuler</button>
                        <button class="btn btn-success" onclick="saveZoneEdit(${zoneId})" style="padding: 0.75rem 1.5rem;">💾 Sauvegarder</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Gérer la fermeture du modal
            window.closeEditModal = function() {
                document.body.removeChild(modal);
                delete window.closeEditModal;
                delete window.saveZoneEdit;
            };
            
            // Gérer la sauvegarde
            window.saveZoneEdit = function(id) {
                const name = document.getElementById('edit-zone-name').value.trim();
                const surface = parseFloat(document.getElementById('edit-zone-surface').value);
                const type = document.getElementById('edit-zone-type').value;
                const travaux = document.getElementById('edit-zone-travaux').value;
                const hours = parseFloat(document.getElementById('edit-zone-hours').value);
                
                if (!name || !surface || surface <= 0) {
                    showNotification('Veuillez remplir tous les champs obligatoires avec des valeurs valides', 'error');
                    return;
                }
                
                // Mettre à jour la zone
                const zoneIndex = validatedZones.findIndex(z => z.id === id);
                if (zoneIndex !== -1) {
                    validatedZones[zoneIndex] = {
                        ...validatedZones[zoneIndex],
                        name: name,
                        surface: surface,
                        type: type,
                        travaux: travaux,
                        hours: hours
                    };
                    
                    updateValidatedZonesDisplay();
                    updateValidatedZonesList();
                    updateCalculations();
                    autoSave();
                    
                    showNotification('Zone modifiée avec succès', 'success');
                    closeEditModal();
                }
            };
        }

        // Supprimer une zone validée
        function deleteValidatedZone(zoneId) {
            const zone = validatedZones.find(z => z.id === zoneId);
            if (!zone) {
                showNotification('Zone non trouvée', 'error');
                return;
            }
            
            if (confirm(`Êtes-vous sûr de vouloir supprimer la zone "${zone.name}" ?`)) {
                validatedZones = validatedZones.filter(z => z.id !== zoneId);
                updateValidatedZonesDisplay();
                updateValidatedZonesList();
                updateCalculations();
                autoSave();
                showNotification(`Zone "${zone.name}" supprimée avec succès`, 'success');
            }
        }

        // Gérer le changement de type de surface
        function handleSurfaceTypeChange(selectElement) {
            const otherInput = selectElement.parentElement.querySelector('.zone-type-other');
            if (otherInput) {
                otherInput.style.display = (selectElement.value === 'autres') ? 'block' : 'none';
                if (selectElement.value !== 'autres') {
                    otherInput.value = '';
                }
            }
        }

        // Gérer le changement de type de surface (mur, plafond, sol, autre)
        function handleSurfaceLocationChange(selectElement) {
            // Cette fonction peut être étendue si nécessaire
            autoSave();
        }

        // Recalculer les heures automatiquement pour une zone
        function recalculateHours(button) {
            const row = button.closest('.zone-row');
            const operatorsInput = row.querySelector('.zone-operators-input');
            const hoursInput = row.querySelector('.zone-hours-input');
            
            if (operatorsInput && hoursInput) {
                const operators = parseInt(operatorsInput.value) || 1;
                const hoursPerOperator = 8.5; // 8.5 heures par jour par opérateur
                const calculatedHours = operators * hoursPerOperator;
                
                hoursInput.value = calculatedHours;
                
                // Animation de feedback
                button.style.background = 'var(--success)';
                setTimeout(() => {
                    button.style.background = 'var(--primary-blue)';
                }, 300);
                
                showNotification(`Heures recalculées: ${calculatedHours}h (${operators} opérateur${operators > 1 ? 's' : ''} × 8.5h)`, 'success');
                autoSave();
            }
        }

        // Gérer les changements des cases à cocher
        function handleCheckboxChange(checkbox) {
            const field = checkbox.dataset.field;
            const value = checkbox.value;
            const row = checkbox.closest('.zone-row');
            
            // Gérer l'affichage des champs "autres"
            if (value === 'autres') {
                const otherInput = row.querySelector(`.zone-${field}-other`);
                if (otherInput) {
                    otherInput.style.display = checkbox.checked ? 'block' : 'none';
                    if (!checkbox.checked) {
                        otherInput.value = '';
                    }
                }
            }
            
            // Mettre à jour les calculs
            updateCalculations();
        }

        // Gérer le changement de type de travaux
        function handleTravauxChange(selectElement) {
            const otherInput = selectElement.parentElement.querySelector('.zone-travaux-other');
            if (otherInput) {
                otherInput.style.display = (selectElement.value === 'autres') ? 'block' : 'none';
                if (selectElement.value !== 'autres') {
                    otherInput.value = '';
                }
            }
        }

        // Gérer le changement de mode de saisie
        function handleModeChange() {
            const modeInputs = document.querySelectorAll('input[name="surface-mode"]');
            modeInputs.forEach(input => {
                const label = input.closest('.mode-option');
                if (input.checked) {
                    label.style.background = 'var(--success)';
                    label.style.color = 'white';
                    label.style.fontWeight = '600';
                } else {
                    label.style.background = 'var(--gray-200)';
                    label.style.color = 'var(--gray-700)';
                    label.style.fontWeight = '500';
                }
            });
        }

        // Afficher l'état vide si nécessaire
        function checkEmptyState() {
            const tableBody = document.getElementById('zones-table-body');
            const rows = tableBody.querySelectorAll('.zone-row');
            
            if (rows.length === 0) {
                tableBody.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">📝</div>
                        <div class="empty-state-text">Aucune zone ajoutée</div>
                        <div class="empty-state-subtext">Cliquez sur "Nouvelle Zone" pour commencer</div>
                    </div>
                `;
            }
        }

        function clearValidatedZones() {
            if (confirm('Êtes-vous sûr de vouloir vider toutes les zones validées ?')) {
                validatedZones = [];
                document.getElementById('zones-validees-resume').style.display = 'none';
                document.getElementById('zones-validees-liste').style.display = 'none';
                
                // Mettre à jour les affichages
                document.getElementById('zones-validees-count').textContent = '0';
                document.getElementById('zones-validees-surface').textContent = '0.00';
                document.getElementById('zones-validees-heures').textContent = '0';
                document.getElementById('nb-zones-validees').textContent = '0';
                document.getElementById('surface-validees').textContent = '0.00 m²';
                document.getElementById('heures-validees').textContent = '0 h';
                
                updateTotalSurface();
                updateHoursAndDays();
                autoSave();
                showNotification('Zones validées supprimées', 'success');
            }
        }

        function calculateMaterialCosts() {
            let totalCost = 0;
            const zones = document.querySelectorAll('#zones-peinture-container .zone-peinture');
            
            zones.forEach(zone => {
                const surface = parseFloat(zone.dataset.surface) || 0;
                if (surface > 0) {
                    const layers = zone.querySelectorAll('.collapsible-content');
                    layers.forEach(layer => {
                        const rendement = parseFloat(layer.querySelector('input[placeholder*="Rendement"]')?.value) || 0;
                        const prix = parseFloat(layer.querySelector('input[placeholder*="Prix"]')?.value) || 0;

                        if (rendement > 0 && prix > 0) {
                            const quantite = surface / rendement;
                            totalCost += quantite * prix;
                        }
                    });
                }
            });
            projectData.couts.materiaux = totalCost;
        }

        function updateCostBreakdown() {
            calculateMaterialCosts();
            const totalHeures = projectData.surfaces.heures;
            const tauxHoraire = 35; // Taux horaire fixe
            const coutsFixes = 0; // Coûts fixes à zéro

            const coutMainOeuvre = totalHeures * tauxHoraire;
            
            const coutTotal = projectData.couts.materiaux + coutMainOeuvre + coutsFixes;

            projectData.couts.mainOeuvre = coutMainOeuvre;
            projectData.couts.fixes = coutsFixes;
            projectData.couts.total = coutTotal;
        }

        document.addEventListener('input', function(e) {
            if (e.target.matches('.form-input, .form-select, .form-textarea')) {
                setTimeout(() => {
                    updateCostBreakdown();
                    autoSave();
                }, 100);
            }
        });

        function autoSave() {
            console.log('autoSave appelé');
            showAutoSaveIndicator();
            const dataToSave = {
                ...projectData,
                validatedZones: validatedZones
            };
            localStorage.setItem('travaux_materiaux_data_v2', JSON.stringify(dataToSave));
            setTimeout(hideAutoSaveIndicator, 2000);
        }

        function showAutoSaveIndicator() { document.getElementById('auto-save-indicator').classList.add('show'); }
        function hideAutoSaveIndicator() { document.getElementById('auto-save-indicator').classList.remove('show'); }
        
        function exportData() {
            const blob = new Blob([JSON.stringify({ ...projectData, metadata: { exportDate: new Date().toISOString() } }, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `travaux_materiaux_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showNotification('Données exportées', 'success');
        }

        function saveAll() { autoSave(); showNotification('Toutes les données sauvegardées', 'success'); }
        
        function showNotification(message, type) {
            const notif = document.createElement('div');
            notif.style.cssText = `position: fixed; top: 2rem; right: 2rem; z-index: 3000; padding: 1rem 1.5rem; border-radius: 0.5rem; color: white; background: ${type === 'success' ? 'var(--success)' : 'var(--info)'}; box-shadow: var(--shadow-lg); transform: translateX(100%); transition: transform 0.3s ease;`;
            notif.textContent = message;
            document.body.appendChild(notif);
            setTimeout(() => { notif.style.transform = 'translateX(0)'; }, 100);
            setTimeout(() => { notif.style.transform = 'translateX(100%)'; setTimeout(() => { if (document.body.contains(notif)) document.body.removeChild(notif); }, 300); }, 3000);
        }

        setInterval(autoSave, 30000);
        
        function setupAtelierLogic() {
            document.querySelectorAll('input[name="atelier-choice"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    document.getElementById('atelier-details-form').style.display = (this.value === 'oui') ? 'block' : 'none';
                });
            });
            const nbPiecesInput = document.getElementById('atelier-nb-pieces');
            const prixPieceInput = document.getElementById('atelier-prix-piece');
            const totalInput = document.getElementById('atelier-total');
            function calculateAtelierTotal() {
                const total = (parseFloat(nbPiecesInput.value) || 0) * (parseFloat(prixPieceInput.value) || 0);
                totalInput.value = total.toLocaleString('fr-FR', { style: 'currency', currency: 'EUR' });
            }
            nbPiecesInput.addEventListener('input', calculateAtelierTotal);
            prixPieceInput.addEventListener('input', calculateAtelierTotal);
        }

        function generateAndPrintSummary() {
            generateResumeContent(); // Ensure content is up to date
            const content = document.getElementById('resume-display-area').innerHTML;
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html><html lang="fr"><head><meta charset="UTF-8"><title>Résumé du Chantier</title>
                <style>
                    body { font-family: 'Segoe UI', sans-serif; margin: 20mm; color: #333; }
                    h4,h5 { color: #dc2626; border-bottom: 2px solid #f3f4f6; padding-bottom: 5px; margin-top: 1.5rem; margin-bottom: 1rem; }
                    h5 { font-size: 1.1em; color: #111827; border-bottom-style: dashed; }
                    table { width: 100%; border-collapse: collapse; margin-top: 1rem; font-size: 9pt; page-break-inside: auto; }
                    tr { page-break-inside: avoid; page-break-after: auto; }
                    th, td { border: 1px solid #d1d5db; padding: 6px; text-align: left; }
                    th { background-color: #f3f4f6; font-weight: 600; }
                    p { margin: 0.2rem 0; font-size: 10pt; }
                    strong { color: #111827; }
                </style>
                </head><body>${content}</body></html>
            `);
            printWindow.document.close();
            setTimeout(() => { printWindow.print(); }, 500);
        }

        function exportToWord() {
            generateResumeContent(); // Ensure content is up to date
            const content = document.getElementById('resume-display-area').innerHTML;
            const header = "<html xmlns:o='urn:schemas-microsoft-com:office:office' "+
                "xmlns:w='urn:schemas-microsoft-com:office:word' "+
                "xmlns='http://www.w3.org/TR/REC-html40'>"+
                "<head><meta charset='utf-8'><title>Résumé Chantier</title></head><body>";
            const footer = "</body></html>";
            const sourceHTML = header + content + footer;

            const source = 'data:application/vnd.ms-word;charset=utf-8,' + encodeURIComponent(sourceHTML);
            const fileDownload = document.createElement("a");
            document.body.appendChild(fileDownload);
            fileDownload.href = source;
            const fileName = (document.getElementById('nom-chantier').value || 'Resume_Chantier') + '.doc';
            fileDownload.download = fileName;
            fileDownload.click();
            document.body.removeChild(fileDownload);
        }

        // Fonction améliorée pour générer le contenu du résumé
        function generateResumeContent(){
            const container = document.getElementById('resume-display-area');
            const NA = 'N/A';
            let html = '<div class="resume-container">';
            
            // En-tête avec date de mise à jour
            html += `<div style="background: var(--primary-blue); color: white; padding: 1rem; border-radius: 0.5rem; margin-bottom: 1.5rem; text-align: center;">
                <h3 style="margin: 0; display: flex; align-items: center; justify-content: center; gap: 0.5rem;">
                    📄 Résumé Complet du Chantier
                </h3>
                <p style="margin: 0.5rem 0 0 0; opacity: 0.9; font-size: 0.9rem;">
                    Dernière mise à jour: ${new Date().toLocaleString('fr-FR')}
                </p>
            </div>`;
            
            // Informations Générales
            html += '<div class="resume-section">';
            html += '<h4 style="color: var(--primary-red); display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1rem;">ℹ️ Informations Générales</h4>';
            
            // Détails Chantier & Client
            html += `<table class="dynamic-table"><tbody>
                <tr><td style="width: 200px;"><strong>Nom du chantier</strong></td><td>${document.getElementById('nom-chantier')?.value || NA}</td></tr>
                <tr><td><strong>Numéro OTP</strong></td><td>${document.getElementById('otp-numero')?.value || NA}</td></tr>
                <tr><td><strong>Adresse Chantier</strong></td><td>${document.getElementById('adresse-chantier')?.value?.replace(/\n/g, '<br>') || NA}</td></tr>
                <tr><td><strong>Client</strong></td><td>${document.getElementById('client-societe')?.value || NA}</td></tr>
                <tr><td><strong>Responsable Client</strong></td><td>${document.getElementById('client-responsable-nom-prenom')?.value || NA}</td></tr>
                <tr><td><strong>Contact Client</strong></td><td>Tél: ${document.getElementById('client-tel')?.value || NA} / Email: ${document.getElementById('client-email')?.value || NA}</td></tr>
                <tr><td><strong>Date de démarrage</strong></td><td>${document.getElementById('date-demarrage')?.value || NA}</td></tr>
                <tr><td><strong>Date de fin</strong></td><td>${document.getElementById('date-fin')?.value || NA}</td></tr>
                <tr><td><strong>Chef de Chantier/Équipe</strong></td><td>${document.getElementById('chef-chantier')?.value || NA}</td></tr>
            </tbody></table>`;
            html += '</div>';

            // Surfaces & Heures
            html += '<h4>📏 Surfaces & Heures</h4>';
            const structureType = document.querySelector("#structure-type option:checked");
            html += `<p><strong>Type de Structure:</strong> ${structureType ? structureType.textContent : NA}</p>`;
            
            // Zones validées
            if (validatedZones.length > 0) {
                html += `<table class="dynamic-table"><thead><tr><th>Zone</th><th>Type de Travaux</th><th>Type Surface</th><th>Surface (m²)</th><th>Heures Prévues</th></tr></thead><tbody>`;
                validatedZones.forEach(zone => {
                    const surfaceTypeText = zone.type === 'autres' ? zone.typeOther : zone.type;
                    const travauxText = zone.travaux === 'autres' ? zone.travauxOther : zone.travaux;
                html += `<tr>
                        <td><strong>${zone.name}</strong></td>
                        <td>${travauxText || NA}</td>
                        <td>${surfaceTypeText || NA}</td>
                        <td>${zone.surface.toFixed(2)}</td>
                        <td>${zone.hours}</td>
                    </tr>`;
                });
                html += `</tbody></table>`;
            } else {
                // Zones en cours de saisie
                html += `<table class="dynamic-table"><thead><tr><th>Zone</th><th>Description</th><th>Type Surface</th><th>Surface (m²)</th><th>Heures Prévues</th></tr></thead><tbody>`;
                document.querySelectorAll('#surface-connue-tbody div').forEach(row => {
                    const zoneName = row.querySelector('.zone-name-connue')?.value || NA;
                    const description = row.querySelector('.zone-description')?.value || NA;
                    const surfaceType = row.querySelector('.surface-type-select')?.value || NA;
                    const surfaceTypeOther = row.querySelector('.surface-type-other')?.value || '';
                    const surface = row.querySelector('.surface-connue')?.value || '0.00';
                    const heures = row.querySelector('.heures-prevues')?.value || '0';
                    
                    const surfaceTypeText = surfaceType === 'autres' ? surfaceTypeOther : surfaceType;
                    
                    html += `<tr>
                        <td>${zoneName}</td>
                        <td>${description}</td>
                        <td>${surfaceTypeText}</td>
                        <td>${surface}</td>
                        <td>${heures}</td>
                    </tr>`;
                });
                html += `</tbody></table>`;
            }

            // Spécifications Matériaux & Peintures - Section améliorée
            html += '<div class="resume-section">';
            html += '<h4 style="color: var(--primary-red); display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1rem;">🎨 Spécifications Matériaux & Peintures</h4>';
            
            // Zone sélectionnée
            const selectedZone = document.getElementById('zone-concerned');
            if (selectedZone && selectedZone.value) {
                const zoneOption = selectedZone.querySelector(`option[value="${selectedZone.value}"]`);
                html += `<div style="background: var(--success); color: white; padding: 0.75rem; border-radius: 0.5rem; margin-bottom: 1rem;">
                    <strong>📍 Zone sélectionnée:</strong> ${zoneOption ? zoneOption.textContent : selectedZone.value}
                </div>`;
            }
            
            // Spécifications peinture
            const selectedSysteme = document.querySelector("#systeme-peinture option:checked");
            const ralValue = document.getElementById('ral')?.value;
            const selectedFournisseur = document.querySelector("#fournisseur-global option:checked");
            const systemeAutre = document.getElementById('systeme-peinture-autre')?.value;
            const fournisseurAutre = document.getElementById('fournisseur-autre-global')?.value;
            
            html += `<table class="dynamic-table"><tbody>
                <tr><td style="width: 200px;"><strong>Système Peinture</strong></td><td>${selectedSysteme ? selectedSysteme.textContent : (systemeAutre || NA)}</td></tr>
                <tr><td><strong>Code RAL</strong></td><td>${ralValue || NA}</td></tr>
                <tr><td><strong>Fournisseur</strong></td><td>${selectedFournisseur ? selectedFournisseur.textContent : (fournisseurAutre || NA)}</td></tr>
            </tbody></table>`;
            
            // Méthodes d'application
            const methods = [];
            if (document.getElementById('app-airless')?.checked) methods.push('Airless');
            if (document.getElementById('app-rouleau')?.checked) methods.push('Rouleau');
            if (document.getElementById('app-pinceaux')?.checked) methods.push('Pinceaux');
            
            if (methods.length > 0) {
                html += `<p style="margin-top: 1rem;"><strong>🖌️ Méthodes d'Application:</strong> ${methods.join(', ')}</p>`;
            }
            html += '</div>';
            
            const zones = document.querySelectorAll('#zones-peinture-container .zone-peinture');
            if (zones.length > 0) {
                zones.forEach(zone => {
                    const zoneTitle = zone.querySelector('h4 span').textContent;
                    html += `<h5>Détails pour: ${zoneTitle}</h5>`;
                    const layers = zone.querySelectorAll('.collapsible-category');
                    html += `<table class="dynamic-table"><thead><tr><th>Couche</th><th>Ref. Produit</th><th>RAL</th><th>Épaisseur (µ)</th><th>Rendement (m²/L)</th><th>Conditionnement (L)</th><th>Prix/Litre (€)</th></tr></thead><tbody>`;
                    layers.forEach(layer => {
                        const layerTitle = layer.querySelector('h5').textContent;
                        const inputs = layer.querySelectorAll('input');
                        html += `<tr>
                            <td><strong>${layerTitle}</strong></td>
                            <td>${inputs[0].value || NA}</td><td>${inputs[1].value || NA}</td>
                            <td>${inputs[2].value || NA}</td><td>${inputs[3].value || NA}</td>
                            <td>${inputs[4].value || NA}</td><td>${inputs[5].value || NA}</td>
                        </tr>`;
                    });
                    html += `</tbody></table>`;
                });
            }

            // Locations
            html += `<h4>🚚 Locations</h4>`;
            let locationHtml = '';
            
            // Location Interne
            document.querySelectorAll('#tab-location .collapsible-category:first-child .collapsible-category').forEach(cat => {
                let catRows = '';
                cat.querySelectorAll('tbody tr').forEach(row => {
                    const qty = row.querySelector('input').value;
                    if(parseInt(qty) > 0) {
                        catRows += `<tr><td>${row.cells[0].textContent}</td><td>${qty} (Interne)</td></tr>`;
                    }
                });
                if(catRows) {
                    locationHtml += `<tr><td colspan="2" style="background-color: var(--gray-50);"><strong>${cat.querySelector('h5').textContent}</strong></td></tr>` + catRows;
                }
            });
            
            // Location Externe
            document.querySelectorAll('#tab-location .collapsible-category:last-child .collapsible-category').forEach(cat => {
                let catRows = '';
                 cat.querySelectorAll('tbody tr').forEach(row => {
                    const qtyInput = row.cells.length > 2 ? row.querySelectorAll('input')[1] : row.querySelector('input');
                    const qty = qtyInput ? qtyInput.value : '0';

                    if(parseInt(qty) > 0) {
                        const type = row.cells[0].textContent;
                        const heightInput = row.cells.length > 2 ? row.querySelectorAll('input')[0] : null;
                        const height = heightInput ? heightInput.value : '';
                        catRows += `<tr><td>${type} ${height ? `(${height}m)`: ''}</td><td>${qty} (Externe)</td></tr>`;
                    }
                });
                if(catRows) {
                    locationHtml += `<tr><td colspan="2" style="background-color: var(--gray-50);"><strong>${cat.querySelector('h5').textContent}</strong></td></tr>` + catRows;
                }
            });

            if (locationHtml) {
                html += `<table class="dynamic-table"><thead><tr><th>Matériel</th><th>Quantité</th></tr></thead><tbody>${locationHtml}</tbody></table>`;
            } else {
                html += '<p>Aucune location de matériel spécifiée.</p>';
            }
            
            // Atelier
            html += '<h4>🔩 Pièces Atelier</h4>';
            if (document.querySelector('input[name="atelier-choice"][value="oui"]').checked) {
                 html += `<table class="dynamic-table"><tbody>
                    <tr><td style="width: 200px;"><strong>Nombre de pièces</strong></td><td>${document.getElementById('atelier-nb-pieces').value || NA}</td></tr>
                    <tr><td><strong>Prix par pièce</strong></td><td>€ ${document.getElementById('atelier-prix-piece').value || NA}</td></tr>
                    <tr><td><strong>Poids total</strong></td><td>${document.getElementById('atelier-poids').value || NA} KG</td></tr>
                    <tr><td><strong>Surface totale</strong></td><td>${document.getElementById('atelier-m2').value || NA} m²</td></tr>
                    <tr><td><strong>Mode de chargement</strong></td><td>${document.getElementById('atelier-chargement-mode').value || NA}</td></tr>
                    <tr><td><strong>Date de chargement</strong></td><td>${document.getElementById('atelier-date-chargement').value || NA}</td></tr>
                    <tr><td><strong>Date de livraison</strong></td><td>${document.getElementById('atelier-date-livraison').value || NA}</td></tr>
                 </tbody></table>`;
            } else {
                html += '<p>Aucun traitement en atelier prévu.</p>';
            }

            
            // Fermer le conteneur principal
            html += '</div>';

            container.innerHTML = html;
        }

        // Fonction pour mettre à jour automatiquement le résumé
        function updateResumeSummary() {
            // Vérifier si l'onglet résumé est actif
            const resumeTab = document.getElementById('tab-resume-chantier');
            if (resumeTab && resumeTab.classList.contains('active')) {
                generateResumeContent();
            }
        }

        // Fonction pour ajouter les écouteurs d'événements sur les champs de matériaux
        function setupMaterialFormListeners() {
            // Écouteurs pour les champs de matériaux
            const materialFields = [
                'zone-concerned',
                'systeme-peinture', 
                'ral',
                'fournisseur-global',
                'systeme-peinture-autre',
                'fournisseur-autre-global',
                'app-airless',
                'app-rouleau', 
                'app-pinceaux'
            ];

            materialFields.forEach(fieldId => {
                const element = document.getElementById(fieldId);
                if (element) {
                    if (element.type === 'checkbox') {
                        element.addEventListener('change', updateResumeSummary);
                    } else {
                        element.addEventListener('input', updateResumeSummary);
                        element.addEventListener('change', updateResumeSummary);
                    }
                }
            });

            // Écouteurs pour les champs généraux
            const generalFields = [
                'nom-chantier',
                'otp-numero', 
                'adresse-chantier',
                'client-societe',
                'client-responsable-nom-prenom',
                'client-tel',
                'client-email',
                'date-demarrage',
                'date-fin',
                'chef-chantier'
            ];

            generalFields.forEach(fieldId => {
                const element = document.getElementById(fieldId);
                if (element) {
                    element.addEventListener('input', updateResumeSummary);
                    element.addEventListener('change', updateResumeSummary);
                }
            });
        }


        // --- NEW/MODIFIED FUNCTIONS FOR MATERIAUX TAB ---

        function handleFournisseurChange(selectElement) {
            const autreGroup = document.getElementById('fournisseur-autre-group');
            if (autreGroup) {
                autreGroup.style.display = (selectElement.value === 'autres') ? 'block' : 'none';
                if (selectElement.value !== 'autres') {
                    document.getElementById('fournisseur-autre-global').value = '';
                }
            }
        }

        function handleSystemePeintureChange() {
            const systemeSelect = document.getElementById('systeme-peinture');
            const autreGroup = document.getElementById('systeme-peinture-autre-group');
            
            if (systemeSelect && autreGroup) {
                autreGroup.style.display = (systemeSelect.value === 'autre-systeme') ? 'block' : 'none';
                if (systemeSelect.value !== 'autre-systeme') {
                    document.getElementById('systeme-peinture-autre').value = '';
                }
            }
        }


        function toggleMaterialSections() {
            const structureType = document.getElementById('structure-type').value;
            const specsContainer = document.getElementById('materiaux-specs-container');
            if (structureType === 'parking') {
                specsContainer.style.display = 'none';
            } else {
                specsContainer.style.display = 'block';
            }
        }

        // Mettre à jour la liste des zones disponibles
        function updateZoneSelection() {
            const zoneSelect = document.getElementById('zone-concerned');
            const emptyState = document.getElementById('materiaux-empty-state');
            const mainInterface = document.getElementById('materiaux-main-interface');
            
            if (!zoneSelect) return;

            // Gérer l'affichage de l'interface
            if (validatedZones.length === 0) {
                // Aucune zone validée - afficher l'état vide
                if (emptyState) emptyState.style.display = 'block';
                if (mainInterface) mainInterface.style.display = 'none';
                return;
            } else {
                // Des zones sont validées - afficher l'interface principale
                if (emptyState) emptyState.style.display = 'none';
                if (mainInterface) mainInterface.style.display = 'block';
            }

            // Sauvegarder la sélection actuelle
            const currentSelection = zoneSelect.value;
            
            // Vider la liste
            zoneSelect.innerHTML = '<option value="">Sélectionner une zone</option>';
            
            // Ajouter les zones validées
            validatedZones.forEach((zone, index) => {
                const option = document.createElement('option');
                option.value = zone.id;
                option.textContent = `${zone.name} - ${zone.surface.toFixed(0)} m² - ${zone.hours} h`;
                zoneSelect.appendChild(option);
            });
            
            // Restaurer la sélection si elle existe encore
            if (currentSelection && validatedZones.find(z => z.id == currentSelection)) {
                zoneSelect.value = currentSelection;
                updateZoneDetailsAndMaterials();
            } else {
                updateZoneDetailsAndMaterials();
            }
        }

        // Mettre à jour les détails de la zone et les sections conditionnelles
        function updateZoneDetailsAndMaterials() {
            const zoneSelect = document.getElementById('zone-concerned');
            const detailsDiv = document.getElementById('zone-details');
            const conditionalSections = document.getElementById('materiaux-conditional-sections');
            
            if (!zoneSelect || !detailsDiv || !conditionalSections) return;
            
            const selectedZoneId = zoneSelect.value;
            const selectedZone = validatedZones.find(z => z.id == selectedZoneId);
            
            if (selectedZone) {
                // Mettre à jour les détails de la zone
                const travauxText = Array.isArray(selectedZone.travaux) ? selectedZone.travaux.join(', ') : (selectedZone.travaux || 'Aucun travail spécifié');
                const surfaceTypeText = Array.isArray(selectedZone.type) ? selectedZone.type.join(', ') : (selectedZone.type || 'Non spécifié');
                
                detailsDiv.innerHTML = `
                    <div style="display: flex; flex-direction: column; gap: 0.25rem;">
                        <div><strong>${selectedZone.name}</strong></div>
                        <div style="font-size: 0.9rem; color: var(--gray-700);">
                            🔨 ${travauxText}
                        </div>
                        <div style="display: flex; gap: 1rem; font-size: 0.85rem; margin-top: 0.5rem;">
                            <span style="color: var(--primary-blue);">🔧 ${surfaceTypeText}</span>
                            <span style="color: var(--primary-red);">📏 ${selectedZone.surface.toFixed(0)} m²</span>
                            <span style="color: var(--primary-blue);">⏰ ${selectedZone.hours} h</span>
                        </div>
                    </div>
                `;
                detailsDiv.style.color = 'var(--gray-900)';
                detailsDiv.style.fontStyle = 'normal';
                
                // Générer les sections conditionnelles basées sur les travaux
                generateConditionalSections(selectedZone);
                
                // Auto-remplir tous les calculateurs RAL avec les données de la zone
                setTimeout(autoFillAllRalCalculators, 100);
                
            } else {
                detailsDiv.innerHTML = 'Aucune zone sélectionnée';
                detailsDiv.style.color = 'var(--gray-600)';
                detailsDiv.style.fontStyle = 'italic';
                conditionalSections.innerHTML = '';
            }
        }

        // Générer les sections conditionnelles selon les travaux
        function generateConditionalSections(zone) {
            const conditionalSections = document.getElementById('materiaux-conditional-sections');
            const travaux = Array.isArray(zone.travaux) ? zone.travaux : [zone.travaux];
            
            let sectionsHTML = '';
            
            // Vérifier si c'est un chantier parking (exclure la section peinture)
            const isParkingProject = checkIfParkingProject();
            
            // Section Peinture (sauf pour les chantiers parking)
            if (travaux.includes('peinture') && !isParkingProject) {
                sectionsHTML += generatePaintSection();
            }
            
            // Section Sablage
            if (travaux.includes('sablage')) {
                sectionsHTML += generateSandingSection();
            }
            
            // Section Granaillage
            if (travaux.includes('granaillage')) {
                sectionsHTML += generateGritBlastingSection();
            }
            
            // Section Nettoyage HP
            if (travaux.includes('nettoyage-hp')) {
                sectionsHTML += generateHighPressureCleaningSection();
            }
            
            // Section Rinçage
            if (travaux.includes('rincage')) {
                sectionsHTML += generateRinsingSection();
            }
            
            // Section Protection
            if (travaux.includes('protection')) {
                sectionsHTML += generateProtectionSection();
            }
            
            // Section Dégraissage
            if (travaux.includes('degraissage')) {
                sectionsHTML += generateDegreasingSection();
            }
            
            conditionalSections.innerHTML = sectionsHTML;
        }

        // Générer la section Peinture
        function generatePaintSection() {
            return `
                <div class="materiaux-section" style="background: var(--white); border-radius: 1rem; padding: 1.5rem; margin-bottom: 2rem; box-shadow: var(--shadow-sm); border: 1px solid var(--gray-200);">
                    <h4 style="margin-bottom: 1.5rem; color: var(--primary-red); display: flex; align-items: center; gap: 0.5rem;">
                        🎨 Spécifications Peinture
                    </h4>
                    
                    <!-- Système et RAL -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-bottom: 1.5rem;">
                        <div class="form-group">
                            <label class="form-label required">Système de peinture</label>
                            <select class="form-select" id="systeme-peinture" onchange="handleSystemePeintureChange()" style="width: 100%;">
                                <option value="">Sélectionner...</option>
                                <option value="C3H">C3H</option>
                                <option value="C3VH">C3VH</option>
                                <option value="C4H">C4H</option>
                                <option value="C4VH">C4VH</option>
                                <option value="C5H">C5H</option>
                                <option value="C5VH">C5VH</option>
                                <option value="CXH">CXH</option>
                                <option value="Im2H">Im2H</option>
                                <option value="Im4H">Im4H</option>
                                <option value="CX-Im4H">CX-Im4H</option>
                                <option value="resine">Résine</option>
                                <option value="peinture-facade">Peinture façade</option>
                                <option value="autre-systeme">Autre système</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Codes RAL avec Calculateurs</label>
                            <div id="ral-container">
                                <div class="ral-item" id="ral-item-1" style="border: 1px solid var(--gray-200); border-radius: 0.5rem; padding: 1rem; margin-bottom: 1rem; background: var(--gray-50);">
                                    <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem; align-items: center;">
                                        <input type="text" class="form-input" id="ral-1" placeholder="Ex: RAL 9003" style="flex: 1;" maxlength="10" onchange="updateRalCalculator(1)">
                                        <input type="text" class="form-input" id="ref-1" placeholder="Ex: EPODUX IM209" style="flex: 2;" onchange="updateRalCalculator(1)">
                                        <button type="button" class="btn btn-secondary" onclick="addRalField()" style="padding: 0.5rem; border-radius: 0.375rem; background: var(--gray-500); color: white; border: none; cursor: pointer; font-size: 0.8rem;">
                                            ➕
                                        </button>
                                    </div>
                                    
                                    <!-- Calculateur pour ce RAL -->
                                    <div class="ral-calculator" id="calculator-1" style="display: none;">
                                        <h6 style="color: var(--primary-blue); margin-bottom: 0.75rem; font-size: 0.9rem;">🧮 Calculateur pour <span id="ral-label-1">RAL</span></h6>
                                        
                                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 0.75rem; margin-bottom: 1rem;">
                                            <div class="form-group">
                                                <label class="form-label" style="font-size: 0.8rem;">Surface (m²)</label>
                                                <input type="number" class="form-input" id="calc-surface-1" placeholder="0" step="0.1" oninput="calculateRalQuantity(1)" style="font-size: 0.8rem;">
                                            </div>
                                            <div class="form-group">
                                                <label class="form-label" style="font-size: 0.8rem;">ESV %</label>
                                                <input type="number" class="form-input" id="calc-esv-1" placeholder="85" step="0.1" oninput="calculateRalQuantity(1)" style="font-size: 0.8rem;">
                                            </div>
                                            <div class="form-group">
                                                <label class="form-label" style="font-size: 0.8rem;">Épaisseur (µm)</label>
                                                <input type="number" class="form-input" id="calc-epaisseur-1" placeholder="100" step="1" oninput="calculateRalQuantity(1)" style="font-size: 0.8rem;">
                                            </div>
                                            <div class="form-group">
                                                <label class="form-label" style="font-size: 0.8rem;">Perte %</label>
                                                <input type="number" class="form-input" id="calc-perte-1" placeholder="60" step="0.1" oninput="calculateRalQuantity(1)" style="font-size: 0.8rem;">
                                            </div>
                                            <div class="form-group">
                                                <label class="form-label" style="font-size: 0.8rem;">Conditionnement (L)</label>
                                                <input type="number" class="form-input" id="calc-conditionnement-1" placeholder="15" step="0.1" oninput="calculateRalQuantity(1)" style="font-size: 0.8rem;">
                                            </div>
                                            <div class="form-group">
                                                <label class="form-label" style="font-size: 0.8rem;">Prix/Litre (€)</label>
                                                <input type="number" class="form-input" id="calc-prix-1" placeholder="9.08" step="0.01" oninput="calculateRalQuantity(1)" style="font-size: 0.8rem;">
                                            </div>
                                        </div>
                                        
                                        <!-- Résultats du calcul -->
                                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 0.5rem; background: white; border-radius: 0.375rem; padding: 0.75rem; border: 1px solid var(--gray-300);">
                                            <div style="text-align: center;">
                                                <div style="font-size: 1rem; font-weight: 600; color: var(--primary-blue);" id="calc-rdt-theorique-1">0.00</div>
                                                <div style="font-size: 0.7rem; color: var(--gray-600);">Rdt théorique</div>
                                            </div>
                                            <div style="text-align: center;">
                                                <div style="font-size: 1rem; font-weight: 600; color: var(--success);" id="calc-rdt-pratique-1">0.00</div>
                                                <div style="font-size: 0.7rem; color: var(--gray-600);">Rdt pratique</div>
                                            </div>
                                            <div style="text-align: center;">
                                                <div style="font-size: 1rem; font-weight: 600; color: var(--primary-red);" id="calc-quantite-1">0.00</div>
                                                <div style="font-size: 0.7rem; color: var(--gray-600);">Quantité (L)</div>
                                            </div>
                                            <div style="text-align: center;">
                                                <div style="font-size: 1rem; font-weight: 600; color: var(--warning);" id="calc-nb-pots-1">0</div>
                                                <div style="font-size: 0.7rem; color: var(--gray-600);">Nb pots</div>
                                            </div>
                                            <div style="text-align: center;">
                                                <div style="font-size: 1rem; font-weight: 600; color: var(--primary-red);" id="calc-montant-1">0.00 €</div>
                                                <div style="font-size: 0.7rem; color: var(--gray-600);">Montant HT</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Champ conditionnel pour autre système -->
                    <div class="form-group" id="systeme-peinture-autre-group" style="display: none; margin-bottom: 1.5rem;">
                        <label class="form-label">Préciser le système</label>
                        <input type="text" class="form-input" id="systeme-peinture-autre" placeholder="Spécifier le système" style="width: 100%;">
                    </div>
                    
                    <!-- Méthode d'application -->
                    <div style="margin-bottom: 1.5rem;">
                        <label class="form-label" style="margin-bottom: 0.75rem; display: block;">Méthode d'Application</label>
                        <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                            <label class="checkbox-compact" style="display: flex; align-items: center; gap: 0.5rem; padding: 0.75rem 1rem; background: var(--gray-50); border-radius: 0.5rem; border: 1px solid var(--gray-200); cursor: pointer; transition: all 0.2s ease;">
                                <input type="checkbox" id="app-airless" style="width: 16px; height: 16px;">
                                <span style="font-weight: 500; font-size: 0.9rem;">Airless</span>
                            </label>
                            <label class="checkbox-compact" style="display: flex; align-items: center; gap: 0.5rem; padding: 0.75rem 1rem; background: var(--gray-50); border-radius: 0.5rem; border: 1px solid var(--gray-200); cursor: pointer; transition: all 0.2s ease;">
                                <input type="checkbox" id="app-rouleau" style="width: 16px; height: 16px;">
                                <span style="font-weight: 500; font-size: 0.9rem;">Rouleau</span>
                            </label>
                            <label class="checkbox-compact" style="display: flex; align-items: center; gap: 0.5rem; padding: 0.75rem 1rem; background: var(--gray-50); border-radius: 0.5rem; border: 1px solid var(--gray-200); cursor: pointer; transition: all 0.2s ease;">
                                <input type="checkbox" id="app-pinceaux" style="width: 16px; height: 16px;">
                                <span style="font-weight: 500; font-size: 0.9rem;">Pinceaux</span>
                            </label>
                        </div>
                    </div>
                    
                    
                    <!-- Sections des couches (apparaîtront selon le système) -->
                    <div id="paint-layers-sections">
                        <!-- Les couches seront générées dynamiquement selon le système -->
                    </div>
                </div>
            `;
        }

        // Générer les autres sections (sablage, granaillage, etc.)
        function generateSandingSection() {
            return `
                <div class="materiaux-section" style="background: var(--white); border-radius: 1rem; padding: 1.5rem; margin-bottom: 2rem; box-shadow: var(--shadow-sm); border: 1px solid var(--gray-200);">
                    <h4 style="margin-bottom: 1.5rem; color: var(--primary-red); display: flex; align-items: center; gap: 0.5rem;">
                        🏗️ Spécifications Sablage
                    </h4>
                    <p style="color: var(--gray-600); font-style: italic;">Configuration du sablage à définir selon les besoins spécifiques.</p>
                </div>
            `;
        }

        function generateGritBlastingSection() {
            return `
                <div class="materiaux-section" style="background: var(--white); border-radius: 1rem; padding: 1.5rem; margin-bottom: 2rem; box-shadow: var(--shadow-sm); border: 1px solid var(--gray-200);">
                    <h4 style="margin-bottom: 1.5rem; color: var(--primary-red); display: flex; align-items: center; gap: 0.5rem;">
                        ⚡ Spécifications Granaillage
                    </h4>
                    <p style="color: var(--gray-600); font-style: italic;">Configuration du granaillage à définir selon les besoins spécifiques.</p>
                </div>
            `;
        }

        function generateHighPressureCleaningSection() {
            return `
                <div class="materiaux-section" style="background: var(--white); border-radius: 1rem; padding: 1.5rem; margin-bottom: 2rem; box-shadow: var(--shadow-sm); border: 1px solid var(--gray-200);">
                    <h4 style="margin-bottom: 1.5rem; color: var(--primary-red); display: flex; align-items: center; gap: 0.5rem;">
                        💧 Spécifications Nettoyage HP
                    </h4>
                    <p style="color: var(--gray-600); font-style: italic;">Configuration du nettoyage haute pression à définir selon les besoins spécifiques.</p>
                </div>
            `;
        }

        function generateRinsingSection() {
            return `
                <div class="materiaux-section" style="background: var(--white); border-radius: 1rem; padding: 1.5rem; margin-bottom: 2rem; box-shadow: var(--shadow-sm); border: 1px solid var(--gray-200);">
                    <h4 style="margin-bottom: 1.5rem; color: var(--primary-red); display: flex; align-items: center; gap: 0.5rem;">
                        🚿 Spécifications Rinçage
                    </h4>
                    <p style="color: var(--gray-600); font-style: italic;">Configuration du rinçage à définir selon les besoins spécifiques.</p>
                </div>
            `;
        }

        function generateProtectionSection() {
            return `
                <div class="materiaux-section" style="background: var(--white); border-radius: 1rem; padding: 1.5rem; margin-bottom: 2rem; box-shadow: var(--shadow-sm); border: 1px solid var(--gray-200);">
                    <h4 style="margin-bottom: 1.5rem; color: var(--primary-red); display: flex; align-items: center; gap: 0.5rem;">
                        🛡️ Spécifications Protection
                    </h4>
                    <p style="color: var(--gray-600); font-style: italic;">Configuration de la protection à définir selon les besoins spécifiques.</p>
                </div>
            `;
        }

        function generateDegreasingSection() {
            return `
                <div class="materiaux-section" style="background: var(--white); border-radius: 1rem; padding: 1.5rem; margin-bottom: 2rem; box-shadow: var(--shadow-sm); border: 1px solid var(--gray-200);">
                    <h4 style="margin-bottom: 1.5rem; color: var(--primary-red); display: flex; align-items: center; gap: 0.5rem;">
                        🧽 Spécifications Dégraissage
                    </h4>
                    <p style="color: var(--gray-600); font-style: italic;">Configuration du dégraissage à définir selon les besoins spécifiques.</p>
                </div>
            `;
        }

        // Gestion des RAL multiples avec calculateurs individuels
        let ralCounter = 1;
        
        function addRalField() {
            ralCounter++;
            const container = document.getElementById('ral-container');
            const newRalItem = document.createElement('div');
            newRalItem.className = 'ral-item';
            newRalItem.id = `ral-item-${ralCounter}`;
            newRalItem.style.cssText = 'border: 1px solid var(--gray-200); border-radius: 0.5rem; padding: 1rem; margin-bottom: 1rem; background: var(--gray-50);';
            
            newRalItem.innerHTML = `
                <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem; align-items: center;">
                    <input type="text" class="form-input" id="ral-${ralCounter}" placeholder="Ex: RAL 9003" style="flex: 1;" maxlength="10" onchange="updateRalCalculator(${ralCounter})">
                    <input type="text" class="form-input" id="ref-${ralCounter}" placeholder="Ex: EPODUX IM209" style="flex: 2;" onchange="updateRalCalculator(${ralCounter})">
                    <button type="button" class="btn btn-danger" onclick="removeRalField(${ralCounter})" style="padding: 0.5rem; border-radius: 0.375rem; background: var(--danger); color: white; border: none; cursor: pointer; font-size: 0.8rem;">
                        ➖
                    </button>
                </div>
                
                <!-- Calculateur pour ce RAL -->
                <div class="ral-calculator" id="calculator-${ralCounter}" style="display: none;">
                    <h6 style="color: var(--primary-blue); margin-bottom: 0.75rem; font-size: 0.9rem;">🧮 Calculateur pour <span id="ral-label-${ralCounter}">RAL</span></h6>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 0.75rem; margin-bottom: 1rem;">
                        <div class="form-group">
                            <label class="form-label" style="font-size: 0.8rem;">Surface (m²)</label>
                            <input type="number" class="form-input" id="calc-surface-${ralCounter}" placeholder="0" step="0.1" oninput="calculateRalQuantity(${ralCounter})" style="font-size: 0.8rem;">
                        </div>
                        <div class="form-group">
                            <label class="form-label" style="font-size: 0.8rem;">ESV %</label>
                            <input type="number" class="form-input" id="calc-esv-${ralCounter}" placeholder="85" step="0.1" oninput="calculateRalQuantity(${ralCounter})" style="font-size: 0.8rem;">
                        </div>
                        <div class="form-group">
                            <label class="form-label" style="font-size: 0.8rem;">Épaisseur (µm)</label>
                            <input type="number" class="form-input" id="calc-epaisseur-${ralCounter}" placeholder="100" step="1" oninput="calculateRalQuantity(${ralCounter})" style="font-size: 0.8rem;">
                        </div>
                        <div class="form-group">
                            <label class="form-label" style="font-size: 0.8rem;">Perte %</label>
                            <input type="number" class="form-input" id="calc-perte-${ralCounter}" placeholder="60" step="0.1" oninput="calculateRalQuantity(${ralCounter})" style="font-size: 0.8rem;">
                        </div>
                        <div class="form-group">
                            <label class="form-label" style="font-size: 0.8rem;">Conditionnement (L)</label>
                            <input type="number" class="form-input" id="calc-conditionnement-${ralCounter}" placeholder="15" step="0.1" oninput="calculateRalQuantity(${ralCounter})" style="font-size: 0.8rem;">
                        </div>
                        <div class="form-group">
                            <label class="form-label" style="font-size: 0.8rem;">Prix/Litre (€)</label>
                            <input type="number" class="form-input" id="calc-prix-${ralCounter}" placeholder="9.08" step="0.01" oninput="calculateRalQuantity(${ralCounter})" style="font-size: 0.8rem;">
                        </div>
                    </div>
                    
                    <!-- Résultats du calcul -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 0.5rem; background: white; border-radius: 0.375rem; padding: 0.75rem; border: 1px solid var(--gray-300);">
                        <div style="text-align: center;">
                            <div style="font-size: 1rem; font-weight: 600; color: var(--primary-blue);" id="calc-rdt-theorique-${ralCounter}">0.00</div>
                            <div style="font-size: 0.7rem; color: var(--gray-600);">Rdt théorique</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 1rem; font-weight: 600; color: var(--success);" id="calc-rdt-pratique-${ralCounter}">0.00</div>
                            <div style="font-size: 0.7rem; color: var(--gray-600);">Rdt pratique</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 1rem; font-weight: 600; color: var(--primary-red);" id="calc-quantite-${ralCounter}">0.00</div>
                            <div style="font-size: 0.7rem; color: var(--gray-600);">Quantité (L)</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 1rem; font-weight: 600; color: var(--warning);" id="calc-nb-pots-${ralCounter}">0</div>
                            <div style="font-size: 0.7rem; color: var(--gray-600);">Nb pots</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 1rem; font-weight: 600; color: var(--primary-red);" id="calc-montant-${ralCounter}">0.00 €</div>
                            <div style="font-size: 0.7rem; color: var(--gray-600);">Montant HT</div>
                        </div>
                    </div>
                </div>
            `;
            
            container.appendChild(newRalItem);
        }
        
        function removeRalField(ralId) {
            const ralItem = document.getElementById(`ral-item-${ralId}`);
            if (ralItem) {
                ralItem.remove();
            }
        }
        
        // Mettre à jour le calculateur RAL (afficher/masquer selon le contenu)
        function updateRalCalculator(ralId) {
            const ralInput = document.getElementById(`ral-${ralId}`);
            const refInput = document.getElementById(`ref-${ralId}`);
            const calculator = document.getElementById(`calculator-${ralId}`);
            const ralLabel = document.getElementById(`ral-label-${ralId}`);
            
            if (ralInput && refInput && calculator && ralLabel) {
                const ralValue = ralInput.value.trim();
                const refValue = refInput.value.trim();
                
                if (ralValue || refValue) {
                    calculator.style.display = 'block';
                    ralLabel.textContent = ralValue || 'RAL';
                    
                    // Auto-remplir la surface si une zone est sélectionnée
                    autoFillRalCalculator(ralId);
                } else {
                    calculator.style.display = 'none';
                }
            }
        }
        
        // Calculateur de quantité pour un RAL spécifique
        function calculateRalQuantity(ralId) {
            const surface = parseFloat(document.getElementById(`calc-surface-${ralId}`)?.value) || 0;
            const esv = parseFloat(document.getElementById(`calc-esv-${ralId}`)?.value) || 0;
            const epaisseur = parseFloat(document.getElementById(`calc-epaisseur-${ralId}`)?.value) || 0;
            const perte = parseFloat(document.getElementById(`calc-perte-${ralId}`)?.value) || 0;
            const conditionnement = parseFloat(document.getElementById(`calc-conditionnement-${ralId}`)?.value) || 0;
            const prix = parseFloat(document.getElementById(`calc-prix-${ralId}`)?.value) || 0;
            
            if (surface === 0 || esv === 0 || epaisseur === 0) {
                // Réinitialiser les résultats si les champs obligatoires sont vides
                document.getElementById(`calc-rdt-theorique-${ralId}`).textContent = '0.00';
                document.getElementById(`calc-rdt-pratique-${ralId}`).textContent = '0.00';
                document.getElementById(`calc-quantite-${ralId}`).textContent = '0.00';
                document.getElementById(`calc-nb-pots-${ralId}`).textContent = '0';
                document.getElementById(`calc-montant-${ralId}`).textContent = '0.00 €';
                return;
            }
            
            // Calculs basés sur la logique du tableau
            // Rdt théorique = (ESV % * 10) / Épaisseur
            const rdtTheorique = (esv * 10) / epaisseur;
            
            // Rdt pratique = Rdt théorique * (1 - Perte/100)
            const rdtPratique = rdtTheorique * (1 - perte / 100);
            
            // Quantité = Surface / Rdt pratique
            const quantite = surface / rdtPratique;
            
            // Nombre de pots entiers = CEILING(Quantité / Conditionnement)
            const nbPotsEntiers = Math.ceil(quantite / conditionnement);
            
            // Montant HT = Nombre de pots entiers * Conditionnement * Prix
            const montant = nbPotsEntiers * conditionnement * prix;
            
            // Mettre à jour l'affichage
            document.getElementById(`calc-rdt-theorique-${ralId}`).textContent = rdtTheorique.toFixed(2);
            document.getElementById(`calc-rdt-pratique-${ralId}`).textContent = rdtPratique.toFixed(2);
            document.getElementById(`calc-quantite-${ralId}`).textContent = quantite.toFixed(2);
            document.getElementById(`calc-nb-pots-${ralId}`).textContent = nbPotsEntiers.toString();
            document.getElementById(`calc-montant-${ralId}`).textContent = montant.toFixed(2) + ' €';
        }
        
        // Auto-remplir le calculateur RAL avec les données de la zone sélectionnée
        function autoFillRalCalculator(ralId) {
            const zoneSelect = document.getElementById('zone-concerned');
            if (!zoneSelect || !zoneSelect.value) return;
            
            const selectedZone = validatedZones.find(z => z.id == zoneSelect.value);
            if (selectedZone) {
                const surfaceInput = document.getElementById(`calc-surface-${ralId}`);
                if (surfaceInput && !surfaceInput.value) {
                    surfaceInput.value = selectedZone.surface;
                    calculateRalQuantity(ralId);
                }
            }
        }
        
        // Auto-remplir tous les calculateurs RAL
        function autoFillAllRalCalculators() {
            for (let i = 1; i <= ralCounter; i++) {
                const calculator = document.getElementById(`calculator-${i}`);
                if (calculator && calculator.style.display !== 'none') {
                    autoFillRalCalculator(i);
                }
            }
        }
        
        // Vérifier si c'est un chantier parking
        function checkIfParkingProject() {
            // Vérifier dans les données du projet ou dans les zones validées
            // Pour l'instant, on peut vérifier le nom du chantier ou d'autres critères
            const nomChantier = document.getElementById('nom-chantier')?.value?.toLowerCase() || '';
            const adresseChantier = document.getElementById('adresse-chantier')?.value?.toLowerCase() || '';
            
            // Mots-clés qui indiquent un chantier parking
            const parkingKeywords = ['parking', 'garage', 'sous-sol', 'sous sol'];
            
            return parkingKeywords.some(keyword => 
                nomChantier.includes(keyword) || adresseChantier.includes(keyword)
            );
        }

        // Valider les spécifications matériaux
        function validateMaterialSpecs() {
            const zoneSelect = document.getElementById('zone-concerned');
            const selectedZoneId = zoneSelect.value;
            
            if (!selectedZoneId) {
                showNotification('Veuillez d\'abord sélectionner une zone', 'error');
                return;
            }
            
            const selectedZone = validatedZones.find(z => z.id == selectedZoneId);
            if (!selectedZone) {
                showNotification('Zone sélectionnée introuvable', 'error');
                return;
            }
            
            // Récupérer les données du formulaire
            const systemePeinture = document.getElementById('systeme-peinture').value;
            const systemePeintureAutre = document.getElementById('systeme-peinture-autre').value;
            const fournisseur = document.getElementById('fournisseur-global').value;
            const fournisseurAutre = document.getElementById('fournisseur-autre-global').value;
            const ral = document.getElementById('ral').value;
            
            const materialData = {
                zoneId: selectedZoneId,
                zoneName: selectedZone.name,
                systemePeinture: systemePeinture === 'autre-systeme' ? systemePeintureAutre : systemePeinture,
                fournisseur: fournisseur === 'autres' ? fournisseurAutre : fournisseur,
                ral: ral,
                // Méthode d'application
                application: {
                    airless: document.getElementById('app-airless').checked,
                    rouleau: document.getElementById('app-rouleau').checked,
                    pinceaux: document.getElementById('app-pinceaux').checked
                },
                validatedAt: new Date().toISOString()
            };
            
            // Validation des champs obligatoires
            if (!materialData.systemePeinture) {
                showNotification('Veuillez sélectionner un système de peinture', 'error');
                return;
            }
            
            // Validation spécifique pour "Autre système"
            if (systemePeinture === 'autre-systeme' && !systemePeintureAutre.trim()) {
                showNotification('Veuillez préciser le système de peinture', 'error');
                return;
            }
            
            // Validation spécifique pour "Autres" fournisseur
            if (fournisseur === 'autres' && !fournisseurAutre.trim()) {
                showNotification('Veuillez préciser le fournisseur', 'error');
                return;
            }
            
            // Sauvegarder les spécifications
            if (!window.materialSpecs) {
                window.materialSpecs = [];
            }
            
            // Supprimer les anciennes spécifications pour cette zone
            window.materialSpecs = window.materialSpecs.filter(spec => spec.zoneId !== selectedZoneId);
            
            // Ajouter les nouvelles spécifications
            window.materialSpecs.push(materialData);
            
            showNotification(`Spécifications validées pour la zone "${selectedZone.zoneName}"`, 'success');
            
            // Sauvegarder dans localStorage
            autoSave();
        }

        function syncZones() {
            const peintureContainer = document.getElementById('zones-peinture-container');
            const zoneSelect = document.getElementById('zone-concerned');
            const existingData = {};

            // Sauvegarder les données existantes
            peintureContainer.querySelectorAll('.zone-peinture').forEach(zone => {
                const zoneTitle = zone.querySelector('h4 span').textContent.split(' (')[0];
                existingData[zoneTitle] = {};
                zone.querySelectorAll('.collapsible-category').forEach((layer, index) => {
                    const inputs = layer.querySelectorAll('input');
                    existingData[zoneTitle][index] = Array.from(inputs).map(i => i.value);
                });
            });

            // Vider le conteneur et la liste de sélection
            peintureContainer.innerHTML = '';
            zoneSelect.innerHTML = '<option value="">Sélectionner une zone</option>';

            // Utiliser les zones validées pour la synchronisation
            validatedZones.forEach((zone, index) => {
                const zoneName = zone.name || `Zone ${index + 1}`;
                const zoneSurface = zone.surface || 0;
                
                // Ajouter à la liste de sélection
                const option = document.createElement('option');
                option.value = zone.id;
                option.textContent = `${zoneName} (${zoneSurface.toFixed(2)} m²)`;
                zoneSelect.appendChild(option);
                
                const newZone = document.createElement('div');
                newZone.className = 'zone-peinture';
                newZone.dataset.surface = zoneSurface;

                const savedZone = existingData[zoneName] || {};

                const template = `
                    <h4 style="margin: 2rem 0 1rem; color: var(--primary-red); display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid var(--gray-200); padding-bottom: 0.5rem;">
                        <span>${zoneName} (${zoneSurface} m²)</span>
                    </h4>
                    <div class="collapsible-category">
                        <h5 class="collapsible-header">Première couche</h5>
                        <div class="collapsible-content" style="padding: 1.5rem 1rem 0 1rem;">
                            <div class="form-grid">
                                <div class="form-group"><label class="form-label">Référence Produit</label><input type="text" class="form-input" placeholder="Ex: Hempadur 15570" oninput="autoSave()" value="${(savedZone[0] && savedZone[0][0]) || ''}"></div>
                                <div class="form-group"><label class="form-label">RAL</label><input type="text" class="form-input" placeholder="Ex: 9002" oninput="autoSave()" value="${(savedZone[0] && savedZone[0][1]) || ''}"></div>
                                <div class="form-group"><label class="form-label">Épaisseur (micron)</label><input type="number" class="form-input" placeholder="Ex: 80" oninput="autoSave()" value="${(savedZone[0] && savedZone[0][2]) || ''}"></div>
                                <div class="form-group"><label class="form-label">Rendement moyen (m²/L)</label><input type="number" step="0.1" class="form-input" placeholder="Ex: 8.2" oninput="updateCostBreakdown()" value="${(savedZone[0] && savedZone[0][3]) || ''}"></div>
                                <div class="form-group"><label class="form-label">Conditionnement (L)</label><input type="number" step="0.1" class="form-input" placeholder="Ex: 20" oninput="autoSave()" value="${(savedZone[0] && savedZone[0][4]) || ''}"></div>
                                <div class="form-group"><label class="form-label">Prix/Litre (€)</label><input type="number" step="0.01" class="form-input" placeholder="Ex: 15.50" oninput="updateCostBreakdown()" value="${(savedZone[0] && savedZone[0][5]) || ''}"></div>
                            </div>
                        </div>
                    </div>
                    <div class="collapsible-category">
                        <h5 class="collapsible-header">Couche intermédiaire</h5>
                        <div class="collapsible-content" style="padding: 1.5rem 1rem 0 1rem;">
                            <div class="form-grid">
                                <div class="form-group"><label class="form-label">Référence Produit</label><input type="text" class="form-input" placeholder="Ex: Hempathane 55210" oninput="autoSave()" value="${(savedZone[1] && savedZone[1][0]) || ''}"></div>
                                <div class="form-group"><label class="form-label">RAL</label><input type="text" class="form-input" placeholder="Ex: 7035" oninput="autoSave()" value="${(savedZone[1] && savedZone[1][1]) || ''}"></div>
                                <div class="form-group"><label class="form-label">Épaisseur (micron)</label><input type="number" class="form-input" placeholder="Ex: 120" oninput="autoSave()" value="${(savedZone[1] && savedZone[1][2]) || ''}"></div>
                                <div class="form-group"><label class="form-label">Rendement moyen (m²/L)</label><input type="number" step="0.1" class="form-input" placeholder="Ex: 7.5" oninput="updateCostBreakdown()" value="${(savedZone[1] && savedZone[1][3]) || ''}"></div>
                                <div class="form-group"><label class="form-label">Conditionnement (L)</label><input type="number" step="0.1" class="form-input" placeholder="Ex: 20" oninput="autoSave()" value="${(savedZone[1] && savedZone[1][4]) || ''}"></div>
                                <div class="form-group"><label class="form-label">Prix/Litre (€)</label><input type="number" step="0.01" class="form-input" placeholder="Ex: 18.20" oninput="updateCostBreakdown()" value="${(savedZone[1] && savedZone[1][5]) || ''}"></div>
                            </div>
                        </div>
                    </div>
                    <div class="collapsible-category">
                        <h5 class="collapsible-header">Couche de finition</h5>
                        <div class="collapsible-content" style="padding: 1.5rem 1rem 0 1rem;">
                            <div class="form-grid">
                                <div class="form-group"><label class="form-label">Référence Produit</label><input type="text" class="form-input" placeholder="Ex: Hempathane Topcoat 55210" oninput="autoSave()" value="${(savedZone[2] && savedZone[2][0]) || ''}"></div>
                                <div class="form-group"><label class="form-label">RAL</label><input type="text" class="form-input" placeholder="Ex: 7035" oninput="autoSave()" value="${(savedZone[2] && savedZone[2][1]) || ''}"></div>
                                <div class="form-group"><label class="form-label">Épaisseur (micron)</label><input type="number" class="form-input" placeholder="Ex: 80" oninput="autoSave()" value="${(savedZone[2] && savedZone[2][2]) || ''}"></div>
                                <div class="form-group"><label class="form-label">Rendement moyen (m²/L)</label><input type="number" step="0.1" class="form-input" placeholder="Ex: 9.1" oninput="updateCostBreakdown()" value="${(savedZone[2] && savedZone[2][3]) || ''}"></div>
                                <div class="form-group"><label class="form-label">Conditionnement (L)</label><input type="number" step="0.1" class="form-input" placeholder="Ex: 20" oninput="autoSave()" value="${(savedZone[2] && savedZone[2][4]) || ''}"></div>
                                <div class="form-group"><label class="form-label">Prix/Litre (€)</label><input type="number" step="0.01" class="form-input" placeholder="Ex: 22.00" oninput="updateCostBreakdown()" value="${(savedZone[2] && savedZone[2][5]) || ''}"></div>
                            </div>
                        </div>
                    </div>
                `;
                newZone.innerHTML = template;
                peintureContainer.appendChild(newZone);
            });
        }

        // ===== INITIALISATION ET GESTIONNAIRES D'ÉVÉNEMENTS =====

        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 Initialisation de la nouvelle interface Surface');
            
            // Charger les données sauvegardées
            loadSavedData();
            
            // Initialiser l'interface
            initializeSurfaceInterface();
            
            // Configurer les gestionnaires d'événements
            setupEventListeners();
            
            // Écouter les mises à jour des affectations
            window.addEventListener('affectationsUpdated', function(event) {
                console.log('Matériaux: Affectations mises à jour', event.detail);
                // Mettre à jour l'affichage si nécessaire
                loadSavedData();
                initializeSurfaceInterface();
            });
            
            // Écouter les changements de localStorage pour les affectations
            window.addEventListener('storage', function(e) {
                if (e.key === 'planning_affectations') {
                    console.log('Matériaux: Données d\'affectations mises à jour via localStorage');
                    loadSavedData();
                    initializeSurfaceInterface();
                }
            });
            
            // Configurer les écouteurs pour le résumé automatique
            setupMaterialFormListeners();
            
            // Initialiser les autres modules
            initializeOtherModules();
            
            // Forcer la mise à jour de l'affichage des zones validées
            updateValidatedZonesDisplay();
            
            // Initialiser l'onglet atelier
            toggleAtelierForm();
            
            // Correction drastique pour l'onglet atelier
            const atelierTab = document.getElementById('tab-atelier');
            if (atelierTab) {
                atelierTab.style.position = 'relative';
                atelierTab.style.top = 'auto';
                atelierTab.style.left = 'auto';
                atelierTab.style.right = 'auto';
                atelierTab.style.bottom = 'auto';
                atelierTab.style.transform = 'none';
                atelierTab.style.zIndex = 'auto';
                atelierTab.style.width = '100%';
                atelierTab.style.boxSizing = 'border-box';
                console.log('🔧 Onglet atelier repositionné');
            }
            
            // Ajouter un gestionnaire spécial pour l'onglet atelier
            const atelierBtn = document.querySelector('[data-tab="tab-atelier"]');
            if (atelierBtn) {
                atelierBtn.addEventListener('click', function() {
                    setTimeout(() => {
                        const atelierTab = document.getElementById('tab-atelier');
                        if (atelierTab) {
                            atelierTab.style.position = 'relative';
                            atelierTab.style.top = 'auto';
                            atelierTab.style.left = 'auto';
                            atelierTab.style.right = 'auto';
                            atelierTab.style.bottom = 'auto';
                            atelierTab.style.transform = 'none';
                            atelierTab.style.zIndex = 'auto';
                            atelierTab.style.width = '100%';
                            atelierTab.style.boxSizing = 'border-box';
                            console.log('🔧 Interface atelier repositionnée au clic');
                        }
                    }, 100);
                });
            }
            
            console.log('✅ Interface Surface initialisée avec succès');
            
            // Test des sections collapsibles
            setTimeout(() => {
                const collapsibleHeaders = document.querySelectorAll('.collapsible-header');
                console.log(`🔍 ${collapsibleHeaders.length} sections collapsibles détectées:`, 
                    Array.from(collapsibleHeaders).map(h => h.textContent.trim()));
            }, 1000);
        });

        // Charger les données sauvegardées
        function loadSavedData() {
            try {
                const savedData = localStorage.getItem('travaux_materiaux_data_v2');
                if (savedData) {
                    const data = JSON.parse(savedData);
                    if (data.validatedZones) {
                        validatedZones = data.validatedZones;
                        console.log(`📦 ${validatedZones.length} zones validées chargées`);
                    }
                }
            } catch (error) {
                console.error('❌ Erreur chargement données:', error);
            }
        }

        // Initialiser l'interface Surface
        function initializeSurfaceInterface() {
            // Ajouter une zone vide par défaut
            addNewZone();
            
            // Mettre à jour l'affichage des zones validées
            updateValidatedZonesDisplay();
            
            // Vérifier l'état vide
            checkEmptyState();
            
            // Mettre à jour les calculs
            updateCalculations();
        }

        // Configurer les gestionnaires d'événements
        function setupEventListeners() {
            // Gestionnaires pour les onglets
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const targetTab = this.getAttribute('data-tab');
                    
                    // Retirer la classe active de tous les boutons et contenus
                    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    
                    // Ajouter la classe active au bouton cliqué et au contenu correspondant
                    this.classList.add('active');
                    const targetContent = document.getElementById(targetTab);
                    if (targetContent) {
                        targetContent.classList.add('active');
                    }
                });
            });
            
            // Gestionnaires pour les modes de saisie
            document.querySelectorAll('input[name="surface-mode"]').forEach(input => {
                input.addEventListener('change', handleModeChange);
            });
            
            // Gestionnaires pour les sections collapsibles - Version améliorée
            document.addEventListener('click', function(e) {
                // Vérifier si l'élément cliqué ou un de ses parents est un collapsible-header
                let target = e.target;
                while (target && target !== document.body) {
                    if (target.classList && target.classList.contains('collapsible-header')) {
                        e.preventDefault();
                        e.stopPropagation();
                        
                        console.log('🔽 Section collapsible cliquée:', target.textContent);
                        
                        // Toggle la classe active
                        target.classList.toggle('active');
                        
                        // Trouver le contenu associé
                        const content = target.nextElementSibling;
                        if (content && content.classList.contains('collapsible-content')) {
                            const isOpen = content.style.display === "block" || getComputedStyle(content).display === 'block';
                            
                            if (isOpen) {
                                content.style.display = "none";
                                content.classList.remove('active');
                                console.log('📁 Section fermée');
                            } else {
                                content.style.display = "block";
                                content.classList.add('active');
                                console.log('📂 Section ouverte');
                            }
                        }
                        break;
                    }
                    target = target.parentElement;
                }
            });
            
            // Gestionnaire pour les changements de type de structure
            const structureTypeSelect = document.getElementById('structure-type');
            if (structureTypeSelect) {
                structureTypeSelect.addEventListener('change', toggleMaterialSections);
            }
        }

        // Initialiser les autres modules
        function initializeOtherModules() {
            try {
                syncZones();
                updateTotalSurface();
                updateCostBreakdown();
                setupAtelierLogic();
                updateZoneSelection();
            } catch (error) {
                console.error('❌ Erreur initialisation modules:', error);
            }
        }

        // ===== FONCTIONS POUR L'ONGLET MATÉRIAUX =====

        // Mettre à jour les détails de la zone sélectionnée
        function updateZoneDetails() {
            const zoneSelect = document.getElementById('zone-concerned');
            const detailsDiv = document.getElementById('zone-details');
            
            if (!zoneSelect || !detailsDiv) return;
            
            const selectedZoneId = zoneSelect.value;
            const selectedZone = validatedZones.find(z => z.id == selectedZoneId);
            
            if (selectedZone) {
                const surfaceTypeText = selectedZone.type === 'autres' ? selectedZone.typeOther : selectedZone.type;
                detailsDiv.innerHTML = `
                    <div style="display: flex; flex-direction: column; gap: 0.25rem;">
                        <div><strong>${selectedZone.name}</strong></div>
                        <div style="font-size: 0.9rem; color: var(--gray-700);">
                            ${selectedZone.description || 'Aucune description'}
                        </div>
                        <div style="display: flex; gap: 1rem; font-size: 0.85rem; margin-top: 0.5rem;">
                            <span style="color: var(--primary-blue);">🔧 ${surfaceTypeText || 'Non spécifié'}</span>
                            <span style="color: var(--primary-red);">📏 ${selectedZone.surface.toFixed(0)} m²</span>
                            <span style="color: var(--primary-blue);">⏰ ${selectedZone.hours} h</span>
                        </div>
                    </div>
                `;
                detailsDiv.style.color = 'var(--gray-900)';
                detailsDiv.style.fontStyle = 'normal';
            } else {
                detailsDiv.innerHTML = 'Aucune zone sélectionnée';
                detailsDiv.style.color = 'var(--gray-600)';
                detailsDiv.style.fontStyle = 'italic';
            }
        }

        // Gérer le changement de type de traitement
        function handleTraitementTypeChange() {
            const traitementSelect = document.getElementById('traitement-type');
            const autreGroup = document.getElementById('traitement-autre-group');
            
            if (traitementSelect.value === 'autre') {
                autreGroup.style.display = 'block';
            } else {
                autreGroup.style.display = 'none';
                document.getElementById('traitement-autre').value = '';
            }
        }

        // Gérer le changement de système de peinture
        function handleSystemePeintureChange() {
            const systemeSelect = document.getElementById('systeme-peinture');
            const autreGroup = document.getElementById('systeme-peinture-autre-group');
            
            if (systemeSelect.value === 'autre-systeme') {
                autreGroup.style.display = 'block';
            } else {
                autreGroup.style.display = 'none';
                document.getElementById('systeme-peinture-autre').value = '';
            }
        }

        // Valider les spécifications matériaux
        function validateMaterialSpecs() {
            const zoneSelect = document.getElementById('zone-concerned');
            const selectedZoneId = zoneSelect.value;
            
            if (!selectedZoneId) {
                showNotification('Veuillez d\'abord sélectionner une zone', 'error');
                return;
            }
            
            const selectedZone = validatedZones.find(z => z.id == selectedZoneId);
            if (!selectedZone) {
                showNotification('Zone sélectionnée introuvable', 'error');
                return;
            }
            
            // Récupérer les données du formulaire
            const systemePeinture = document.getElementById('systeme-peinture').value;
            const systemePeintureAutre = document.getElementById('systeme-peinture-autre').value;
            
            const materialData = {
                zoneId: selectedZoneId,
                zoneName: selectedZone.name,
                // Données depuis l'onglet "Surface et Environnement"
                traitementType: document.getElementById('traitement-type').value,
                traitementAutre: document.getElementById('traitement-autre').value,
                typeTravaux: document.getElementById('type-travaux').value,
                expositionConditions: document.getElementById('exposition-conditions').value,
                // Données depuis l'onglet "Matériaux"
                systemePeinture: systemePeinture === 'autre-systeme' ? systemePeintureAutre : systemePeinture,
                ral: document.getElementById('ral').value,
                fournisseur: document.getElementById('fournisseur-global').value,
                validatedAt: new Date().toISOString()
            };
            
            // Validation des champs obligatoires
            if (!materialData.traitementType || !materialData.typeTravaux || !materialData.expositionConditions || !materialData.systemePeinture) {
                showNotification('Veuillez remplir tous les champs obligatoires', 'error');
                return;
            }
            
            // Validation spécifique pour "Autre système"
            if (systemePeinture === 'autre-systeme' && !systemePeintureAutre.trim()) {
                showNotification('Veuillez préciser le système de peinture', 'error');
                return;
            }
            
            // Sauvegarder les spécifications (ici on pourrait les stocker dans un objet global)
            if (!window.materialSpecs) {
                window.materialSpecs = [];
            }
            
            // Supprimer les anciennes spécifications pour cette zone
            window.materialSpecs = window.materialSpecs.filter(spec => spec.zoneId !== selectedZoneId);
            
            // Ajouter les nouvelles spécifications
            window.materialSpecs.push(materialData);
            
            showNotification(`Spécifications validées pour la zone "${selectedZone.name}"`, 'success');
            
            // Optionnel : réinitialiser le formulaire
            // resetMaterialForm();
        }

        // Fonction pour ajouter une nouvelle ligne dans le tableau des matériels demandés
        function addApprovisionnementRow(button) {
            const tbody = document.getElementById('approvisionnement-materiels-tbody');
            const currentRows = tbody.querySelectorAll('tr');
            const newRowNumber = currentRows.length + 1;
            
            const newRow = document.createElement('tr');
            newRow.innerHTML = `
                <td>${newRowNumber}</td>
                <td><input type="text" class="form-input" placeholder="Descriptif détaillé du matériel" style="width: 100%;"></td>
                <td><input type="number" class="form-input" value="0" min="0" style="width: 100%;"></td>
                <td><input type="date" class="form-input" style="width: 100%;"></td>
                <td><input type="date" class="form-input" style="width: 100%;"></td>
                <td><input type="text" class="form-input" placeholder="Immatriculation" style="width: 100%;"></td>
                <td><button class="btn btn-small btn-success" onclick="addApprovisionnementRow(this)">➕</button></td>
            `;
            
            tbody.appendChild(newRow);
        }

        // Fonction de test pour les sections collapsibles
        function testCollapsibleSections() {
            console.log('🧪 Test des sections collapsibles...');
            const headers = document.querySelectorAll('.collapsible-header');
            console.log(`📊 ${headers.length} sections trouvées:`);
            
            headers.forEach((header, index) => {
                console.log(`${index + 1}. "${header.textContent.trim()}"`);
                const content = header.nextElementSibling;
                if (content && content.classList.contains('collapsible-content')) {
                    console.log(`   ✅ Contenu associé trouvé`);
                } else {
                    console.log(`   ❌ Pas de contenu associé`);
                }
            });
            
            // Tester le clic sur la première section
            if (headers.length > 0) {
                console.log('🖱️ Test de clic sur la première section...');
                headers[0].click();
            }
        }

        // Fonction pour forcer l'ouverture d'une section
        function openCollapsibleSection(sectionTitle) {
            const headers = document.querySelectorAll('.collapsible-header');
            for (let header of headers) {
                if (header.textContent.includes(sectionTitle)) {
                    header.classList.add('active');
                    const content = header.nextElementSibling;
                    if (content) {
                        content.style.display = 'block';
                        content.classList.add('active');
                    }
                    console.log(`✅ Section "${sectionTitle}" ouverte`);
                    return;
                }
            }
            console.log(`❌ Section "${sectionTitle}" non trouvée`);
        }

        // Fonction pour imprimer la fiche d'approvisionnement
        function printSupplyForm() {
            const printContent = document.getElementById('supply-form-content');
            if (!printContent) {
                console.error('❌ Contenu de la fiche d\'approvisionnement non trouvé');
                return;
            }

            // Créer une nouvelle fenêtre pour l'impression
            const printWindow = window.open('', '_blank');
            
            // HTML simple et efficace pour l'impression A4 paysage
            printWindow.document.write(`
                <!DOCTYPE html>
                <html lang="fr">
                <head>
                    <meta charset="UTF-8">
                    <meta name="viewport" content="width=device-width, initial-scale=1.0">
                    <title>FICHE DE DEMANDE D'APPROVISIONNEMENT</title>
                    <style>
                        @page {
                            size: A4 landscape;
                            margin: 1cm;
                        }
                        
                        body {
                            font-family: Arial, sans-serif;
                            font-size: 12px;
                            line-height: 1.4;
                            color: black;
                            background: white;
                            margin: 0;
                            padding: 0;
                        }
                        
                        .header {
                            text-align: center;
                            font-size: 18px;
                            font-weight: bold;
                            color: #dc2626;
                            border-bottom: 2px solid #dc2626;
                            padding-bottom: 10px;
                            margin-bottom: 20px;
                        }
                        
                        .content {
                            display: table;
                            width: 100%;
                        }
                        
                        .left-column, .right-column {
                            display: table-cell;
                            width: 50%;
                            vertical-align: top;
                            padding: 0 10px;
                        }
                        
                        .section {
                            margin-bottom: 15px;
                            border: 1px solid #ccc;
                            padding: 8px;
                            background: #f9f9f9;
                        }
                        
                        .section-title {
                            font-size: 14px;
                            font-weight: bold;
                            color: #dc2626;
                            margin-bottom: 8px;
                            border-left: 3px solid #dc2626;
                            padding-left: 8px;
                        }
                        
                        .field-row {
                            display: table;
                            width: 100%;
                            margin-bottom: 5px;
                        }
                        
                        .field {
                            display: table-cell;
                            vertical-align: top;
                            padding: 2px;
                        }
                        
                        .field-label {
                            font-weight: bold;
                            font-size: 10px;
                            color: #333;
                        }
                        
                        .field-value {
                            border-bottom: 1px solid black;
                            min-height: 18px;
                            padding: 2px;
                            font-size: 11px;
                        }
                        
                        .radio-group {
                            display: inline-block;
                            margin-right: 15px;
                        }
                        
                        .radio-item {
                            display: inline-block;
                            margin-right: 8px;
                        }
                        
                        .table-section {
                            margin-top: 20px;
                            page-break-inside: avoid;
                        }
                        
                        .table {
                            width: 100%;
                            border-collapse: collapse;
                            font-size: 10px;
                        }
                        
                        .table th {
                            background: #dc2626;
                            color: white;
                            padding: 6px;
                            border: 1px solid black;
                            font-weight: bold;
                        }
                        
                        .table td {
                            padding: 4px;
                            border: 1px solid black;
                            text-align: left;
                        }
                        
                        .comments {
                            border: 1px solid black;
                            min-height: 60px;
                            padding: 5px;
                            font-size: 11px;
                        }
                        
                        @media print {
                            body { -webkit-print-color-adjust: exact; }
                        }
                    </style>
                </head>
                <body>
                    <div class="header">
                        FICHE DE DEMANDE D'APPROVISIONNEMENT
                    </div>
                    
                    <div class="content">
                        <div class="left-column">
                            <div class="section">
                                <div class="section-title">📝 Informations Générales</div>
                                <div class="field-row">
                                    <div class="field" style="width: 33%;">
                                        <div class="field-label">Agence</div>
                                        <div class="field-value">${document.getElementById('approvisionnement-agence')?.value || ''}</div>
                                    </div>
                                    <div class="field" style="width: 33%;">
                                        <div class="field-label">Demandeur</div>
                                        <div class="field-value">${document.getElementById('approvisionnement-demandeur')?.value || ''}</div>
                                    </div>
                                    <div class="field" style="width: 34%;">
                                        <div class="field-label">Date demande</div>
                                        <div class="field-value">${document.getElementById('approvisionnement-date-demande')?.value || ''}</div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="section">
                                <div class="section-title">🚚 Livraison</div>
                                <div class="field-row">
                                    <div class="field" style="width: 60%;">
                                        <div class="field-label">Adresse</div>
                                        <div class="field-value" style="min-height: 40px;">${document.getElementById('approvisionnement-adresse')?.value || ''}</div>
                                    </div>
                                    <div class="field" style="width: 40%;">
                                        <div class="field-label">Contact chantier</div>
                                        <div class="field-value">${document.getElementById('approvisionnement-contact-chantier')?.value || ''}</div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="section">
                                <div class="section-title">🏗️ Informations Chantier</div>
                                <div class="field-row">
                                    <div class="field" style="width: 40%;">
                                        <div class="field-label">N° chantier / OTP</div>
                                        <div class="field-value">${document.getElementById('approvisionnement-otp')?.value || ''}</div>
                                    </div>
                                    <div class="field" style="width: 30%;">
                                        <div class="field-label">Accès chantier</div>
                                        <div class="field-value">
                                            <div class="radio-group">
                                                <div class="radio-item">
                                                    <input type="radio" ${document.querySelector('input[name="acces-chantier"][value="oui"]')?.checked ? 'checked' : ''}> Oui
                                                </div>
                                                <div class="radio-item">
                                                    <input type="radio" ${document.querySelector('input[name="acces-chantier"][value="non"]')?.checked ? 'checked' : ''}> Non
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="field" style="width: 30%;">
                                        <div class="field-label">Carte identité</div>
                                        <div class="field-value">
                                            <div class="radio-group">
                                                <div class="radio-item">
                                                    <input type="radio" ${document.querySelector('input[name="carte-identite"][value="oui"]')?.checked ? 'checked' : ''}> Oui
                                                </div>
                                                <div class="radio-item">
                                                    <input type="radio" ${document.querySelector('input[name="carte-identite"][value="non"]')?.checked ? 'checked' : ''}> Non
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="right-column">
                            <div class="section">
                                <div class="section-title">🚛 Moyen de déchargement</div>
                                <div class="field-row">
                                    <div class="field" style="width: 50%;">
                                        <div class="field-label">Chariot élévateur</div>
                                        <div class="field-value">
                                            <div class="radio-group">
                                                <div class="radio-item">
                                                    <input type="radio" ${document.querySelector('input[name="chariot-elevateur"][value="oui"]')?.checked ? 'checked' : ''}> Oui
                                                </div>
                                                <div class="radio-item">
                                                    <input type="radio" ${document.querySelector('input[name="chariot-elevateur"][value="non"]')?.checked ? 'checked' : ''}> Non
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="field" style="width: 50%;">
                                        <div class="field-label">Grue</div>
                                        <div class="field-value">
                                            <div class="radio-group">
                                                <div class="radio-item">
                                                    <input type="radio" ${document.querySelector('input[name="grue"][value="oui"]')?.checked ? 'checked' : ''}> Oui
                                                </div>
                                                <div class="radio-item">
                                                    <input type="radio" ${document.querySelector('input[name="grue"][value="non"]')?.checked ? 'checked' : ''}> Non
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="field-row">
                                    <div class="field" style="width: 50%;">
                                        <div class="field-label">Téléscopie</div>
                                        <div class="field-value">
                                            <div class="radio-group">
                                                <div class="radio-item">
                                                    <input type="radio" ${document.querySelector('input[name="telescopie"][value="oui"]')?.checked ? 'checked' : ''}> Oui
                                                </div>
                                                <div class="radio-item">
                                                    <input type="radio" ${document.querySelector('input[name="telescopie"][value="non"]')?.checked ? 'checked' : ''}> Non
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="field" style="width: 50%;">
                                        <div class="field-label">Transpalette</div>
                                        <div class="field-value">
                                            <div class="radio-group">
                                                <div class="radio-item">
                                                    <input type="radio" ${document.querySelector('input[name="transpalette"][value="oui"]')?.checked ? 'checked' : ''}> Oui
                                                </div>
                                                <div class="radio-item">
                                                    <input type="radio" ${document.querySelector('input[name="transpalette"][value="non"]')?.checked ? 'checked' : ''}> Non
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="section">
                                <div class="section-title">⏰ Délai de Préparation</div>
                                <div class="field-row">
                                    <div class="field" style="width: 100%;">
                                        <div class="field-label">NDP</div>
                                        <div class="field-value">
                                            <div class="radio-group">
                                                <div class="radio-item">
                                                    <input type="radio" ${document.querySelector('input[name="delai-preparation"][value="critique-24h"]')?.checked ? 'checked' : ''}> 1 / Très Critique 24/48h
                                                </div>
                                                <div class="radio-item">
                                                    <input type="radio" ${document.querySelector('input[name="delai-preparation"][value="critique-10j"]')?.checked ? 'checked' : ''}> 2 / Critique ≤ 10 jours
                                                </div>
                                                <div class="radio-item">
                                                    <input type="radio" ${document.querySelector('input[name="delai-preparation"][value="non-critique-15j"]')?.checked ? 'checked' : ''}> 3 / Non Critique 15 jours
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="section">
                                <div class="section-title">💬 Commentaires</div>
                                <div class="comments">
                                    ${document.getElementById('approvisionnement-commentaires')?.value || ''}
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="table-section">
                        <div class="section">
                            <div class="section-title">📦 Matériels Demandés</div>
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th style="width: 8%;">Item n°</th>
                                        <th style="width: 35%;">Type matériel / Descriptif</th>
                                        <th style="width: 10%;">Qté</th>
                                        <th style="width: 15%;">A disposition pour le</th>
                                        <th style="width: 15%;">Retour estimé le</th>
                                        <th style="width: 17%;">Immatriculations machines</th>
                                    </tr>
                                </thead>
                                <tbody id="print-materiels-tbody">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </body>
                </html>
            `);

            // Remplir le tableau des matériels
            const tbody = printWindow.document.getElementById('print-materiels-tbody');
            const materielsTbody = document.getElementById('approvisionnement-materiels-tbody');
            if (materielsTbody && tbody) {
                const rows = materielsTbody.querySelectorAll('tr');
                rows.forEach((row, index) => {
                    const inputs = row.querySelectorAll('input');
                    if (inputs.length >= 6) {
                        const newRow = printWindow.document.createElement('tr');
                        newRow.innerHTML = `
                            <td style="text-align: center; font-weight: bold;">${index + 1}</td>
                            <td>${inputs[0]?.value || ''}</td>
                            <td style="text-align: center;">${inputs[1]?.value || ''}</td>
                            <td>${inputs[2]?.value || ''}</td>
                            <td>${inputs[3]?.value || ''}</td>
                            <td>${inputs[4]?.value || ''}</td>
                        `;
                        tbody.appendChild(newRow);
                    }
                });
            }

            // Fermer le document et lancer l'impression
            printWindow.document.close();
            printWindow.focus();
            
            // Attendre que le contenu soit chargé puis imprimer
            setTimeout(() => {
                printWindow.print();
                printWindow.close();
            }, 500);
        }

        // Fonction pour afficher les détails des nacelles sélectionnées
        function showNacelleDetails(checkbox) {
            const detailsDiv = document.getElementById('nacelle-details');
            const contentDiv = document.getElementById('nacelle-details-content');
            
            if (!detailsDiv || !contentDiv) return;
            
            // Récupérer toutes les nacelles cochées
            const checkedNacelles = document.querySelectorAll('input[name="nacelle"]:checked');
            
            if (checkedNacelles.length === 0) {
                detailsDiv.style.display = 'none';
                return;
            }
            
            // Afficher la section
            detailsDiv.style.display = 'block';
            
            // Générer le contenu
            let content = '';
            checkedNacelles.forEach((nacelle, index) => {
                const nacelleName = nacelle.nextElementSibling.textContent;
                const nacelleValue = nacelle.value;
                
                content += `
                    <div style="margin-bottom: 1rem; padding: 1rem; background: white; border-radius: 0.5rem; border: 1px solid var(--gray-200);">
                        <h6 style="margin-bottom: 0.5rem; color: var(--primary-blue);">${nacelleName}</h6>
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem;">
                            <div class="form-group">
                                <label class="form-label">Type d'énergie :</label>
                                <select class="form-select" name="nacelle-${nacelleValue}-energie">
                                    <option value="">Sélectionner</option>
                                    <option value="electrique">Électrique</option>
                                    <option value="diesel">Diesel</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Hauteur souhaitée (m) :</label>
                                <input type="number" class="form-input" name="nacelle-${nacelleValue}-hauteur" placeholder="Ex: 15" min="0">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Quantité :</label>
                                <input type="number" class="form-input" name="nacelle-${nacelleValue}-quantite" value="1" min="1">
                            </div>
                        </div>
                    </div>
                `;
            });
            
            contentDiv.innerHTML = content;
        }

        // Fonction pour afficher le champ de précision pour "autres"
        function showAutresDetails(checkbox) {
            const detailsDiv = document.getElementById('autres-precise-details');
            if (!detailsDiv) return;
            
            if (checkbox.checked) {
                detailsDiv.style.display = 'block';
            } else {
                detailsDiv.style.display = 'none';
            }
        }

        // Fonction pour gérer l'affichage du formulaire atelier
        function toggleAtelierForm() {
            const atelierChoice = document.querySelector('input[name="atelier-choice"]:checked');
            const atelierDetailsForm = document.getElementById('atelier-details-form');
            
            if (atelierChoice && atelierDetailsForm) {
                if (atelierChoice.value === 'oui') {
                    atelierDetailsForm.style.display = 'block';
                } else {
                    atelierDetailsForm.style.display = 'none';
                }
            }
        }

        // Fonction pour calculer le total des pièces atelier
        function calculateAtelierTotal() {
            const nbPieces = parseFloat(document.getElementById('atelier-nb-pieces')?.value || 0);
            const prixPiece = parseFloat(document.getElementById('atelier-prix-piece')?.value || 0);
            const total = nbPieces * prixPiece;
            
            const totalElement = document.getElementById('atelier-total');
            if (totalElement) {
                totalElement.value = total.toFixed(2) + ' €';
            }
        }
    </script>
</body>
</html>

