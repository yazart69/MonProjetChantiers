<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Planning Booster - Équipe 41</title>
    <style>
        :root {
            --sidebar-width: 280px;
            --primary-red: #dc2626; --primary-orange: #ea580c; --primary-blue: #2563eb;
            --success: #16a34a; --warning: #d97706; --danger: #dc2626; --info: #0ea5e9; --purple: #7c3aed;
            --gray-50: #f9fafb; --gray-100: #f3f4f6; --gray-200: #e5e7eb; --gray-300: #d1d5db;
            --gray-700: #374151; --gray-900: #111827; --white: #ffffff;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05); --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1); --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', sans-serif; background: linear-gradient(135deg, var(--gray-50) 0%, #e0e7ff 100%); color: var(--gray-900); line-height: 1.6; overflow-x: hidden; }
        .sidebar { position: fixed; top: 0; left: 0; width: var(--sidebar-width); height: 100vh; background: #000000; color: white; z-index: 1000; overflow-y: auto; transition: transform 0.3s ease-in-out; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .sidebar-header { padding: 2rem 1.5rem; text-align: center; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .sidebar-logo { font-size: 1.5rem; font-weight: bold; margin-bottom: 0.5rem; }
        .sidebar-subtitle { font-size: 0.9rem; opacity: 0.8; }
        .sidebar-nav { padding: 1rem 0; }
        .nav-section { margin-bottom: 2rem; }
        .nav-section-title { padding: 0 1.5rem 0.5rem; font-size: 0.8rem; font-weight: 600; text-transform: uppercase; opacity: 0.7; }
        .nav-item { display: block; padding: 0.75rem 1.5rem; color: white; text-decoration: none; transition: all 0.3s ease; border-left: 3px solid transparent; position: relative; }
        .nav-item:hover, .nav-item.active { background: rgba(255,255,255,0.1); border-left-color: #dc2626; transform: translateX(5px); }
        .nav-item .icon { display: inline-block; width: 1.5rem; margin-right: 0.75rem; text-align: center; }
        .main-content { margin-left: var(--sidebar-width); min-height: 100vh; padding: 2rem; transition: margin-left 0.3s ease-in-out; }
        .page-header { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(20px); border-radius: 1.5rem; padding: 2rem; margin-bottom: 2rem; box-shadow: var(--shadow-xl); border: 1px solid rgba(255, 255, 255, 0.2); position: relative; overflow: hidden; }
        .page-header::before { content: ''; position: absolute; top: 0; right: 0; width: 300px; height: 300px; background: linear-gradient(135deg, rgba(220, 38, 38, 0.15), rgba(234, 88, 12, 0.15)); border-radius: 50%; transform: translate(40%, -40%); }
        .header-content { position: relative; z-index: 2; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 2rem; }
        .page-title { font-size: 3rem; font-weight: 900; background: linear-gradient(135deg, var(--primary-red), var(--primary-orange)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; margin-bottom: 0.5rem; text-shadow: 2px 2px 4px rgba(0,0,0,0.1); }
        .page-subtitle { font-size: 1.2rem; color: var(--gray-700); font-weight: 500; }
        .controls-panel { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(20px); border-radius: 1.5rem; padding: 1.5rem; margin-bottom: 2rem; box-shadow: var(--shadow-lg); border: 1px solid rgba(255, 255, 255, 0.3); }
        .controls-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 2rem; align-items: center; }
        .control-group { display: flex; flex-direction: column; gap: 0.75rem; }
        .control-group label { font-weight: 600; color: var(--gray-700); font-size: 0.9rem; text-transform: uppercase; letter-spacing: 0.5px; }
        .chantier-selector { position: relative; }
        .chantier-selector select { width: 100%; padding: 1rem; border: 2px solid var(--gray-200); border-radius: 1rem; font-size: 1rem; font-weight: 500; background: white; transition: all 0.3s ease; appearance: none; cursor: pointer; }
        .chantier-selector::after { content: '▼'; position: absolute; right: 1rem; top: 50%; transform: translateY(-50%); color: var(--primary-red); font-size: 0.8rem; pointer-events: none; }
        .chantier-selector select:focus { outline: none; border-color: var(--primary-red); box-shadow: 0 0 0 3px rgba(220, 38, 38, 0.1); }
        .view-modes { display: flex; gap: 0.5rem; background: var(--gray-100); padding: 0.5rem; border-radius: 1rem; }
        .view-btn { flex: 1; padding: 0.75rem 1rem; border: none; border-radius: 0.75rem; font-weight: 600; font-size: 0.9rem; cursor: pointer; transition: all 0.3s ease; background: transparent; color: var(--gray-700); }
        .view-btn.active { background: linear-gradient(135deg, var(--primary-red), var(--primary-orange)); color: white; box-shadow: var(--shadow-md); transform: translateY(-1px); }
        .action-buttons { display: flex; gap: 1rem; justify-content: center; }
        .btn { padding: 1rem 1.5rem; border: none; border-radius: 1rem; font-weight: 600; font-size: 1rem; cursor: pointer; transition: all 0.3s ease; text-decoration: none; display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem; position: relative; overflow: hidden; min-width: 120px; }
        .btn::before { content: ''; position: absolute; top: 0; left: -100%; width: 100%; height: 100%; background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent); transition: left 0.5s; }
        .btn:hover::before { left: 100%; }
        .btn:hover { transform: translateY(-2px); box-shadow: var(--shadow-xl); }
        .btn-success { background: linear-gradient(135deg, var(--success), #059669); color: white; }
        .btn-gradient { background: linear-gradient(135deg, var(--primary-red), var(--primary-orange)); color: white; }
        .gantt-container { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(20px); border-radius: 1.5rem; padding: 2rem; margin-bottom: 2rem; box-shadow: var(--shadow-xl); border: 1px solid rgba(255, 255, 255, 0.3); overflow: hidden; }
        .gantt-header { display: grid; grid-template-columns: 300px 1fr; background: linear-gradient(135deg, var(--primary-red), var(--primary-orange)); color: white; font-weight: 700; border-radius: 1rem 1rem 0 0; overflow: hidden; }
        .gantt-task-header { display: flex; align-items: center; padding: 1.5rem 2rem; font-size: 1.1rem; background: rgba(0,0,0,0.1); }
        .gantt-dates-header { display: flex; overflow-x: auto; }
        .gantt-date-cell { flex-shrink: 0; padding: 1rem; text-align: center; font-size: 0.9rem; font-weight: 600; border-left: 1px solid rgba(255,255,255,0.2); min-width: 80px; }
        .gantt-date-cell.weekend { background: rgba(0,0,0,0.1); }
        .gantt-body { max-height: 600px; overflow-y: auto; }
        .gantt-row { display: grid; grid-template-columns: 300px 1fr; min-height: 80px; border-bottom: 1px solid var(--gray-200); transition: background-color 0.2s ease; }
        .gantt-row:hover { background: var(--gray-50); }
        .gantt-task-cell { display: flex; flex-direction: column; justify-content: center; padding: 1rem 2rem; background: rgba(248, 250, 252, 0.8); border-right: 2px solid var(--gray-200); cursor: pointer; transition: all 0.3s ease; }
        .gantt-task-cell:hover { background: rgba(220, 38, 38, 0.05); border-right-color: var(--primary-red); }
        .gantt-task-name { font-weight: 700; font-size: 1.05rem; color: var(--gray-900); margin-bottom: 0.25rem; }
        .gantt-task-responsable { font-size: 0.85rem; color: var(--gray-700); margin-bottom: 0.25rem; }
        .gantt-task-meta { display: flex; gap: 1rem; font-size: 0.75rem; color: var(--gray-600); }
        .gantt-chart-cell { position: relative; padding: 1rem 0; background: linear-gradient(to right, var(--gray-200) 1px, transparent 1px); background-size: 80px 100%; }
        .gantt-bar { position: absolute; height: 40px; top: 50%; transform: translateY(-50%); border-radius: 20px; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; font-weight: 700; color: white; padding: 0 1rem; box-shadow: 0 4px 12px rgba(0,0,0,0.2); cursor: pointer; overflow: hidden; transition: all 0.3s ease; backdrop-filter: blur(10px); }
        .gantt-bar:hover { transform: translateY(-50%) scale(1.05); box-shadow: 0 8px 25px rgba(0,0,0,0.3); }
        .gantt-bar-planifie { background: linear-gradient(135deg, var(--primary-blue), #1e40af); }
        .gantt-bar-en-cours { background: linear-gradient(135deg, var(--success), #059669); }
        .gantt-bar-en-retard { background: linear-gradient(135deg, var(--danger), #b91c1c); }
        .gantt-bar-termine { background: linear-gradient(135deg, #14532d, #166534); }
        .gantt-bar-travaux-sup { background: linear-gradient(135deg, var(--purple), #6d28d9); }
        .gantt-progress { position: absolute; left: 0; top: 0; height: 100%; background: rgba(255,255,255,0.3); border-radius: 20px; transition: width 0.8s ease; }
        .dashboard { display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 2rem; }
        .dashboard-card { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(20px); border-radius: 1.5rem; padding: 2rem; box-shadow: var(--shadow-xl); border: 1px solid rgba(255, 255, 255, 0.3); position: relative; overflow: hidden; }
        .dashboard-card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 4px; background: linear-gradient(90deg, var(--primary-red), var(--primary-orange)); }
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; }
        .card-title { font-size: 1.2rem; font-weight: 700; color: var(--gray-900); display: flex; align-items: center; gap: 0.5rem; }
        .card-icon { font-size: 1.5rem; }
        .metric-value { font-size: 2.5rem; font-weight: 900; color: var(--primary-red); margin-bottom: 0.5rem; }
        .metric-label { color: var(--gray-700); font-size: 0.9rem; }
        .progress-ring { width: 120px; height: 120px; margin: 0 auto 1rem; }
        .progress-ring-circle { fill: none; stroke-width: 8; stroke-linecap: round; transform: rotate(-90deg); transform-origin: 50% 50%; }
        .progress-ring-bg { stroke: var(--gray-200); }
        .progress-ring-fill { stroke: url(#gradient); stroke-dasharray: 314; stroke-dashoffset: 314; transition: stroke-dashoffset 1s ease; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; margin-bottom: 2rem; }
        .stat-card { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(20px); border-radius: 1rem; padding: 1.5rem; box-shadow: var(--shadow-md); border: 1px solid rgba(255, 255, 255, 0.3); transition: all 0.3s ease; }
        .stat-card:hover { transform: translateY(-5px); box-shadow: var(--shadow-xl); }
        .stat-icon { width: 50px; height: 50px; border-radius: 1rem; background: linear-gradient(135deg, var(--primary-red), var(--primary-orange)); display: flex; align-items: center; justify-content: center; color: white; font-size: 1.2rem; margin-bottom: 1rem; }
        .stat-title { font-size: 0.8rem; color: var(--gray-700); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 0.5rem; }
        .stat-value { font-size: 1.8rem; font-weight: 800; color: var(--gray-900); }
        .stat-value-editable { display: flex; align-items: center; font-size: 1.8rem; font-weight: 800; color: var(--gray-900); }
        .stat-value-editable .stat-input { font-family: inherit; font-size: inherit; font-weight: inherit; color: inherit; border: none; background: transparent; width: 100%; text-align: left; padding: 0; }
        .stat-value-editable .stat-input:focus { outline: none; background: rgba(220, 38, 38, 0.05); border-radius: 0.5rem; }
        .stat-input::-webkit-outer-spin-button, .stat-input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        .stat-input[type=number] { -moz-appearance: textfield; }
        .timeline-card { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(20px); border-radius: 1.5rem; padding: 2rem; box-shadow: var(--shadow-xl); border: 1px solid rgba(255, 255, 255, 0.3); margin-bottom: 2rem; }
        .timeline { position: relative; padding-left: 2rem; }
        .timeline::before { content: ''; position: absolute; left: 1rem; top: 0; bottom: 0; width: 2px; background: linear-gradient(180deg, var(--primary-red), var(--primary-orange)); }
        .timeline-item { position: relative; margin-bottom: 2rem; padding-left: 2rem; }
        .timeline-item::before { content: ''; position: absolute; left: -0.5rem; top: 0.5rem; width: 12px; height: 12px; background: var(--primary-red); border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .timeline-date { font-size: 0.8rem; color: var(--primary-red); font-weight: 600; margin-bottom: 0.25rem; }
        .timeline-title { font-weight: 700; color: var(--gray-900); margin-bottom: 0.25rem; }
        .timeline-desc { font-size: 0.9rem; color: var(--gray-700); }
        .chantier-management-panel { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(20px); border-radius: 1.5rem; padding: 2rem; box-shadow: var(--shadow-xl); border: 1px solid rgba(255, 255, 255, 0.3); }
        .chantier-management-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1rem; }
        .chantier-management-item { display: flex; justify-content: space-between; align-items: center; padding: 1rem; background: var(--gray-50); border-radius: 1rem; border: 1px solid var(--gray-200); }
        .chantier-management-item span { font-weight: 600; }
        .btn-delete-chantier { background: var(--danger); color: white; border: none; border-radius: 0.5rem; padding: 0.5rem 0.75rem; cursor: pointer; transition: all 0.2s ease; }
        .btn-delete-chantier:hover { background: #b91c1c; transform: scale(1.05); }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); backdrop-filter: blur(10px); z-index: 2000; align-items: center; justify-content: center; }
        .modal-content { background: rgba(255, 255, 255, 0.98); backdrop-filter: blur(20px); border-radius: 1.5rem; padding: 2rem; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto; box-shadow: var(--shadow-xl); border: 1px solid rgba(255, 255, 255, 0.3); animation: modalSlideIn 0.4s ease; }
        @keyframes modalSlideIn { from { opacity: 0; transform: translateY(-50px) scale(0.95); } to { opacity: 1; transform: translateY(0) scale(1); } }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; }
        .modal-title { font-size: 1.5rem; font-weight: 700; color: var(--gray-900); }
        .modal-close { background: none; border: none; font-size: 1.5rem; color: var(--gray-700); cursor: pointer; padding: 0.5rem; border-radius: 0.5rem; transition: all 0.2s ease; }
        .modal-close:hover { background: var(--gray-100); color: var(--gray-900); }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; margin-bottom: 2rem; }
        .form-group { display: flex; flex-direction: column; gap: 0.5rem; }
        .form-label { font-weight: 600; color: var(--gray-900); font-size: 0.9rem; }
        .form-input, .form-select { padding: 1rem; border: 2px solid var(--gray-200); border-radius: 1rem; font-size: 1rem; transition: all 0.3s ease; background: rgba(255, 255, 255, 0.8); }
        .form-input:focus, .form-select:focus { outline: none; border-color: var(--primary-red); box-shadow: 0 0 0 3px rgba(220, 38, 38, 0.1); }
        .range-group { display: flex; align-items: center; gap: 1rem; }
        .range-input { flex: 1; -webkit-appearance: none; height: 8px; border-radius: 5px; background: var(--gray-200); outline: none; }
        .range-input::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 20px; height: 20px; border-radius: 50%; background: var(--primary-red); cursor: pointer; box-shadow: 0 2px 6px rgba(0,0,0,0.2); }
        .range-value { min-width: 40px; font-weight: 600; color: var(--primary-red); }
        .modal-actions { display: flex; gap: 1rem; justify-content: flex-end; margin-top: 2rem; }
        
        @media (max-width: 1024px) {
            .controls-grid { grid-template-columns: 1fr; gap: 1rem; }
            .dashboard { grid-template-columns: 1fr; }
        }
        @media (max-width: 768px) {
            .sidebar { transform: translateX(-100%); }
            .main-content { margin-left: 0; padding: 1rem; }
            .page-title { font-size: 2rem; }
            .stats-grid { grid-template-columns: 1fr; }
            .action-buttons { flex-direction: column; }
        }
    </style>
</head>
<body>
    <nav class="sidebar">
        <div class="sidebar-header">
            <div class="sidebar-logo">🏗️ Gestionnaire Chantier</div>
            <div class="sidebar-subtitle">Équipe 41 - Chasse sur Rhône</div>
        </div>
        <div class="sidebar-nav">
            <div class="nav-section">
                <div class="nav-section-title">Principal</div>
                <a href="index.html" class="nav-item"><span class="icon">🏠</span> Tableau de Bord</a>
                <a href="planning.html" class="nav-item active"><span class="icon">📅</span> Planning</a>
                <a href="pointage.html" class="nav-item"><span class="icon">⏰</span> Pointage</a>
            </div>
            <div class="nav-section">
                <div class="nav-section-title">Gestion</div>
                <a href="equipe.html" class="nav-item"><span class="icon">👥</span> Équipe</a>
                <a href="materiaux.html" class="nav-item"><span class="icon">🔧</span> Travaux & Matériaux</a>
                <a href="reunion.html" class="nav-item"><span class="icon">🗓️</span> Réunions</a>
            </div>
        </div>
    </nav>

    <main class="main-content">
        <div class="page-header">
            <div class="header-content">
                <div>
                    <h1 class="page-title">📅 Planning Booster</h1>
                    <p class="page-subtitle">Gestion avancée des projets • Équipe 41 Altrad Prezioso</p>
                </div>
                <div id="chantier-info" class="card-title">
                    <span class="card-icon">🏗️</span>
                    <span id="chantier-name"></span>
                </div>
            </div>
        </div>

        <div class="controls-panel">
            <div class="controls-grid">
                <div class="control-group">
                    <label>Chantier</label>
                    <div class="chantier-selector">
                        <select id="chantierSelect"></select>
                    </div>
                </div>
                <div class="control-group">
                    <label>Vue</label>
                    <div class="view-modes">
                        <button class="view-btn" id="viewDay">Jour</button>
                        <button class="view-btn active" id="viewWeek">Semaine</button>
                        <button class="view-btn" id="viewMonth">Mois</button>
                    </div>
                </div>
                <div class="control-group">
                    <label>Actions</label>
                    <div class="action-buttons">
                        <button class="btn btn-gradient" id="addTaskBtn">➕ Nouvelle Tâche</button>
                        <button class="btn btn-success" onclick="window.print()">🖨️ Imprimer</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon">⏱️</div>
                <div class="stat-title">Heures Passées</div>
                <div class="stat-value" id="heures-passees">0h</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">💰</div>
                <div class="stat-title">Budget Heures</div>
                <div class="stat-value-editable">
                     <input type="number" id="budget-heures-input" class="stat-input" value="0">
                     <span>h</span>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">📋</div>
                <div class="stat-title">Tâches Terminées</div>
                <div class="stat-value" id="taches-terminees">0/0</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">📈</div>
                <div class="stat-title">Progression</div>
                <div class="stat-value" id="progression-globale">0%</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">⚡</div>
                <div class="stat-title">Productivité</div>
                <div class="stat-value" id="productivite">0 h/j</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">🎯</div>
                <div class="stat-title">Statut</div>
                <div class="stat-value" id="statut-projet">N/A</div>
            </div>
        </div>

        <div class="dashboard">
            <div class="dashboard-card">
                <div class="card-header">
                    <h3 class="card-title"><span class="card-icon">📊</span> Progression Globale</h3>
                    <span class="metric-value" id="progress-percentage">0%</span>
                </div>
                <div style="text-align: center;">
                    <svg class="progress-ring" viewBox="0 0 120 120">
                        <defs>
                            <linearGradient id="gradient" x1="0%" y1="0%" x2="100%" y2="0%">
                                <stop offset="0%" style="stop-color:#dc2626"/>
                                <stop offset="100%" style="stop-color:#ea580c"/>
                            </linearGradient>
                        </defs>
                        <circle class="progress-ring-circle progress-ring-bg" cx="60" cy="60" r="50"/>
                        <circle class="progress-ring-circle progress-ring-fill" cx="60" cy="60" r="50" id="progress-circle"/>
                    </svg>
                </div>
                <div class="metric-label" style="text-align: center;">Avancement du projet</div>
            </div>

            <div class="dashboard-card">
                <div class="card-header">
                    <h3 class="card-title"><span class="card-icon">⏰</span> Budget Temps</h3>
                </div>
                <div style="margin-bottom: 2rem;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 1rem;">
                        <span class="metric-label">Heures passées</span>
                        <span class="metric-value" style="font-size: 1.2rem;" id="heures-detail">0h / 0h</span>
                    </div>
                    <div style="background: var(--gray-200); height: 8px; border-radius: 4px; overflow: hidden;">
                        <div id="budget-progress-bar" style="height: 100%; background: linear-gradient(90deg, var(--primary-red), var(--primary-orange)); width: 0%; transition: width 1s ease;"></div>
                    </div>
                </div>
                <div id="budget-status" class="metric-label" style="text-align: center; font-weight: 600;">...</div>
            </div>
        </div>

        <div class="gantt-container">
            <div class="gantt-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <h3 style="margin: 0; color: var(--gray-900); font-size: 1.5rem; font-weight: 700;">📊 Planning des Tâches</h3>
                <button class="btn btn-primary" onclick="printPlanningTable()" style="display: flex; align-items: center; gap: 0.5rem;">
                    🖨️ Imprimer le Planning
                </button>
            </div>
            <div id="gantt-chart"></div>
        </div>

        <div class="timeline-card">
            <div class="card-header">
                <h3 class="card-title"><span class="card-icon">📅</span> Prochaines Étapes</h3>
            </div>
            <div class="timeline" id="timeline"></div>
        </div>
        
        <div class="chantier-management-panel">
            <div class="card-header">
                <h3 class="card-title"><span class="card-icon">🗑️</span> Gestion des Chantiers</h3>
            </div>
            <div class="chantier-management-list" id="chantier-management-list"></div>
        </div>
    </main>

    <div id="taskModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="modal-title">➕ Nouvelle Tâche</h3>
                <button class="modal-close" onclick="closeTaskModal()">✕</button>
            </div>
            <form id="taskForm">
                <div class="form-grid">
                    <div class="form-group"><label class="form-label">Nom de la tâche *</label><input type="text" class="form-input" id="task-name" required></div>
                    <div class="form-group"><label class="form-label">Responsable *</label><select class="form-select" id="task-responsable" required></select></div>
                    <div class="form-group"><label class="form-label">Date de début *</label><input type="date" class="form-input" id="task-start-date" required></div>
                    <div class="form-group"><label class="form-label">Heures-Homme *</label><input type="number" class="form-input" id="task-hours" min="1" value="8" required></div>
                    <div class="form-group"><label class="form-label">Opérateurs *</label><input type="number" class="form-input" id="task-operators" min="1" value="1" required></div>
                    <div class="form-group"><label class="form-label">Statut</label><select class="form-select" id="task-status"><option value="planifie">Planifié</option><option value="en-cours">En cours</option><option value="en-retard">En retard</option><option value="termine">Terminé</option><option value="travaux-sup">Travaux sup</option></select></div>
                </div>
                <div class="form-group">
                    <label class="form-label">Progression</label>
                    <div class="range-group">
                        <input type="range" class="range-input" id="task-progress" min="0" max="100" value="0" oninput="updateProgressValue(this.value)">
                        <span class="range-value" id="progress-value">0%</span>
                    </div>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn" id="delete-task-btn" onclick="deleteCurrentTask()" style="display: none; background-color: var(--danger); color: white;">🗑️ Supprimer</button>
                    <button type="button" class="btn" onclick="closeTaskModal()" style="background: var(--gray-300); color: var(--gray-700);">Annuler</button>
                    <button type="submit" class="btn btn-success">💾 Enregistrer</button>
                </div>
            </form>
        </div>
    </div>

    <script src="data_sync.js"></script>
    <script>
        class PlanningBooster {
            constructor() {
                this.tasks = [];
                this.currentChantier = null;
                this.viewMode = 'week';
                this.currentEditingTask = null;
                this.hoursPerDay = 8.5;
                
                this.initData();
                this.populateChantierSelect();
                this.populateResponsableSelect();
                this.renderChantierManagement();
                this.initEventListeners();

                const lastChantier = localStorage.getItem('planningBoosterLastChantier');
                if (lastChantier && this.chantiersData[lastChantier]) {
                    this.currentChantier = lastChantier;
                } else {
                    this.currentChantier = Object.keys(this.chantiersData)[0] || null;
                }
                
                if (this.currentChantier) {
                    document.getElementById('chantierSelect').value = this.currentChantier;
                    this.loadChantier(this.currentChantier);
                } else {
                    this.loadChantier(null);
                }
            }
            
            saveDataToLocalStorage() {
                localStorage.setItem('planningBoosterData', JSON.stringify(this.chantiersData));
                localStorage.setItem('planningBoosterLastChantier', this.currentChantier);
            }

            initData() {
                const savedData = localStorage.getItem('planningBoosterData');
                if (savedData) {
                    this.chantiersData = JSON.parse(savedData);
                    for (const chantier in this.chantiersData) {
                        this.chantiersData[chantier].tasks.forEach(task => {
                            task.dateDebut = new Date(task.dateDebut);
                        });
                    }
                } else {
                    this.chantiersData = {
                        'Grand Lyon – Pont de Chasse': {
                            tasks: [
                                { id: 1, nom: 'Préparation & Installation chantier', responsable: 'FARID MESSAL (Chef de chantier)', dateDebut: new Date('2025-08-21'), heuresHomme: 24, operateurs: 2, duree: 2, progression: 100, statut: 'termine' },
                                { id: 2, nom: 'Sablage surfaces métalliques', responsable: 'A MOHAMED (Chef d\'équipe)', dateDebut: new Date('2025-08-23'), heuresHomme: 68, operateurs: 3, duree: 3, progression: 85, statut: 'en-cours' },
                                { id: 3, nom: 'Application primaire anticorrosion', responsable: 'CLEMENTE MICKAEL (Opérateur)', dateDebut: new Date('2025-08-26'), heuresHomme: 51, operateurs: 2, duree: 3, progression: 60, statut: 'en-cours' },
                                { id: 4, nom: 'Application peinture intermédiaire', responsable: 'ANTUNEZ LOIC (Chef d\'équipe)', dateDebut: new Date('2025-08-29'), heuresHomme: 45, operateurs: 2, duree: 3, progression: 25, statut: 'en-cours' },
                            ],
                            budget: 278
                        },
                        'VICHY': {
                            tasks: [
                                { id: 9, nom: 'Installation du site', responsable: 'A MOHAMED (Chef d\'équipe)', dateDebut: new Date('2025-08-22'), heuresHomme: 20, operateurs: 2, duree: 2, progression: 80, statut: 'en-cours' },
                            ],
                            budget: 160
                        },
                    };
                }
            }
            
            populateResponsableSelect() {
                // Utiliser le système de synchronisation
                const syncData = window.getSyncData ? window.getSyncData() : null;
                const equipeData = syncData ? syncData.team : null;
                const members = equipeData && equipeData.members ? equipeData.members : [];
                const responsables = members.map(m => `${m.name.toUpperCase()} (${m.role})`);
                const select = document.getElementById('task-responsable');
                select.innerHTML = '<option value="">Sélectionner un responsable</option>';
                responsables.forEach(r => {
                    const option = document.createElement('option');
                    option.value = r;
                    option.textContent = r;
                    select.appendChild(option);
                });
            }

            populateChantierSelect() {
                const select = document.getElementById('chantierSelect');
                select.innerHTML = '';
                Object.keys(this.chantiersData).forEach(chantierName => {
                    const option = document.createElement('option');
                    option.value = chantierName;
                    option.textContent = chantierName;
                    select.appendChild(option);
                });
                const autreOption = document.createElement('option');
                autreOption.value = 'autre';
                autreOption.textContent = 'Autre chantier...';
                select.appendChild(autreOption);
            }

            renderChantierManagement() {
                const list = document.getElementById('chantier-management-list');
                list.innerHTML = '';
                Object.keys(this.chantiersData).forEach(name => {
                    const item = document.createElement('div');
                    item.className = 'chantier-management-item';
                    item.innerHTML = `<span>${name}</span><button class="btn-delete-chantier" onclick="planningBooster.deleteChantier('${name}')">Supprimer</button>`;
                    list.appendChild(item);
                });
            }

            deleteChantier(chantierName) {
                if (confirm(`Supprimer le chantier "${chantierName}" et toutes ses tâches ?`)) {
                    delete this.chantiersData[chantierName];
                    if (this.currentChantier === chantierName) {
                        this.currentChantier = Object.keys(this.chantiersData)[0] || null;
                    }
                    this.populateChantierSelect();
                    this.renderChantierManagement();
                    this.loadChantier(this.currentChantier);
                    this.saveDataToLocalStorage();
                }
            }

            initEventListeners() {
                const chantierSelect = document.getElementById('chantierSelect');
                chantierSelect.addEventListener('change', (e) => {
                    if (e.target.value === 'autre') {
                        const newChantierName = prompt("Nom du nouveau chantier :");
                        if (newChantierName && newChantierName.trim() !== '') {
                            if (!this.chantiersData[newChantierName]) {
                                this.chantiersData[newChantierName] = { tasks: [], budget: 100 };
                                this.populateChantierSelect();
                                this.renderChantierManagement();
                            }
                            chantierSelect.value = newChantierName;
                            this.loadChantier(newChantierName);
                        } else {
                            chantierSelect.value = this.currentChantier;
                        }
                    } else {
                        this.loadChantier(e.target.value);
                    }
                });
                
                document.getElementById('budget-heures-input').addEventListener('change', (e) => {
                    const newBudget = parseInt(e.target.value);
                    if (!isNaN(newBudget) && this.currentChantier) {
                        this.chantiersData[this.currentChantier].budget = newBudget;
                        this.updateDashboard();
                        this.saveDataToLocalStorage();
                    }
                });

                document.querySelectorAll('.view-btn').forEach(btn => btn.addEventListener('click', (e) => {
                    document.querySelector('.view-btn.active').classList.remove('active');
                    e.target.classList.add('active');
                    this.viewMode = e.target.id.replace('view', '').toLowerCase();
                    this.renderGantt();
                }));

                document.getElementById('addTaskBtn').addEventListener('click', () => this.openTaskModal());
                document.getElementById('taskForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.saveTask();
                });

                // Écouter les mises à jour d'équipe
                if (window.dataSyncManager) {
                    window.dataSyncManager.subscribe('planning', (teamData) => {
                        this.populateResponsableSelect();
                        console.log('Planning: Données d\'équipe mises à jour');
                    });
                }
            }

            loadChantier(chantierName) {
                if (!chantierName || !this.chantiersData[chantierName]) {
                     this.currentChantier = null;
                     this.tasks = [];
                     document.getElementById('chantier-name').textContent = "Aucun Chantier";
                     document.getElementById('budget-heures-input').value = 0;
                } else {
                    this.currentChantier = chantierName;
                    const data = this.chantiersData[chantierName];
                    this.tasks = data.tasks;
                    document.getElementById('chantier-name').textContent = chantierName;
                    document.getElementById('budget-heures-input').value = data.budget || 0;
                }
                this.renderGantt();
                this.updateDashboard();
                this.updateTimeline();
                this.saveDataToLocalStorage();
            }
            
            renderGantt() {
                const container = document.getElementById('gantt-chart');
                if (!this.tasks || this.tasks.length === 0) {
                    container.innerHTML = `<div style="text-align: center; padding: 3rem; color: var(--gray-700);"><h3>Aucune tâche pour ce chantier</h3><p>Cliquez sur "Nouvelle Tâche" pour commencer.</p></div>`;
                    return;
                }
                this.tasks.sort((a, b) => a.dateDebut - b.dateDebut);
                const minDate = new Date(this.tasks[0].dateDebut);
                minDate.setDate(minDate.getDate() - 3);
                let maxDate = new Date(minDate);
                this.tasks.forEach(task => {
                    const endDate = this.calculateEndDate(task.dateDebut, task.duree);
                    if (endDate > maxDate) maxDate = endDate;
                });
                maxDate.setDate(maxDate.getDate() + 7);

                const headerInfo = this.generateDateHeader(minDate, maxDate);
                const rowsHtml = this.tasks.map(task => this.generateTaskRow(task, minDate, headerInfo.colWidth)).join('');
                container.innerHTML = `<div class="gantt-header"><div class="gantt-task-header">Tâches & Responsables</div><div class="gantt-dates-header">${headerInfo.html}</div></div><div class="gantt-body">${rowsHtml}</div>`;
                document.querySelectorAll('.gantt-chart-cell').forEach(cell => {
                    cell.style.backgroundSize = `${headerInfo.colWidth}px 100%`;
                });
            }
            
            generateDateHeader(minDate, maxDate) {
                let html = '';
                let colWidth = 80;
                let currentDate = new Date(minDate);
                if (this.viewMode === 'week') {
                    colWidth = 100;
                    while (currentDate <= maxDate) {
                        html += `<div class="gantt-date-cell" style="min-width: ${colWidth}px;">Sem. ${this.getWeekNumber(currentDate)}</div>`;
                        currentDate.setDate(currentDate.getDate() + 7);
                    }
                } else if (this.viewMode === 'month') {
                    colWidth = 150;
                     currentDate.setDate(1);
                    while (currentDate <= maxDate) {
                        html += `<div class="gantt-date-cell" style="min-width: ${colWidth}px;">${currentDate.toLocaleDateString('fr-FR', { month: 'long', year: '2-digit' })}</div>`;
                        currentDate.setMonth(currentDate.getMonth() + 1);
                    }
                } else { // Day view
                    while (currentDate <= maxDate) {
                        const isWeekend = currentDate.getDay() === 0 || currentDate.getDay() === 6;
                        html += `<div class="gantt-date-cell ${isWeekend ? 'weekend' : ''}" style="min-width: ${colWidth}px;">${currentDate.toLocaleDateString('fr-FR', { day: '2-digit', month: 'short' })}</div>`;
                        currentDate.setDate(currentDate.getDate() + 1);
                    }
                }
                return { html, colWidth };
            }
            
            generateTaskRow(task, minDate, colWidth) {
                const endDate = this.calculateEndDate(task.dateDebut, task.duree);
                const calendarDuration = Math.max(1, (endDate - task.dateDebut) / (1000 * 60 * 60 * 24));
                let daysFromStart = (task.dateDebut - minDate) / (1000 * 60 * 60 * 24);
                let barLeft, barWidth;
                if (this.viewMode === 'day') {
                    barLeft = daysFromStart * colWidth;
                    barWidth = calendarDuration * colWidth - 2; 
                } else if (this.viewMode === 'week') {
                    barLeft = (daysFromStart / 7) * colWidth;
                    barWidth = (calendarDuration / 7) * colWidth - 2;
                } else {
                    const daysInMonth = 30.44;
                    barLeft = (daysFromStart / daysInMonth) * colWidth;
                    barWidth = (calendarDuration / daysInMonth) * colWidth - 2;
                }
                barWidth = Math.max(barWidth, colWidth / 2);
                const statusLabels = { 'planifie': 'Planifié', 'en-cours': 'En cours', 'en-retard': 'En retard', 'termine': 'Terminé', 'travaux-sup': 'Travaux sup' };
                return `<div class="gantt-row" data-task-id="${task.id}"><div class="gantt-task-cell" onclick="planningBooster.openTaskModal(${task.id})"><div class="gantt-task-name">${task.nom}</div><div class="gantt-task-responsable">${task.responsable}</div><div class="gantt-task-meta"><span>${task.heuresHomme}h</span><span>${task.operateurs} op.</span><span>${statusLabels[task.statut]}</span></div></div><div class="gantt-chart-cell"><div class="gantt-bar gantt-bar-${task.statut}" style="left: ${barLeft}px; width: ${barWidth}px;" onclick="planningBooster.openTaskModal(${task.id})">${task.progression}%<div class="gantt-progress" style="width: ${task.progression}%;"></div></div></div></div>`;
            }
            
            updateDashboard() {
                if (!this.tasks) return;
                const totalHeures = this.tasks.reduce((sum, task) => sum + task.heuresHomme, 0);
                const heuresPassees = this.tasks.reduce((sum, task) => sum + (task.heuresHomme * (task.progression / 100)), 0);
                const tachesTerminees = this.tasks.filter(t => t.progression === 100).length;
                const progressionGlobale = totalHeures > 0 ? (heuresPassees / totalHeures) * 100 : 0;
                const budget = parseInt(document.getElementById('budget-heures-input').value) || 0;
                const budgetProgress = budget > 0 ? (heuresPassees / budget) * 100 : 0;
                
                document.getElementById('heures-passees').textContent = `${Math.round(heuresPassees)}h`;
                document.getElementById('taches-terminees').textContent = `${tachesTerminees}/${this.tasks.length}`;
                document.getElementById('progression-globale').textContent = `${Math.round(progressionGlobale)}%`;
                document.getElementById('progress-percentage').textContent = `${Math.round(progressionGlobale)}%`;
                document.getElementById('budget-progress-bar').style.width = `${Math.min(budgetProgress, 100)}%`;
                document.getElementById('heures-detail').textContent = `${Math.round(heuresPassees)}h / ${budget}h`;
                
                const circle = document.getElementById('progress-circle');
                const circumference = 2 * Math.PI * 50;
                circle.style.strokeDashoffset = circumference - (progressionGlobale / 100) * circumference;

                const firstTaskDate = this.tasks.length > 0 ? this.tasks.reduce((min, task) => task.dateDebut < min ? task.dateDebut : min, this.tasks[0].dateDebut) : new Date();
                const joursEcoules = Math.max(1, Math.ceil((new Date() - firstTaskDate) / (1000 * 60 * 60 * 24)));
                document.getElementById('productivite').textContent = `${(heuresPassees / joursEcoules).toFixed(1)} h/j`;
                
                document.getElementById('statut-projet').textContent = progressionGlobale >= 100 ? 'Terminé' : (progressionGlobale > 0 ? 'En cours' : 'Planifié');
            }

            updateTimeline() {
                const timeline = document.getElementById('timeline');
                if (!this.tasks || this.tasks.length === 0) {
                    timeline.innerHTML = '<p>Aucune tâche à venir.</p>';
                    return;
                }
                const prochainesTaches = this.tasks.filter(t => t.progression < 100).sort((a,b) => a.dateDebut - b.dateDebut).slice(0, 5);
                if (prochainesTaches.length === 0) {
                    timeline.innerHTML = '<p>🎉 Toutes les tâches sont terminées !</p>';
                } else {
                    timeline.innerHTML = prochainesTaches.map(task => `<div class="timeline-item"><div class="timeline-date">${task.dateDebut.toLocaleDateString('fr-FR')}</div><div class="timeline-title">${task.nom}</div><div class="timeline-desc">${task.responsable}</div></div>`).join('');
                }
            }

            openTaskModal(taskId = null) {
                this.currentEditingTask = taskId;
                const modal = document.getElementById('taskModal');
                const isEditing = taskId !== null;
                document.getElementById('modal-title').textContent = isEditing ? '✏️ Modifier la Tâche' : '➕ Nouvelle Tâche';
                document.getElementById('delete-task-btn').style.display = isEditing ? 'inline-flex' : 'none';

                if (isEditing) {
                    const task = this.tasks.find(t => t.id === taskId);
                    document.getElementById('task-name').value = task.nom;
                    document.getElementById('task-responsable').value = task.responsable;
                    document.getElementById('task-start-date').value = task.dateDebut.toISOString().split('T')[0];
                    document.getElementById('task-hours').value = task.heuresHomme;
                    document.getElementById('task-operators').value = task.operateurs;
                    document.getElementById('task-status').value = task.statut;
                    document.getElementById('task-progress').value = task.progression;
                } else {
                    document.getElementById('taskForm').reset();
                    document.getElementById('task-start-date').valueAsDate = new Date();
                }
                updateProgressValue(document.getElementById('task-progress').value);
                modal.style.display = 'flex';
            }

            saveTask() {
                const taskData = {
                    id: this.currentEditingTask || Date.now(),
                    nom: document.getElementById('task-name').value,
                    responsable: document.getElementById('task-responsable').value,
                    dateDebut: new Date(document.getElementById('task-start-date').value),
                    heuresHomme: parseInt(document.getElementById('task-hours').value),
                    operateurs: parseInt(document.getElementById('task-operators').value),
                    progression: parseInt(document.getElementById('task-progress').value),
                    statut: document.getElementById('task-status').value
                };
                taskData.duree = Math.ceil(taskData.heuresHomme / (taskData.operateurs * this.hoursPerDay));

                if (this.currentEditingTask) {
                    const index = this.tasks.findIndex(t => t.id === this.currentEditingTask);
                    this.tasks[index] = taskData;
                } else {
                    this.tasks.push(taskData);
                }
                this.chantiersData[this.currentChantier].tasks = this.tasks;
                this.saveDataToLocalStorage();
                this.renderGantt();
                this.updateDashboard();
                this.updateTimeline();
                this.closeTaskModal();
            }
            
            deleteCurrentTask() {
                if (confirm('Supprimer cette tâche ?')) {
                    this.tasks = this.tasks.filter(t => t.id !== this.currentEditingTask);
                    this.chantiersData[this.currentChantier].tasks = this.tasks;
                    this.saveDataToLocalStorage();
                    this.renderGantt();
                    this.updateDashboard();
                    this.updateTimeline();
                    this.closeTaskModal();
                }
            }
            
            calculateEndDate(startDate, workingDays) {
                let date = new Date(startDate);
                let addedDays = 0;
                while (addedDays < workingDays) {
                    date.setDate(date.getDate() + 1);
                    if (date.getDay() !== 0 && date.getDay() !== 6) { addedDays++; }
                }
                return date;
            }
            
            getWeekNumber(d) {
                d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
                d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay()||7));
                var yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
                return Math.ceil(( ( (d - yearStart) / 86400000) + 1)/7);
            }
            
            closeTaskModal() {
                document.getElementById('taskModal').style.display = 'none';
                this.currentEditingTask = null;
            }
        }
        
        let planningBooster;
        document.addEventListener('DOMContentLoaded', () => {
            planningBooster = new PlanningBooster();
            
            // Écouter les mises à jour des affectations
            window.addEventListener('affectationsUpdated', function(event) {
                console.log('Planning: Affectations mises à jour', event.detail);
                // Mettre à jour l'affichage si nécessaire
                if (planningBooster) {
                    planningBooster.renderTasks();
                }
            });
            
            // Écouter les changements de localStorage pour les affectations
            window.addEventListener('storage', function(e) {
                if (e.key === 'planning_affectations') {
                    console.log('Planning: Données d\'affectations mises à jour via localStorage');
                    if (planningBooster) {
                        planningBooster.renderTasks();
                    }
                }
            });
        });
        function closeTaskModal() { planningBooster.closeTaskModal(); }
        function deleteCurrentTask() { planningBooster.deleteCurrentTask(); }
        function updateProgressValue(value) { document.getElementById('progress-value').textContent = `${value}%`; }
        
        // Fonction pour imprimer le tableau de planning
        function printPlanningTable() {
            const currentChantier = planningBooster.currentChantier;
            const tasks = planningBooster.tasks;
            
            if (!tasks || tasks.length === 0) {
                alert('Aucune tâche à imprimer pour ce chantier.');
                return;
            }
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html lang="fr">
                <head>
                    <meta charset="UTF-8">
                    <meta name="viewport" content="width=device-width, initial-scale=1.0">
                    <title>Planning - ${currentChantier}</title>
                    <style>
                        @page {
                            size: A4 landscape;
                            margin: 1cm;
                        }
                        
                        body {
                            font-family: Arial, sans-serif;
                            font-size: 10px;
                            line-height: 1.3;
                            color: black;
                            background: white;
                            margin: 0;
                            padding: 0;
                        }
                        
                        .header {
                            text-align: center;
                            font-size: 18px;
                            font-weight: bold;
                            color: #dc2626;
                            border-bottom: 2px solid #dc2626;
                            padding-bottom: 10px;
                            margin-bottom: 20px;
                        }
                        
                        .planning-table {
                            width: 100%;
                            border-collapse: collapse;
                            font-size: 9px;
                            page-break-inside: avoid;
                        }
                        
                        .planning-table th {
                            background: #dc2626;
                            color: white;
                            padding: 8px 4px;
                            border: 1px solid black;
                            font-weight: bold;
                            text-align: center;
                        }
                        
                        .planning-table td {
                            padding: 6px 4px;
                            border: 1px solid black;
                            text-align: center;
                            vertical-align: middle;
                        }
                        
                        .planning-table tr:nth-child(even) {
                            background: #f9f9f9;
                        }
                        
                        .status-planifie { background: #e3f2fd; }
                        .status-en-cours { background: #fff3e0; }
                        .status-en-retard { background: #ffebee; }
                        .status-termine { background: #e8f5e8; }
                        .status-travaux-sup { background: #f3e5f5; }
                        
                        .progress-bar {
                            width: 100%;
                            height: 16px;
                            background: #e0e0e0;
                            border-radius: 8px;
                            overflow: hidden;
                            position: relative;
                        }
                        
                        .progress-fill {
                            height: 100%;
                            background: linear-gradient(90deg, #dc2626, #ea580c);
                            transition: width 0.3s ease;
                        }
                        
                        .progress-text {
                            position: absolute;
                            top: 50%;
                            left: 50%;
                            transform: translate(-50%, -50%);
                            font-size: 8px;
                            font-weight: bold;
                            color: #333;
                        }
                        
                        @media print {
                            body { -webkit-print-color-adjust: exact; }
                        }
                    </style>
                </head>
                <body>
                    <div class="header">
                        📊 PLANNING DES TÂCHES - ${currentChantier}
                    </div>
                    
                    <table class="planning-table">
                        <thead>
                            <tr>
                                <th style="width: 5%;">N°</th>
                                <th style="width: 25%;">Tâche</th>
                                <th style="width: 12%;">Responsable</th>
                                <th style="width: 10%;">Date Début</th>
                                <th style="width: 8%;">Durée (j)</th>
                                <th style="width: 8%;">H-H</th>
                                <th style="width: 8%;">Opérateurs</th>
                                <th style="width: 8%;">Statut</th>
                                <th style="width: 16%;">Progression</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${tasks.map((task, index) => {
                                const dateDebut = new Date(task.dateDebut).toLocaleDateString('fr-FR');
                                const duree = Math.ceil(task.heuresHomme / (task.operateurs * 8.5));
                                const statutText = {
                                    'planifie': 'Planifié',
                                    'en-cours': 'En cours',
                                    'en-retard': 'En retard',
                                    'termine': 'Terminé',
                                    'travaux-sup': 'Travaux sup'
                                }[task.statut] || task.statut;
                                
                                return `
                                    <tr class="status-${task.statut}">
                                        <td>${index + 1}</td>
                                        <td style="text-align: left; font-weight: bold;">${task.nom}</td>
                                        <td>${task.responsable}</td>
                                        <td>${dateDebut}</td>
                                        <td>${duree}</td>
                                        <td>${task.heuresHomme}h</td>
                                        <td>${task.operateurs}</td>
                                        <td>${statutText}</td>
                                        <td>
                                            <div class="progress-bar">
                                                <div class="progress-fill" style="width: ${task.progression}%;"></div>
                                                <div class="progress-text">${task.progression}%</div>
                                            </div>
                                        </td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </body>
                </html>
            `);
            
            printWindow.document.close();
            printWindow.focus();
            
            setTimeout(() => {
                printWindow.print();
                printWindow.close();
            }, 500);
        }
        
        document.addEventListener('click', (e) => { if (e.target.classList.contains('modal')) { closeTaskModal(); } });
    </script>
</body>
</html>